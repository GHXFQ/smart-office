(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2f1268ca","chunk-2d0e4842"],{"048c":function(e,t,a){},"7b3c":function(e,t,a){"use strict";a.r(t);a("14d9"),a("e9f5"),a("910d"),a("f665"),a("7d54"),a("ab43");var l=a("7a23"),c=a("6605"),o=a("5502"),r=a("f6f2"),n=a("c9a1"),d=a("3ef4"),s=a("b775");const i={class:"container-fluid"},u={class:"row"},b={class:"card"},m={class:"card-header"},j={key:0},p={class:"header-actions"},v={class:"card-body p-0"},O={key:0,class:"empty-state-nav"},f={key:1,class:"project-nav"},h=["onClick","title"],V={class:"project-name"},g={class:"card"},N={class:"card-header"},y={class:"search-box"},C={class:"card-body"},k={key:0,class:"empty-state"},E={key:1,class:"row"},w={class:"project-card"},x={class:"project-card-header"},B={class:"project-card-body"},_={class:"project-card-stats"},S={class:"stat-item"},D={class:"stat-item"},T={class:"project-card-footer"},z={key:2,class:"pagination-container"};var I={__name:"Index",setup(e){const t=Object(c["d"])(),a=Object(o["b"])(),I=Object(l["ref"])(""),q=Object(l["ref"])([]),$=Object(l["ref"])(0),A=Object(l["ref"])(!1),F=Object(l["ref"])({name:"",desc:"",start:"",end:"",members:[]}),U=Object(l["ref"])([]),M=Object(l["ref"])(!1),L=Object(l["ref"])(1),P=Object(l["ref"])(10),R=Object(l["ref"])(0),J=Object(l["ref"])(null),Y={name:[{required:!0,message:"请输入项目名称",trigger:"blur"}],desc:[{required:!0,message:"请输入项目描述",trigger:"blur"}],start:[{required:!0,message:"请选择开始日期",trigger:"change"}],end:[{required:!0,message:"请选择结束日期",trigger:"change"}],members:[{required:!0,message:"请选择项目成员",trigger:"change"}]};function G(){console.log("fetchProjects: 开始请求项目列表"),s["a"].get("/api/projects/",{params:{page:L.value,page_size:P.value}}).then(e=>{console.log("fetchProjects: 获取成功",e.data),e.data&&Array.isArray(e.data.results)?(q.value=e.data.results||[],R.value=e.data.count||0):(q.value=e.data||[],R.value=q.value.length),q.value.forEach(e=>{"doing"===e.status?(e.statusText="进行中",e.statusClass="bg-primary text-white"):"done"===e.status?(e.statusText="已完成",e.statusClass="bg-success text-white"):(e.statusText=e.status||"未知",e.statusClass="bg-secondary text-white")})}).catch(e=>{var t,a,l;console.error("fetchProjects: 请求失败",(null===e||void 0===e||null===(t=e.response)||void 0===t?void 0:t.data)||e),alert("获取项目列表失败: "+((null===e||void 0===e||null===(a=e.response)||void 0===a||null===(l=a.data)||void 0===l?void 0:l.detail)||"请检查权限或网络连接"))})}function H(e){return e?"number"===typeof e.company_id?e.company_id:"number"===typeof e.company?e.company:isNaN(e.company_id)?isNaN(e.company)?null:Number(e.company):Number(e.company_id):null}function K(e){if(e=Number(e),!e||isNaN(e))return void console.warn("fetchMembers: companyId无效",e);const t=localStorage.getItem("token");if(!t)return alert("未检测到登录凭证，请重新登录！"),void(U.value=[]);console.log("fetchMembers: companyId=",e,"token=",t),s["a"].get(`/api/auth/companies/${e}/users/`).then(e=>{let t=[];Array.isArray(e.data)?t=e.data:e.data&&Array.isArray(e.data.data)?t=e.data.data:console.error("fetchMembers: 返回数据不是数组",e.data),U.value=t.map(e=>({value:e.id,label:e.name||e.username}))}).catch(e=>{var t,a;403===(null===e||void 0===e||null===(t=e.response)||void 0===t?void 0:t.status)?alert("无权限访问公司成员接口，请重新登录或联系管理员！"):alert("获取公司成员失败，请检查网络或联系管理员！"),console.error("fetchMembers: 请求出错",e,null===e||void 0===e||null===(a=e.response)||void 0===a?void 0:a.data),U.value=[]})}function Q(){const e=a.getters.user;if(!e)return console.warn("未找到用户信息"),null;const t=H(e);return t||(console.warn("用户未关联公司"),null)}Object(l["onMounted"])(()=>{console.log("项目页面挂载");const e=localStorage.getItem("token"),a=localStorage.getItem("user");if(!e)return console.warn("未找到token，请确保已登录"),void t.push("/login");if(a)try{const e=JSON.parse(a);console.log("当前用户信息:",e),console.log("用户公司ID:",H(e));const t=Q();t||alert("您未关联到任何公司，无法访问项目管理页面")}catch(l){console.error("解析用户信息失败",l)}G()});const W=Object(l["computed"])(()=>{if(!I.value)return q.value;const e=I.value.toLowerCase();return q.value.filter(t=>t.name&&t.name.toLowerCase().includes(e)||t.desc&&t.desc.toLowerCase().includes(e))});function X(e){if(!e)return"未设置";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function Z(e){$.value=e}function ee(e){t.push({name:"ProjectDetail",params:{id:e}})}function te(e,t){if("edit"===e){const e=q.value.find(e=>e.id===t);e&&(F.value={...e},A.value=!0,K(e.company))}else"delete"===e&&n["a"].confirm("确定要删除该项目吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{s["a"].delete(`/api/projects/${t}/`).then(()=>{G()})}).catch(()=>{})}function ae(){J.value?J.value.validate(e=>{if(!e)return void d["a"].error("请填写所有必填项");if(F.value.start&&F.value.end&&new Date(F.value.start)>new Date(F.value.end))return void d["a"].error("项目开始时间不能大于结束时间");const t=a.getters.user,l=H(t);if(!l)return void alert("您没有关联到任何公司，无法创建项目");function c(e){if(!e)return null;if("string"===typeof e&&/^\d{4}-\d{2}-\d{2}$/.test(e))return e;const t=new Date(e);return isNaN(t)?null:`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}const o={...F.value,company_id:l,start:c(F.value.start),end:c(F.value.end)};delete o.company,delete o.companyId,console.log("准备保存的项目数据:",o),F.value.id?s["a"].put(`/api/projects/${F.value.id}/`,o).then(e=>{console.log("项目更新成功:",e.data),A.value=!1,G()}).catch(e=>{var t,a,l;console.error("编辑项目失败",(null===e||void 0===e||null===(t=e.response)||void 0===t?void 0:t.data)||e),alert("编辑项目失败: "+((null===e||void 0===e||null===(a=e.response)||void 0===a||null===(l=a.data)||void 0===l?void 0:l.detail)||"请检查权限或网络连接"))}):s["a"].post("/api/projects/",o).then(e=>{console.log("项目创建成功:",e.data),A.value=!1,G()}).catch(e=>{var t,a,l;console.error("创建项目失败",(null===e||void 0===e||null===(t=e.response)||void 0===t?void 0:t.data)||e),alert("创建项目失败: "+((null===e||void 0===e||null===(a=e.response)||void 0===a||null===(l=a.data)||void 0===l?void 0:l.detail)||"请检查权限或网络连接"))}),F.value={name:"",desc:"",start:"",end:"",members:[]}}):console.error("表单引用不存在")}function le(e){L.value=e,G()}return Object(l["watch"])(A,e=>{if(e){const e=a.getters.user,t=H(e);t&&K(t),F.value.id&&Array.isArray(F.value.members)?F.value.members=[...F.value.members]:F.value.members=[]}}),(e,t)=>{const a=Object(l["resolveComponent"])("el-icon"),c=Object(l["resolveComponent"])("el-input"),o=Object(l["resolveComponent"])("el-button"),n=Object(l["resolveComponent"])("el-dropdown-item"),d=Object(l["resolveComponent"])("el-dropdown-menu"),s=Object(l["resolveComponent"])("el-dropdown"),G=Object(l["resolveComponent"])("el-pagination"),H=Object(l["resolveComponent"])("el-form-item"),K=Object(l["resolveComponent"])("el-date-picker"),Q=Object(l["resolveComponent"])("el-option"),ce=Object(l["resolveComponent"])("el-select"),oe=Object(l["resolveComponent"])("el-form"),re=Object(l["resolveComponent"])("el-dialog");return Object(l["openBlock"])(),Object(l["createElementBlock"])("div",i,[Object(l["createElementVNode"])("div",u,[Object(l["createElementVNode"])("div",{class:Object(l["normalizeClass"])(["project-sidebar",M.value?"collapsed":""])},[Object(l["createElementVNode"])("div",b,[Object(l["createElementVNode"])("div",m,[M.value?Object(l["createCommentVNode"])("",!0):(Object(l["openBlock"])(),Object(l["createElementBlock"])("span",j,"我的项目")),Object(l["createElementVNode"])("div",p,[M.value?Object(l["createCommentVNode"])("",!0):(Object(l["openBlock"])(),Object(l["createElementBlock"])("button",{key:0,class:"btn btn-sm btn-primary",onClick:t[0]||(t[0]=e=>A.value=!0)},t[10]||(t[10]=[Object(l["createElementVNode"])("i",{class:"bi bi-plus"},null,-1),Object(l["createTextVNode"])(" 新建 ")]))),Object(l["createElementVNode"])("button",{class:"btn btn-sm btn-icon",onClick:t[1]||(t[1]=e=>M.value=!M.value)},[Object(l["createElementVNode"])("i",{class:Object(l["normalizeClass"])(["bi",M.value?"bi-chevron-double-right":"bi-chevron-double-left"])},null,2)])])]),Object(l["createElementVNode"])("div",v,[0===W.value.length?(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",O,[Object(l["createVNode"])(a,{style:{"font-size":"40px",color:"#d3d3d3","margin-bottom":"10px"}},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(Object(l["unref"])(r["FolderOpened"]))]),_:1}),t[11]||(t[11]=Object(l["createElementVNode"])("div",{class:"empty-title-nav"},"暂无项目",-1))])):(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",f,[(Object(l["openBlock"])(!0),Object(l["createElementBlock"])(l["Fragment"],null,Object(l["renderList"])(q.value,(e,a)=>(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",{key:e.id,class:Object(l["normalizeClass"])(["project-item",{active:a===$.value}]),onClick:e=>Z(a),title:e.name},[t[12]||(t[12]=Object(l["createElementVNode"])("i",{class:"bi bi-kanban"},null,-1)),Object(l["createElementVNode"])("span",V,Object(l["toDisplayString"])(e.name),1),Object(l["createElementVNode"])("span",{class:Object(l["normalizeClass"])(["badge",e.statusClass])},Object(l["toDisplayString"])(e.statusText),3)],10,h))),128))]))])])],2),Object(l["createElementVNode"])("div",{class:Object(l["normalizeClass"])(["project-main-content",M.value?"expanded":""])},[Object(l["createElementVNode"])("div",g,[Object(l["createElementVNode"])("div",N,[t[13]||(t[13]=Object(l["createElementVNode"])("span",null,"项目列表",-1)),Object(l["createElementVNode"])("div",y,[Object(l["createVNode"])(c,{modelValue:I.value,"onUpdate:modelValue":t[2]||(t[2]=e=>I.value=e),placeholder:"搜索项目...","prefix-icon":"Search",clearable:""},null,8,["modelValue"])])]),Object(l["createElementVNode"])("div",C,[0===W.value.length?(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",k,[Object(l["createVNode"])(a,{style:{"font-size":"120px",color:"#d3d3d3","margin-bottom":"16px"}},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(Object(l["unref"])(r["FolderOpened"]))]),_:1}),t[14]||(t[14]=Object(l["createElementVNode"])("div",{class:"empty-title"},"暂无项目",-1)),t[15]||(t[15]=Object(l["createElementVNode"])("div",{class:"empty-desc"},'您还没有任何项目，点击右上角"新建"按钮添加您的第一个项目吧！',-1))])):(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",E,[(Object(l["openBlock"])(!0),Object(l["createElementBlock"])(l["Fragment"],null,Object(l["renderList"])(W.value,e=>(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",{key:e.id,class:"col-md-6 mb-4"},[Object(l["createElementVNode"])("div",w,[Object(l["createElementVNode"])("div",x,[Object(l["createElementVNode"])("h5",null,Object(l["toDisplayString"])(e.name),1),Object(l["createElementVNode"])("span",{class:Object(l["normalizeClass"])(["badge",e.statusClass])},Object(l["toDisplayString"])(e.statusText),3)]),Object(l["createElementVNode"])("div",B,[Object(l["createElementVNode"])("p",null,Object(l["toDisplayString"])(e.desc||"暂无描述"),1),Object(l["createElementVNode"])("div",_,[Object(l["createElementVNode"])("div",S,[t[16]||(t[16]=Object(l["createElementVNode"])("i",{class:"bi bi-calendar"},null,-1)),Object(l["createElementVNode"])("span",null,Object(l["toDisplayString"])(e.start?X(e.start):"未设置"),1)]),Object(l["createElementVNode"])("div",D,[t[17]||(t[17]=Object(l["createElementVNode"])("i",{class:"bi bi-people"},null,-1)),Object(l["createElementVNode"])("span",null,Object(l["toDisplayString"])(e.members?e.members.length:0)+"人",1)])])]),Object(l["createElementVNode"])("div",T,[Object(l["createVNode"])(o,{type:"primary",size:"small",onClick:t=>ee(e.id)},{default:Object(l["withCtx"])(()=>t[18]||(t[18]=[Object(l["createTextVNode"])("查看详情")])),_:2},1032,["onClick"]),Object(l["createVNode"])(s,{onCommand:t=>te(t,e.id),trigger:"click"},{dropdown:Object(l["withCtx"])(()=>[Object(l["createVNode"])(d,null,{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(n,{command:"edit"},{default:Object(l["withCtx"])(()=>t[20]||(t[20]=[Object(l["createTextVNode"])("编辑项目")])),_:1}),Object(l["createVNode"])(n,{command:"delete",divided:""},{default:Object(l["withCtx"])(()=>t[21]||(t[21]=[Object(l["createTextVNode"])("删除项目")])),_:1})]),_:1})]),default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(o,{size:"small",plain:""},{default:Object(l["withCtx"])(()=>t[19]||(t[19]=[Object(l["createElementVNode"])("i",{class:"bi bi-three-dots"},null,-1)])),_:1})]),_:2},1032,["onCommand"])])])]))),128))])),R.value>0?(Object(l["openBlock"])(),Object(l["createElementBlock"])("div",z,[Object(l["createVNode"])(G,{background:"",layout:"prev, pager, next",total:R.value,"page-size":P.value,"current-page":L.value,onCurrentChange:le},null,8,["total","page-size","current-page"])])):Object(l["createCommentVNode"])("",!0)])])],2)]),Object(l["createVNode"])(re,{modelValue:A.value,"onUpdate:modelValue":t[9]||(t[9]=e=>A.value=e),title:F.value.id?"编辑项目":"新建项目",width:"500px"},{footer:Object(l["withCtx"])(()=>[Object(l["createVNode"])(o,{onClick:t[8]||(t[8]=e=>A.value=!1)},{default:Object(l["withCtx"])(()=>t[22]||(t[22]=[Object(l["createTextVNode"])("取消")])),_:1}),Object(l["createVNode"])(o,{type:"primary",onClick:ae},{default:Object(l["withCtx"])(()=>[Object(l["createTextVNode"])(Object(l["toDisplayString"])(F.value.id?"保存":"创建"),1)]),_:1})]),default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(oe,{model:F.value,"label-width":"80px",rules:Y,ref_key:"projectFormRef",ref:J},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(H,{label:"项目名称",prop:"name",required:""},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(c,{modelValue:F.value.name,"onUpdate:modelValue":t[3]||(t[3]=e=>F.value.name=e),placeholder:"请输入项目名称"},null,8,["modelValue"])]),_:1}),Object(l["createVNode"])(H,{label:"项目描述",prop:"desc",required:""},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(c,{modelValue:F.value.desc,"onUpdate:modelValue":t[4]||(t[4]=e=>F.value.desc=e),type:"textarea",placeholder:"请输入项目描述"},null,8,["modelValue"])]),_:1}),Object(l["createVNode"])(H,{label:"开始日期",prop:"start",required:""},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(K,{modelValue:F.value.start,"onUpdate:modelValue":t[5]||(t[5]=e=>F.value.start=e),placeholder:"请选择开始日期"},null,8,["modelValue"])]),_:1}),Object(l["createVNode"])(H,{label:"结束日期",prop:"end",required:""},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(K,{modelValue:F.value.end,"onUpdate:modelValue":t[6]||(t[6]=e=>F.value.end=e),placeholder:"请选择结束日期"},null,8,["modelValue"])]),_:1}),Object(l["createVNode"])(H,{label:"项目成员",prop:"members",required:""},{default:Object(l["withCtx"])(()=>[Object(l["createVNode"])(ce,{modelValue:F.value.members,"onUpdate:modelValue":t[7]||(t[7]=e=>F.value.members=e),multiple:"",placeholder:"请选择项目成员"},{default:Object(l["withCtx"])(()=>[(Object(l["openBlock"])(!0),Object(l["createElementBlock"])(l["Fragment"],null,Object(l["renderList"])(U.value,e=>(Object(l["openBlock"])(),Object(l["createBlock"])(Q,{key:e.value,label:e.label,value:e.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},q=(a("ad8e"),a("6b0d")),$=a.n(q);const A=$()(I,[["__scopeId","data-v-3167b32f"]]);t["default"]=A},"910d":function(e,t,a){"use strict";var l=a("23e7"),c=a("c65b"),o=a("59ed"),r=a("825a"),n=a("46c4"),d=a("c5cc"),s=a("9bdd"),i=a("c430"),u=a("2a62"),b=a("f99f"),m=!i&&b("filter",TypeError),j=d((function(){var e,t,a,l=this.iterator,o=this.predicate,n=this.next;while(1){if(e=r(c(n,l)),t=this.done=!!e.done,t)return;if(a=e.value,s(l,o,[a,this.counter++],!0))return a}}));l({target:"Iterator",proto:!0,real:!0,forced:i||m},{filter:function(e){r(this);try{o(e)}catch(t){u(this,"throw",t)}return m?c(m,this,e):new j(n(this),{predicate:e})}})},ad8e:function(e,t,a){"use strict";a("048c")},f665:function(e,t,a){"use strict";var l=a("23e7"),c=a("c65b"),o=a("2266"),r=a("59ed"),n=a("825a"),d=a("46c4"),s=a("2a62"),i=a("f99f"),u=i("find",TypeError);l({target:"Iterator",proto:!0,real:!0,forced:u},{find:function(e){n(this);try{r(e)}catch(l){s(this,"throw",l)}if(u)return c(u,this,e);var t=d(this),a=0;return o(t,(function(t,l){if(e(t,a++))return l(t)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})}}]);
//# sourceMappingURL=chunk-2f1268ca.8b0bb7d4.js.map