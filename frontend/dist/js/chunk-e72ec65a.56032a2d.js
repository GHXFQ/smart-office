(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-e72ec65a","chunk-2d0e4842"],{"1d0c":function(e,t,a){"use strict";a.r(t);var c=a("7a23");const o={class:"contact-container"},r={class:"contact-wrapper"},n={class:"contact-sidebar"},l={class:"search-box"},s={class:"contacts-nav"},i=["onClick"],d={class:"contact-list"},b={class:"card-header-flex"},u={class:"header-title"},p={class:"contact-count"},m={class:"contacts-list"},j={key:0,class:"search-info"},O={key:1,class:"search-info"},v=["onClick"],h={key:0,class:"contact-avatar",style:{"background-color":"transparent"}},g=["src"],f={class:"contact-info"},N={class:"contact-name"},V={class:"contact-position"},y={class:"contact-detail"},E={class:"contact-header"},C={key:0,class:"detail-avatar",style:{"background-color":"transparent"}},_=["src"],k={class:"detail-info"},w={class:"detail-name"},B={class:"detail-position"},D={class:"detail-department"},A={class:"contact-actions"},S={class:"contact-sections"},I={class:"contact-section"},x={class:"section-title"},P={class:"contact-grid"},U={class:"contact-item-box"},T={class:"contact-item-icon"},$={class:"contact-item-content"},F={class:"contact-item-value"},z={class:"contact-item-box"},R={class:"contact-item-icon"},L={class:"contact-item-content"},M={class:"contact-item-value"},W={class:"contact-section"},H={class:"section-title"},q={class:"contact-grid"},Q={class:"contact-item-box"},J={class:"contact-item-icon"},G={class:"contact-item-content"},K={class:"contact-item-value"},X={class:"contact-item-box"},Y={class:"contact-item-icon"},Z={class:"contact-item-content"},ee={class:"contact-item-value"},te={class:"contact-item-box"},ae={class:"contact-item-icon"},ce={class:"contact-item-content"},oe={class:"contact-item-value"},re={class:"contact-item-box"},ne={class:"contact-item-icon"},le={class:"contact-item-content"},se={class:"contact-item-value"},ie={key:0,class:"contact-section"},de={class:"section-title"},be={class:"skills-tags"},ue={key:1,class:"contact-section"},pe={class:"section-title"};function me(e,t,a,me,je,Oe){const ve=Object(c["resolveComponent"])("el-input"),he=Object(c["resolveComponent"])("el-icon"),ge=Object(c["resolveComponent"])("el-badge"),fe=Object(c["resolveComponent"])("el-card"),Ne=Object(c["resolveComponent"])("InfoFilled"),Ve=Object(c["resolveComponent"])("el-empty"),ye=Object(c["resolveComponent"])("ChatDotRound"),Ee=Object(c["resolveComponent"])("el-button"),Ce=Object(c["resolveComponent"])("el-divider"),_e=Object(c["resolveComponent"])("Promotion"),ke=Object(c["resolveComponent"])("Iphone"),we=Object(c["resolveComponent"])("Location"),Be=Object(c["resolveComponent"])("User"),De=Object(c["resolveComponent"])("Ticket"),Ae=Object(c["resolveComponent"])("Calendar"),Se=Object(c["resolveComponent"])("Present"),Ie=Object(c["resolveComponent"])("UserFilled"),xe=Object(c["resolveComponent"])("Medal"),Pe=Object(c["resolveComponent"])("el-tag"),Ue=Object(c["resolveComponent"])("SetUp"),Te=Object(c["resolveComponent"])("el-table-column"),$e=Object(c["resolveComponent"])("el-table"),Fe=Object(c["resolveDirective"])("loading");return Object(c["openBlock"])(),Object(c["createElementBlock"])("div",o,[Object(c["createElementVNode"])("div",r,[Object(c["createElementVNode"])("div",n,[Object(c["withDirectives"])((Object(c["openBlock"])(),Object(c["createBlock"])(fe,{class:"contacts-nav-card",shadow:"hover"},{default:Object(c["withCtx"])(()=>[Object(c["createElementVNode"])("div",l,[Object(c["createVNode"])(ve,{modelValue:me.searchQuery,"onUpdate:modelValue":t[0]||(t[0]=e=>me.searchQuery=e),placeholder:"搜索联系人...",clearable:"","prefix-icon":"Search"},null,8,["modelValue"])]),Object(c["createElementVNode"])("div",s,[(Object(c["openBlock"])(!0),Object(c["createElementBlock"])(c["Fragment"],null,Object(c["renderList"])(me.departments,(e,t)=>(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",{key:e.id,class:Object(c["normalizeClass"])(["dept-item",{active:me.selectedDept===t}]),onClick:e=>me.selectedDept=t},[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[(Object(c["openBlock"])(),Object(c["createBlock"])(Object(c["resolveDynamicComponent"])(me.getDeptIcon(e.icon))))]),_:2},1024),Object(c["createElementVNode"])("span",null,Object(c["toDisplayString"])(e.name),1),Object(c["createVNode"])(ge,{value:e.count||0,type:"info",class:"dept-badge"},null,8,["value"])],10,i))),128))])]),_:1})),[[Fe,me.loading.departments]])]),Object(c["createElementVNode"])("div",d,[Object(c["withDirectives"])((Object(c["openBlock"])(),Object(c["createBlock"])(fe,{class:"contacts-list-card",shadow:"hover"},{header:Object(c["withCtx"])(()=>{var e;return[Object(c["createElementVNode"])("div",b,[Object(c["createElementVNode"])("span",u,Object(c["toDisplayString"])(me.searchQuery?"搜索结果":null===(e=me.departments[me.selectedDept])||void 0===e?void 0:e.name),1),Object(c["createElementVNode"])("span",p,Object(c["toDisplayString"])(me.contacts.length)+"人",1)])]}),default:Object(c["withCtx"])(()=>[Object(c["createElementVNode"])("div",m,[me.searchQuery?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",j,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Ne)]),_:1}),t[2]||(t[2]=Object(c["createElementVNode"])("span",null,"搜索范围：全公司联系人",-1))])):0===me.selectedDept?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",O,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Ne)]),_:1}),t[3]||(t[3]=Object(c["createElementVNode"])("span",null,"显示全部公司联系人",-1))])):Object(c["createCommentVNode"])("",!0),(Object(c["openBlock"])(!0),Object(c["createElementBlock"])(c["Fragment"],null,Object(c["renderList"])(me.contacts,(e,t)=>(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",{key:e.id,class:Object(c["normalizeClass"])(["contact-item",{active:me.selectedContact===t}]),onClick:e=>me.selectedContact=t},[e.avatar_url?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",h,[Object(c["createElementVNode"])("img",{src:e.avatar_url,alt:"头像",class:"avatar-img"},null,8,g)])):(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",{key:1,class:"contact-avatar",style:Object(c["normalizeStyle"])(me.getAvatarStyle(e))},Object(c["toDisplayString"])(me.getInitials(e.name)),5)),Object(c["createElementVNode"])("div",f,[Object(c["createElementVNode"])("div",N,Object(c["toDisplayString"])(e.name),1),Object(c["createElementVNode"])("div",V,Object(c["toDisplayString"])(e.position)+" · "+Object(c["toDisplayString"])(e.department_name||"未分配部门"),1)])],10,v))),128)),0===me.contacts.length?(Object(c["openBlock"])(),Object(c["createBlock"])(Ve,{key:2,description:"暂无联系人数据"})):Object(c["createCommentVNode"])("",!0)])]),_:1})),[[Fe,me.loading.contacts]])]),Object(c["createElementVNode"])("div",y,[null!==me.selectedContact&&me.contacts[me.selectedContact]?(Object(c["openBlock"])(),Object(c["createBlock"])(fe,{key:0,class:"contact-detail-card",shadow:"hover"},{default:Object(c["withCtx"])(()=>[Object(c["createElementVNode"])("div",E,[me.contacts[me.selectedContact].avatar_url?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",C,[Object(c["createElementVNode"])("img",{src:me.contacts[me.selectedContact].avatar_url,alt:"头像",class:"avatar-img"},null,8,_)])):(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",{key:1,class:"detail-avatar",style:Object(c["normalizeStyle"])(me.getAvatarStyle(me.contacts[me.selectedContact]))},Object(c["toDisplayString"])(me.getInitials(me.contacts[me.selectedContact].name)),5)),Object(c["createElementVNode"])("div",k,[Object(c["createElementVNode"])("div",w,Object(c["toDisplayString"])(me.contacts[me.selectedContact].name),1),Object(c["createElementVNode"])("div",B,Object(c["toDisplayString"])(me.contacts[me.selectedContact].position),1),Object(c["createElementVNode"])("div",D,Object(c["toDisplayString"])(me.contacts[me.selectedContact].department_name||"未分配部门"),1),Object(c["createElementVNode"])("div",A,[Object(c["createVNode"])(Ee,{type:"primary",size:"small",onClick:t[1]||(t[1]=e=>me.startChat(me.contacts[me.selectedContact]))},{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(ye)]),_:1}),t[4]||(t[4]=Object(c["createTextVNode"])(" 发送消息 "))]),_:1})])])]),Object(c["createVNode"])(Ce),Object(c["createElementVNode"])("div",S,[Object(c["createElementVNode"])("div",I,[Object(c["createElementVNode"])("div",x,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(_e)]),_:1}),t[5]||(t[5]=Object(c["createTextVNode"])(" 联系方式 "))]),Object(c["createElementVNode"])("div",P,[Object(c["createElementVNode"])("div",U,[Object(c["createElementVNode"])("div",T,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(ke)]),_:1})]),Object(c["createElementVNode"])("div",$,[t[6]||(t[6]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"手机号码",-1)),Object(c["createElementVNode"])("div",F,Object(c["toDisplayString"])(me.contacts[me.selectedContact].mobile||"暂无"),1)])]),Object(c["createElementVNode"])("div",z,[Object(c["createElementVNode"])("div",R,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(we)]),_:1})]),Object(c["createElementVNode"])("div",L,[t[7]||(t[7]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"办公地点",-1)),Object(c["createElementVNode"])("div",M,Object(c["toDisplayString"])(me.contacts[me.selectedContact].office||"暂无"),1)])])])]),Object(c["createElementVNode"])("div",W,[Object(c["createElementVNode"])("div",H,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Be)]),_:1}),t[8]||(t[8]=Object(c["createTextVNode"])(" 个人信息 "))]),Object(c["createElementVNode"])("div",q,[Object(c["createElementVNode"])("div",Q,[Object(c["createElementVNode"])("div",J,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(De)]),_:1})]),Object(c["createElementVNode"])("div",G,[t[9]||(t[9]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"员工编号",-1)),Object(c["createElementVNode"])("div",K,Object(c["toDisplayString"])(me.contacts[me.selectedContact].employee_id||"暂无"),1)])]),Object(c["createElementVNode"])("div",X,[Object(c["createElementVNode"])("div",Y,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Ae)]),_:1})]),Object(c["createElementVNode"])("div",Z,[t[10]||(t[10]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"入职日期",-1)),Object(c["createElementVNode"])("div",ee,Object(c["toDisplayString"])(me.contacts[me.selectedContact].join_date||"暂无"),1)])]),Object(c["createElementVNode"])("div",te,[Object(c["createElementVNode"])("div",ae,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Se)]),_:1})]),Object(c["createElementVNode"])("div",ce,[t[11]||(t[11]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"出生日期",-1)),Object(c["createElementVNode"])("div",oe,Object(c["toDisplayString"])(me.contacts[me.selectedContact].birthday||"暂无"),1)])]),Object(c["createElementVNode"])("div",re,[Object(c["createElementVNode"])("div",ne,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Ie)]),_:1})]),Object(c["createElementVNode"])("div",le,[t[12]||(t[12]=Object(c["createElementVNode"])("div",{class:"contact-item-label"},"直系领导",-1)),Object(c["createElementVNode"])("div",se,Object(c["toDisplayString"])(me.contacts[me.selectedContact].manager||"暂无"),1)])])])]),me.contacts[me.selectedContact].skills&&me.contacts[me.selectedContact].skills.length>0?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",ie,[Object(c["createElementVNode"])("div",de,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(xe)]),_:1}),t[13]||(t[13]=Object(c["createTextVNode"])(" 技能专长 "))]),Object(c["createElementVNode"])("div",be,[(Object(c["openBlock"])(!0),Object(c["createElementBlock"])(c["Fragment"],null,Object(c["renderList"])(me.contacts[me.selectedContact].skills,(e,t)=>(Object(c["openBlock"])(),Object(c["createBlock"])(Pe,{key:t,class:"skill-tag",effect:"light",round:""},{default:Object(c["withCtx"])(()=>[Object(c["createTextVNode"])(Object(c["toDisplayString"])(e),1)]),_:2},1024))),128))])])):Object(c["createCommentVNode"])("",!0),me.contacts[me.selectedContact].projects&&me.contacts[me.selectedContact].projects.length>0?(Object(c["openBlock"])(),Object(c["createElementBlock"])("div",ue,[Object(c["createElementVNode"])("div",pe,[Object(c["createVNode"])(he,null,{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Ue)]),_:1}),t[14]||(t[14]=Object(c["createTextVNode"])(" 管理项目 "))]),Object(c["createVNode"])($e,{data:me.contacts[me.selectedContact].projects||[],style:{width:"100%"},border:!1,size:"small",stripe:""},{default:Object(c["withCtx"])(()=>[Object(c["createVNode"])(Te,{prop:"name",label:"项目名称"}),Object(c["createVNode"])(Te,{prop:"role",label:"担任角色"}),Object(c["createVNode"])(Te,{prop:"status",label:"状态"},{default:Object(c["withCtx"])(e=>[Object(c["createVNode"])(Pe,{type:"进行中"===e.row.status?"primary":"已完成"===e.row.status?"success":"info",size:"small"},{default:Object(c["withCtx"])(()=>[Object(c["createTextVNode"])(Object(c["toDisplayString"])(e.row.status),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])])):Object(c["createCommentVNode"])("",!0)])]),_:1})):(Object(c["openBlock"])(),Object(c["createBlock"])(Ve,{key:1,description:"请选择一个联系人","image-size":200}))])])])}a("14d9"),a("e9f5"),a("910d"),a("f665"),a("7d54"),a("ab43"),a("a732");var je=a("cee4"),Oe=a("3ef4");function ve(){const e=Object(c["ref"])(!1),t=je["a"].create({timeout:1e4,headers:{"Content-Type":"application/json"}});t.interceptors.request.use(e=>{const t=localStorage.getItem("token");return t&&(e.headers["Authorization"]="Bearer "+t),e},e=>(console.error("请求错误:",e),Promise.reject(e))),t.interceptors.response.use(e=>e.data&&e.data.code>=400?(Oe["a"].error(e.data.message||"请求失败"),Promise.reject(e.data)):e.data,e=>{if(e.response){const a=e.response.status;if(401===a)Oe["a"].error("登录已过期，请重新登录"),localStorage.removeItem("token"),window.location.href="/login";else if(403===a)Oe["a"].error("没有权限执行此操作");else if(404===a)Oe["a"].error("请求的资源不存在");else if(500===a)Oe["a"].error("服务器内部错误");else{var t;Oe["a"].error((null===(t=e.response.data)||void 0===t?void 0:t.message)||"请求失败")}}else e.request?Oe["a"].error("服务器无响应，请稍后重试"):Oe["a"].error("请求配置错误");return Promise.reject(e)});const a=async(a,c={})=>{e.value=!0;try{const{method:o="GET",params:r,data:n,...l}=c,s={url:a,method:o,params:r,data:n,...l},i=await t(s);return i}catch(o){throw console.error("请求出错:",o),o}finally{e.value=!1}};return{loading:e,request:a}}var he=a("6605"),ge=a("f6f2"),fe={name:"Contact",components:{Search:ge["Search"],InfoFilled:ge["InfoFilled"],ChatDotRound:ge["ChatDotRound"],Iphone:ge["Iphone"],User:ge["User"],UserFilled:ge["UserFilled"],Location:ge["Location"],Calendar:ge["Calendar"],Present:ge["Present"],Ticket:ge["Ticket"],Medal:ge["Medal"],SetUp:ge["SetUp"],Promotion:ge["Promotion"],OfficeBuilding:ge["OfficeBuilding"],Briefcase:ge["Briefcase"],House:ge["House"],PieChart:ge["PieChart"],Money:ge["Money"],Headset:ge["Headset"],Connection:ge["Connection"],More:ge["More"]},setup(){const e=Object(c["ref"])(""),t=Object(c["ref"])(0),a=Object(c["ref"])(0),o=Object(c["ref"])([{id:0,name:"全部部门",icon:"bi bi-building",count:0}]),r=Object(c["ref"])([]),n=Object(c["ref"])({departments:!1,contacts:!1}),l=Object(c["ref"])(null),s=Object(c["ref"])(null),i=Object(he["d"])(),{request:d}=ve(),b=e=>{const t={"bi bi-building":"House","bi bi-people-fill":"User","bi bi-person-workspace":"UserFilled","bi bi-people":"OfficeBuilding","bi bi-cash-coin":"Money","bi bi-graph-up":"PieChart","bi bi-code-slash":"Connection","bi bi-box":"Briefcase","bi bi-headset":"Headset","bi bi-three-dots":"More"};return t[e]||"House"},u=e=>{if(!e)return{};const t=["#409EFF","#67C23A","#E6A23C","#F56C6C","#909399","#3B71CA","#14A44D","#DC4C64","#54B4D3","#9FA6B2","#3E4551","#6610F2"];let a=0;if(e.name)for(let o=0;o<e.name.length;o++)a=e.name.charCodeAt(o)+((a<<5)-a);const c=Math.abs(a)%t.length;return{backgroundColor:t[c]}},p=async()=>{try{const e=await d("/api/auth/users/me/");return console.log("获取用户信息响应:",e),e&&e.success&&e.data?(l.value=e.data,s.value=e.data.company,console.log("从标准格式中获取到公司ID:",s.value)):e&&200===e.code&&e.data?(l.value=e.data,s.value=e.data.company,console.log("从code=200格式中获取到公司ID:",s.value)):e&&"object"===typeof e?(l.value=e,s.value=e.company,console.log("从直接返回对象中获取到公司ID:",s.value)):(console.error("无法解析用户信息响应:",e),Oe["a"].warning("用户信息格式异常")),s.value||(console.error("当前用户没有关联公司信息:",l.value),Oe["a"].warning("您的账号未关联任何公司，请联系管理员")),l.value}catch(e){console.error("获取用户信息失败:",e),Oe["a"].error("获取用户信息失败："+(e.message||"未知错误"))}return null},m=async()=>{n.value.departments=!0;try{if(!s.value)return console.error("未找到当前用户所属公司ID，无法加载部门列表"),Oe["a"].warning("无法加载部门列表：未找到您所属的公司"),void(n.value.departments=!1);console.log("开始获取公司部门，公司ID:",s.value);const e=await d(`/api/auth/companies/${s.value}/company_details/`);if(console.log("获取公司部门响应:",e),e&&e.success&&e.data){const t=await j();console.log("联系人总数:",t);const a=[{id:0,name:"全部联系人",icon:"bi bi-people-fill",count:t}],c={"管理层":"bi bi-person-workspace","人事部":"bi bi-people","财务部":"bi bi-cash-coin","市场部":"bi bi-graph-up","技术部":"bi bi-code-slash","产品部":"bi bi-box","客服部":"bi bi-headset","其他":"bi bi-three-dots"},r=e.data.departments.map(e=>({id:e.id,name:e.name,icon:c[e.name]||"bi bi-building",count:e.count||0})),n=await O();n>0&&r.push({id:"no-dept",name:"其他",icon:c["其他"],count:n}),o.value=[...a,...r],console.log("部门列表加载完成:",o.value)}else console.error("获取部门列表响应格式错误:",e),Oe["a"].error("获取部门列表失败：响应格式错误")}catch(e){console.error("获取部门列表失败:",e),Oe["a"].error("获取部门列表失败："+(e.message||"未知错误"))}finally{n.value.departments=!1}},j=async()=>{try{if(!s.value)return console.error("未找到当前用户所属公司ID，无法获取联系人总数"),0;console.log("开始获取联系人总数，公司ID:",s.value);const e=await d("/api/auth/contacts/",{params:{company:s.value}});return console.log("获取联系人总数响应:",e),e&&e.success&&Array.isArray(e.data)?e.data.length:0}catch(e){return console.error("获取联系人总数失败:",e),0}},O=async()=>{try{if(!s.value)return console.error("未找到当前用户所属公司ID，无法获取联系人"),0;console.log("开始获取无部门联系人，公司ID:",s.value);const e=await d("/api/auth/contacts/",{params:{company:s.value}});if(console.log("获取联系人总数响应:",e),e&&e.success&&Array.isArray(e.data)){const t=e.data.filter(e=>!e.department||null===e.department||""===e.department||!e.department_name||null===e.department_name||""===e.department_name);return t.length}return 0}catch(e){return console.error("获取无部门联系人数量失败:",e),0}},v=async()=>{n.value.contacts=!0;try{if(!s.value)return console.error("未找到当前用户所属公司ID，无法获取联系人列表"),Oe["a"].warning("未找到当前用户所属公司，无法获取联系人"),void(n.value.contacts=!1);console.log("开始获取联系人列表，公司ID:",s.value);let c="/api/auth/contacts/";const l={company:s.value};if(e.value)l.search=e.value;else if(0!==t.value){const e=o.value[t.value];e?"no-dept"===e.id?console.log('已选择"其他"部门，将筛选没有部门的联系人'):l.department=e.id:console.error("选择的部门索引无效:",t.value)}console.log("请求联系人列表参数:",l);const i=await d(c,{params:l});console.log("获取联系人列表响应:",i),i&&i.success&&Array.isArray(i.data)?(i.data.forEach(e=>{if(e.avatar){const t=e.avatar;t.startsWith("http://")||t.startsWith("https://")?e.avatar_url=t:t.startsWith("/")?e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${t}`:e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${t}`}else if(e.user&&"object"===typeof e.user&&e.user.avatar){const t=e.user.avatar;t.startsWith("http://")||t.startsWith("https://")?e.avatar_url=t:t.startsWith("/")?e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${t}`:e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${t}`}else e.user&&"number"===typeof e.user&&(e.need_fetch_avatar=!0);console.log(`联系人 ${e.name} 的头像信息:`,{avatar:e.avatar,avatar_url:e.avatar_url,user:e.user})}),0!==t.value&&o.value[t.value]&&"no-dept"===o.value[t.value].id?(r.value=i.data.filter(e=>!e.department||null===e.department||""===e.department||!e.department_name||null===e.department_name||""===e.department_name),console.log("筛选出的无部门联系人:",r.value)):r.value=i.data,r.value.forEach(async(e,t)=>{e.need_fetch_avatar&&await N(e,t)}),r.value&&r.value.length>0?console.log("联系人数据结构示例:",r.value[0]):console.log("未找到任何联系人"),a.value=r.value.length>0?0:null):(console.error("获取联系人列表响应格式错误:",i),Oe["a"].error("获取联系人列表失败：响应格式错误"))}catch(c){console.error("获取联系人列表失败:",c),Oe["a"].error("获取联系人列表失败："+(c.message||"未知错误"))}finally{n.value.contacts=!1}};Object(c["watch"])(t,()=>{v()});let h=null;Object(c["watch"])(e,()=>{h&&clearTimeout(h),h=setTimeout(()=>{v()},300)}),Object(c["onMounted"])(async()=>{try{console.log("开始初始化联系人页面...");const e=await p();if(!e)return void console.error("未能获取到用户信息，中断初始化流程");if(!s.value)return void console.error("未找到用户所属公司ID，中断初始化流程");console.log("开始加载部门列表..."),await m(),console.log("开始加载联系人列表..."),await v(),console.log("联系人页面初始化完成")}catch(e){console.error("联系人页面初始化失败:",e),Oe["a"].error("页面加载失败："+(e.message||"未知错误"))}});const g=e=>e?e.substring(0,1):"",f=async e=>{try{console.log("联系人信息:",e);const a=localStorage.getItem("token");if(!a)return void Oe["a"].error("未登录或登录已过期");const c=await je["a"].get("/api/auth/users/me/",{headers:{Authorization:"Bearer "+a}});if(!c.data||!c.data.data)return void Oe["a"].error("获取当前用户信息失败");const o=c.data.data.id;console.log("当前用户ID:",o);const r=parseInt(e.id);if(isNaN(r)||r<=0)return console.log("无效的用户ID:",e.id),void Oe["a"].error("无效的联系人用户ID");if(r===o)return console.log("无法与自己聊天"),void Oe["a"].error("无法与自己聊天");try{console.log("正在检查是否已有与该联系人的聊天会话...");const t=await je["a"].get("/api/chat/sessions/",{headers:{Authorization:"Bearer "+a}});console.log("获取到的会话列表:",t.data);let c=[];t.data&&t.data.results?c=t.data.results:t.data&&Array.isArray(t.data)?c=t.data:t.data&&t.data.data&&Array.isArray(t.data.data)&&(c=t.data.data);const o=c.find(e=>{if(e.is_group)return!1;if(!e.participants||!Array.isArray(e.participants))return!1;if(2!==e.participants.length)return!1;const t=e.participants.some(e=>e.user&&e.user.id===r);return t});if(o)return console.log("找到现有会话:",o),void i.push({path:"/chat",query:{id:o.id}});console.log("未找到与该联系人的现有会话，将创建新会话");const n={participant_ids:[r],is_group:!1,title:e.name?`与${e.name}的聊天`:"新聊天"};console.log("发送创建聊天会话请求:",n),console.log("participant_ids值:",n.participant_ids),console.log("participant_ids[0]类型:",typeof n.participant_ids[0]);const l=await je["a"].post("/api/chat/sessions/",n,{headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"}});console.log("聊天会话创建响应:",l.data);let s=null;l.data&&l.data.id?s=l.data.id:l.data&&l.data.data&&l.data.data.id&&(s=l.data.data.id),s?(console.log("获取到的会话ID:",s),i.push({path:"/chat",query:{id:s}})):(console.error("无法获取会话ID:",l.data),Oe["a"].error("创建聊天会话成功，但无法获取会话ID"))}catch(t){if(console.error("创建聊天会话失败:",t),t.response){console.error("错误详情:",t.response.data),console.error("错误状态码:",t.response.status);let e="创建聊天会话失败";t.response.data&&(e="string"===typeof t.response.data?t.response.data:t.response.data.detail?t.response.data.detail:t.response.data.message?t.response.data.message:t.response.data.participant_ids&&Array.isArray(t.response.data.participant_ids)&&t.response.data.participant_ids.length>0?t.response.data.participant_ids[0]:"创建聊天会话失败: "+JSON.stringify(t.response.data)),Oe["a"].error(e)}else Oe["a"].error("创建聊天会话失败：网络错误");throw t}}catch(t){console.error("操作失败:",t),Oe["a"].error("操作失败："+(t.message||"未知错误"))}},N=async(e,t)=>{if(e.user&&"number"===typeof e.user)try{const a=localStorage.getItem("token");if(!a)return;console.log(`为联系人 ${e.name} 获取用户头像...`);const c=await je["a"].get(`/api/auth/users/${e.user}/`,{headers:{Authorization:"Bearer "+a}});let o=null;if(c.data&&c.data.success&&c.data.data?o=c.data.data:c.data&&(o=c.data),o&&o.avatar){const a=o.avatar;a.startsWith("http://")||a.startsWith("https://")?e.avatar_url=a:a.startsWith("/")?e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${a}`:e.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${a}`,console.log(`成功获取联系人 ${e.name} 的头像:`,e.avatar_url),void 0!==t&&t>=0&&t<r.value.length&&(r.value[t]={...e})}}catch(a){console.error(`获取联系人 ${e.name} 的用户头像失败:`,a)}};return{searchQuery:e,selectedDept:t,selectedContact:a,departments:o,contacts:r,loading:n,getInitials:g,startChat:f,getDeptIcon:b,getAvatarStyle:u}}},Ne=(a("288e"),a("6b0d")),Ve=a.n(Ne);const ye=Ve()(fe,[["render",me],["__scopeId","data-v-d0b5a8e4"]]);t["default"]=ye},"288e":function(e,t,a){"use strict";a("9a53")},"910d":function(e,t,a){"use strict";var c=a("23e7"),o=a("c65b"),r=a("59ed"),n=a("825a"),l=a("46c4"),s=a("c5cc"),i=a("9bdd"),d=a("c430"),b=a("2a62"),u=a("f99f"),p=!d&&u("filter",TypeError),m=s((function(){var e,t,a,c=this.iterator,r=this.predicate,l=this.next;while(1){if(e=n(o(l,c)),t=this.done=!!e.done,t)return;if(a=e.value,i(c,r,[a,this.counter++],!0))return a}}));c({target:"Iterator",proto:!0,real:!0,forced:d||p},{filter:function(e){n(this);try{r(e)}catch(t){b(this,"throw",t)}return p?o(p,this,e):new m(l(this),{predicate:e})}})},"9a53":function(e,t,a){},f665:function(e,t,a){"use strict";var c=a("23e7"),o=a("c65b"),r=a("2266"),n=a("59ed"),l=a("825a"),s=a("46c4"),i=a("2a62"),d=a("f99f"),b=d("find",TypeError);c({target:"Iterator",proto:!0,real:!0,forced:b},{find:function(e){l(this);try{n(e)}catch(c){i(this,"throw",c)}if(b)return o(b,this,e);var t=s(this),a=0;return r(t,(function(t,c){if(e(t,a++))return c(t)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})}}]);
//# sourceMappingURL=chunk-e72ec65a.56032a2d.js.map