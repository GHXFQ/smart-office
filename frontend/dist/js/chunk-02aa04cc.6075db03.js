(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-02aa04cc","chunk-2d0e4842"],{"13ab":function(e,t,a){"use strict";a.r(t);var r=a("7a23");const n={class:"chat-container"},o={key:0,class:"chat-header-actions"},c={class:"chat-layout"},l={class:"chat-sidebar"},s={class:"search-box"},i={class:"search-header"},d={class:"chat-tabs"},u=["onClick"],m={class:"contacts-list"},p={key:0},b={class:"department-header"},g=["onClick"],O={class:"contact-avatar"},j={class:"avatar-initial"},v=["src"],f={class:"contact-info"},h={class:"contact-name"},y={class:"time"},w={class:"contact-message"},V={key:1,class:"loading-container"},_=["onClick"],k={class:"contact-avatar"},C={class:"avatar-initial"},N=["src"],E={class:"contact-info"},D={class:"contact-name"},x={class:"time"},B={class:"contact-message"},S={key:0,class:"empty-contacts"},A={key:2,class:"loading-container"},I={class:"chat-content"},M={key:0,class:"chat-header"},T={class:"contact-avatar"},U={class:"avatar-initial"},$=["src"],P={class:"contact-info"},F={class:"chat-actions"},z={key:1,class:"chat-messages",ref:"messageContainer"},L={class:"message-container"},Y={key:0,class:"message-avatar"},R={class:"avatar-initial"},H=["src"],q=["onContextmenu"],G={key:0,class:"text-card"},W={class:"text-card-inner"},K={key:1,class:"image-card"},J={class:"image-card-inner"},Q=["onClick"],X=["src"],Z=["onClick"],ee={class:"file-card-inner"},te={class:"file-icon"},ae={class:"file-info"},re={class:"file-name"},ne={class:"file-name-main"},oe={class:"file-name-ext"},ce={class:"file-meta"},le={class:"file-size"},se=["onClick"],ie={class:"knowledge-card-inner"},de={class:"knowledge-icon"},ue={class:"knowledge-content"},me={class:"knowledge-title"},pe={class:"knowledge-desc"},be={class:"knowledge-footer"},ge={class:"knowledge-type"},Oe={class:"message-time"},je={key:1,class:"empty-messages"},ve={key:2,class:"loading-messages"},fe={style:{"text-align":"right","margin-top":"20px"}},he={key:2,class:"chat-input"},ye={class:"chat-tools"},we={class:"input-area"},Ve={class:"send-button"},_e={key:3,class:"empty-chat"},ke={class:"empty-illustration"},Ce={class:"dialog-footer"},Ne={"element-loading-text":"正在生成摘要，请稍候..."},Ee={key:0,class:"summary-content-wrapper"},De={class:"summary-content"},xe={style:{"white-space":"pre-wrap"}},Be={class:"dialog-footer"},Se=["src"],Ae={"element-loading-text":"AI分析中..."},Ie={class:"dialog-footer"};function Me(e,t,a,Me,Te,Ue){const $e=Object(r["resolveComponent"])("el-alert"),Pe=Object(r["resolveComponent"])("el-input"),Fe=Object(r["resolveComponent"])("Refresh"),ze=Object(r["resolveComponent"])("el-icon"),Le=Object(r["resolveComponent"])("el-button"),Ye=Object(r["resolveComponent"])("el-badge"),Re=Object(r["resolveComponent"])("el-skeleton"),He=Object(r["resolveComponent"])("UserFilled"),qe=Object(r["resolveComponent"])("el-empty"),Ge=Object(r["resolveComponent"])("el-tooltip"),We=Object(r["resolveComponent"])("Document"),Ke=Object(r["resolveComponent"])("Reading"),Je=Object(r["resolveComponent"])("ChatLineSquare"),Qe=Object(r["resolveComponent"])("PictureFilled"),Xe=Object(r["resolveComponent"])("FolderOpened"),Ze=Object(r["resolveComponent"])("Position"),et=Object(r["resolveComponent"])("ChatDotSquare"),tt=Object(r["resolveComponent"])("el-card"),at=Object(r["resolveComponent"])("el-table-column"),rt=Object(r["resolveComponent"])("el-tag"),nt=Object(r["resolveComponent"])("el-table"),ot=Object(r["resolveComponent"])("el-dialog"),ct=Object(r["resolveComponent"])("el-date-picker"),lt=Object(r["resolveComponent"])("el-form-item"),st=Object(r["resolveComponent"])("el-form"),it=Object(r["resolveComponent"])("Calendar"),dt=Object(r["resolveComponent"])("DocumentCopy"),ut=Object(r["resolveComponent"])("el-option"),mt=Object(r["resolveComponent"])("el-select"),pt=Object(r["resolveDirective"])("loading");return Object(r["openBlock"])(),Object(r["createElementBlock"])("div",n,[Object(r["createVNode"])(tt,{class:"chat-card","body-style":{backgroundColor:"transparent",padding:0}},{default:Object(r["withCtx"])(()=>[Me.sessionsLoading?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",o,[Object(r["createVNode"])($e,{title:"正在加载数据...",type:"info",closable:!1,"show-icon":""})])):Object(r["createCommentVNode"])("",!0),Object(r["createElementVNode"])("div",c,[Object(r["createElementVNode"])("div",l,[Object(r["createElementVNode"])("div",s,[Object(r["createElementVNode"])("div",i,[Object(r["createVNode"])(Pe,{modelValue:Me.searchQuery,"onUpdate:modelValue":t[0]||(t[0]=e=>Me.searchQuery=e),placeholder:"搜索联系人...",clearable:"","prefix-icon":Me.Search},null,8,["modelValue","prefix-icon"]),Object(r["createVNode"])(Le,{circle:"",size:"small",onClick:Me.refreshChatSessions,title:"刷新列表"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Fe)]),_:1})]),_:1},8,["onClick"])])]),Object(r["createElementVNode"])("div",d,[(Object(r["openBlock"])(!0),Object(r["createElementBlock"])(r["Fragment"],null,Object(r["renderList"])(Me.tabs,(e,t)=>(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:t,class:Object(r["normalizeClass"])(["chat-tab",{active:Me.activeTab===t}]),onClick:e=>Me.activeTab=t},Object(r["toDisplayString"])(e),11,u))),128))]),Object(r["createElementVNode"])("div",m,[1===Me.activeTab?(Object(r["openBlock"])(),Object(r["createElementBlock"])(r["Fragment"],{key:0},[!Me.sessionsLoading&&Object.keys(Me.groupedUsersByDepartment).length>0?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",p,[(Object(r["openBlock"])(!0),Object(r["createElementBlock"])(r["Fragment"],null,Object(r["renderList"])(Me.groupedUsersByDepartment,(e,t)=>(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:t,class:"department-group"},[Object(r["createElementVNode"])("div",b,Object(r["toDisplayString"])(t),1),(Object(r["openBlock"])(!0),Object(r["createElementBlock"])(r["Fragment"],null,Object(r["renderList"])(e,e=>(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:e.id,class:Object(r["normalizeClass"])(["contact-item",{active:Me.selectedContact===e.id}]),onClick:t=>Me.selectContact(e)},[Object(r["createElementVNode"])("div",O,[e.avatar||e.avatar_url?(Object(r["openBlock"])(),Object(r["createElementBlock"])("img",{key:1,src:e.avatar_url||e.avatar,alt:"avatar",class:"avatar"},null,8,v)):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:0,class:"avatar",style:Object(r["normalizeStyle"])({backgroundColor:e.color})},[Object(r["createElementVNode"])("span",j,Object(r["toDisplayString"])(e.initial),1)],4)),Object(r["createElementVNode"])("div",{class:Object(r["normalizeClass"])(["contact-status","status-"+e.status])},null,2)]),Object(r["createElementVNode"])("div",f,[Object(r["createElementVNode"])("div",h,[Object(r["createElementVNode"])("span",null,Object(r["toDisplayString"])(e.name),1),Object(r["createElementVNode"])("span",y,Object(r["toDisplayString"])(e.lastTime),1)]),Object(r["createElementVNode"])("div",w,[Object(r["createElementVNode"])("span",null,Object(r["toDisplayString"])(e.lastMessage),1),e.unread?(Object(r["openBlock"])(),Object(r["createBlock"])(Ye,{key:0,value:e.unread,class:"message-badge"},null,8,["value"])):Object(r["createCommentVNode"])("",!0)])])],10,g))),128))]))),128))])):Me.sessionsLoading?Object(r["createCommentVNode"])("",!0):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",V,[Object(r["createVNode"])(Re,{rows:5,animated:""})]))],64)):(Object(r["openBlock"])(),Object(r["createElementBlock"])(r["Fragment"],{key:1},[(Object(r["openBlock"])(!0),Object(r["createElementBlock"])(r["Fragment"],null,Object(r["renderList"])(Me.filteredContacts,e=>(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:e.id,class:Object(r["normalizeClass"])(["contact-item",{active:Me.selectedContact===e.id}]),onClick:t=>Me.selectContact(e)},[Object(r["createElementVNode"])("div",k,[e.avatar||e.avatar_url?(Object(r["openBlock"])(),Object(r["createElementBlock"])("img",{key:1,src:e.avatar_url||e.avatar,alt:"avatar",class:"avatar"},null,8,N)):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:0,class:"avatar",style:Object(r["normalizeStyle"])({backgroundColor:e.color})},[Object(r["createElementVNode"])("span",C,Object(r["toDisplayString"])(e.initial),1)],4)),Object(r["createElementVNode"])("div",{class:Object(r["normalizeClass"])(["contact-status","status-"+e.status])},null,2)]),Object(r["createElementVNode"])("div",E,[Object(r["createElementVNode"])("div",D,[Object(r["createElementVNode"])("span",null,Object(r["toDisplayString"])(e.name),1),Object(r["createElementVNode"])("span",x,Object(r["toDisplayString"])(e.lastTime),1)]),Object(r["createElementVNode"])("div",B,[Object(r["createElementVNode"])("span",null,Object(r["toDisplayString"])(e.lastMessage),1),e.unread?(Object(r["openBlock"])(),Object(r["createBlock"])(Ye,{key:0,value:e.unread,class:"message-badge"},null,8,["value"])):Object(r["createCommentVNode"])("",!0)])])],10,_))),128)),Me.sessionsLoading||0!==Me.filteredContacts.length?Object(r["createCommentVNode"])("",!0):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",S,[Object(r["createVNode"])(qe,{description:"暂无联系人","image-size":100},{image:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,{size:64,class:"empty-icon"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(He)]),_:1})]),_:1})]))],64)),Me.sessionsLoading?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",A,[Object(r["createVNode"])(Re,{rows:5,animated:""})])):Object(r["createCommentVNode"])("",!0)])]),Object(r["createElementVNode"])("div",I,[null!==Me.selectedContact?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",M,[Object(r["createElementVNode"])("div",T,[Me.currentContact.avatar||Me.currentContact.avatar_url?(Object(r["openBlock"])(),Object(r["createElementBlock"])("img",{key:1,src:Me.currentContact.avatar_url||Me.currentContact.avatar,alt:"avatar",class:"avatar"},null,8,$)):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:0,class:"avatar",style:Object(r["normalizeStyle"])({backgroundColor:Me.currentContact.color})},[Object(r["createElementVNode"])("span",U,Object(r["toDisplayString"])(Me.currentContact.initial||"?"),1)],4)),Object(r["createElementVNode"])("div",{class:Object(r["normalizeClass"])(["contact-status","status-"+(Me.currentContact.status||"online")])},null,2)]),Object(r["createElementVNode"])("div",P,[Object(r["createElementVNode"])("h6",null,Object(r["toDisplayString"])(Me.currentContact.name||"未命名联系人"),1),Object(r["createElementVNode"])("p",null,Object(r["toDisplayString"])(Me.getStatusText(Me.currentContact.status||"online")),1)]),Object(r["createElementVNode"])("div",F,[Object(r["createVNode"])(Ge,{content:"AI总结",placement:"bottom"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Le,{onClick:Me.openSummaryDialog,circle:""},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>t[20]||(t[20]=[Object(r["createElementVNode"])("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",class:"bi bi-robot",viewBox:"0 0 16 16"},[Object(r["createElementVNode"])("path",{d:"M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.22z"}),Object(r["createElementVNode"])("path",{d:"M4 1.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5M12 1a2 2 0 0 1 2 2v10.5a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2zM4 0a1 1 0 0 0-1 1v10.5a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1z"})],-1)])),_:1})]),_:1},8,["onClick"])]),_:1})])])):Object(r["createCommentVNode"])("",!0),null!==Me.selectedContact?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",z,[Me.messages.length>0?(Object(r["openBlock"])(!0),Object(r["createElementBlock"])(r["Fragment"],{key:0},Object(r["renderList"])(Me.messages,(e,a)=>(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:e.id||a,class:Object(r["normalizeClass"])(["message",e.sender.id===Me.userId?"message-sent":"message-received"])},[Object(r["createElementVNode"])("div",L,[e.sender.id!==Me.userId?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",Y,[e.sender.avatar||e.sender.avatar_url?(Object(r["openBlock"])(),Object(r["createElementBlock"])("img",{key:1,src:e.sender.avatar_url||e.sender.avatar,alt:"avatar",class:"avatar small"},null,8,H)):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:0,class:"avatar small",style:Object(r["normalizeStyle"])({backgroundColor:Me.getSenderColor(e.sender)})},[Object(r["createElementVNode"])("span",R,Object(r["toDisplayString"])(Me.getSenderInitial(e.sender)),1)],4))])):Object(r["createCommentVNode"])("",!0),Object(r["createElementVNode"])("div",{class:"message-content-wrapper",onContextmenu:Object(r["withModifiers"])(t=>Me.openContextMenu(t,e),["prevent"])},[Object(r["createElementVNode"])("div",{class:Object(r["normalizeClass"])(["message-content",e.sender.id===Me.userId?"sent":"received"])},["text"===e.message_type?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",G,[Object(r["createElementVNode"])("div",W,Object(r["toDisplayString"])(e.content),1)])):"image"===e.message_type?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",K,[Object(r["createElementVNode"])("div",J,[Object(r["createElementVNode"])("div",{class:"image-preview",onClick:t=>Me.toggleImageExpand(e.file)},[Object(r["createElementVNode"])("img",{src:e.file,alt:"image"},null,8,X)],8,Q)])])):"file"===e.message_type?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:2,class:"file-card",onClick:t=>Me.downloadFile(e)},[Object(r["createElementVNode"])("div",ee,[Object(r["createElementVNode"])("div",te,[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(We)]),_:1})]),Object(r["createElementVNode"])("div",ae,[Object(r["createElementVNode"])("div",re,[Object(r["createElementVNode"])("span",ne,Object(r["toDisplayString"])(Me.getFileName(e.file_name)),1),Object(r["createElementVNode"])("span",oe,Object(r["toDisplayString"])(Me.getFileExtension(e.file_name)),1)]),Object(r["createElementVNode"])("div",ce,[Object(r["createElementVNode"])("span",le,Object(r["toDisplayString"])(Me.formatFileSize(e.file_size)),1),t[21]||(t[21]=Object(r["createElementVNode"])("span",{class:"file-download-hint"},"点击下载",-1))])])])],8,Z)):"knowledge"===e.message_type?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:3,class:"knowledge-card",onClick:t=>Me.viewKnowledge(e)},[Object(r["createElementVNode"])("div",ie,[Object(r["createElementVNode"])("div",de,[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Ke)]),_:1})]),Object(r["createElementVNode"])("div",ue,[Object(r["createElementVNode"])("div",me,Object(r["toDisplayString"])(e.knowledge_detail.title),1),Object(r["createElementVNode"])("div",pe,Object(r["toDisplayString"])(e.knowledge_detail.description),1),Object(r["createElementVNode"])("div",be,[Object(r["createElementVNode"])("span",ge,Object(r["toDisplayString"])(e.knowledge_detail.file_type),1),t[22]||(t[22]=Object(r["createElementVNode"])("span",{class:"knowledge-view"},"查看详情",-1))])])])],8,se)):Object(r["createCommentVNode"])("",!0)],2),Object(r["createElementVNode"])("div",Oe,Object(r["toDisplayString"])(Me.formatMessageTime(e.created_at)),1)],40,q)])],2))),128)):Me.messagesLoading?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",ve,[Object(r["createVNode"])(Re,{rows:3,animated:""}),Object(r["createVNode"])(Re,{style:{"margin-top":"20px"},rows:2,animated:""}),Object(r["createElementVNode"])("div",fe,[Object(r["createVNode"])(Re,{rows:2,animated:""})])])):(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",je,[Object(r["createVNode"])(qe,{description:"暂无消息记录"},{image:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,{size:64,class:"empty-icon"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Je)]),_:1})]),default:Object(r["withCtx"])(()=>[t[23]||(t[23]=Object(r["createElementVNode"])("p",null,"发送第一条消息开始对话吧",-1))]),_:1})]))],512)):Object(r["createCommentVNode"])("",!0),null!==Me.selectedContact?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",he,[Object(r["createElementVNode"])("div",ye,[Object(r["createVNode"])(Ge,{content:"发送图片",placement:"top"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Le,{circle:"",onClick:Me.openImageUpload,loading:Me.imageUploading},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Qe)]),_:1})]),_:1},8,["onClick","loading"])]),_:1}),Object(r["createVNode"])(Ge,{content:"发送文件",placement:"top"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Le,{circle:"",onClick:Me.openFileUpload,loading:Me.fileUploading},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Xe)]),_:1})]),_:1},8,["onClick","loading"])]),_:1})]),Object(r["createElementVNode"])("div",we,[Object(r["createVNode"])(Pe,{modelValue:Me.messageInput,"onUpdate:modelValue":t[1]||(t[1]=e=>Me.messageInput=e),type:"textarea",rows:3,placeholder:"输入消息...",resize:"none",onKeyup:Object(r["withKeys"])(Object(r["withModifiers"])(Me.sendMessage,["prevent"]),["enter"])},null,8,["modelValue","onKeyup"])]),Object(r["createElementVNode"])("div",Ve,[Object(r["createVNode"])(Le,{type:"primary",onClick:Me.sendMessage},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Ze)]),_:1}),t[24]||(t[24]=Object(r["createTextVNode"])(" 发送 "))]),_:1},8,["onClick"])])])):Object(r["createCommentVNode"])("",!0),null===Me.selectedContact?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",_e,[Object(r["createElementVNode"])("div",ke,[Object(r["createVNode"])(ze,{size:64},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(et)]),_:1})]),t[25]||(t[25]=Object(r["createElementVNode"])("h4",null,"选择一个联系人开始聊天",-1)),t[26]||(t[26]=Object(r["createElementVNode"])("p",null,"从左侧列表选择联系人开始对话",-1))])):Object(r["createCommentVNode"])("",!0)])])]),_:1}),Object(r["createElementVNode"])("input",{type:"file",ref:"fileInput",style:{display:"none"},onChange:t[2]||(t[2]=(...e)=>Me.handleFileUpload&&Me.handleFileUpload(...e))},null,544),Object(r["createElementVNode"])("input",{type:"file",ref:"imageInput",style:{display:"none"},accept:"image/*",onChange:t[3]||(t[3]=(...e)=>Me.handleImageUpload&&Me.handleImageUpload(...e))},null,544),Object(r["createVNode"])(ot,{modelValue:Me.knowledgeDialogVisible,"onUpdate:modelValue":t[5]||(t[5]=e=>Me.knowledgeDialogVisible=e),title:"选择知识库文件",width:"50%"},{footer:Object(r["withCtx"])(()=>[Object(r["createElementVNode"])("span",Ce,[Object(r["createVNode"])(Le,{onClick:t[4]||(t[4]=e=>Me.knowledgeDialogVisible=!1)},{default:Object(r["withCtx"])(()=>t[28]||(t[28]=[Object(r["createTextVNode"])("取消")])),_:1})])]),default:Object(r["withCtx"])(()=>[Object(r["withDirectives"])((Object(r["openBlock"])(),Object(r["createBlock"])(nt,{data:Me.knowledgeList,style:{width:"100%"},onRowClick:Me.selectKnowledge},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(at,{prop:"title",label:"标题"}),Object(r["createVNode"])(at,{prop:"file_type",label:"类型"},{default:Object(r["withCtx"])(e=>[Object(r["createVNode"])(rt,null,{default:Object(r["withCtx"])(()=>[Object(r["createTextVNode"])(Object(r["toDisplayString"])(e.row.file_type),1)]),_:2},1024)]),_:1}),Object(r["createVNode"])(at,{prop:"created_at",label:"创建时间"},{default:Object(r["withCtx"])(e=>[Object(r["createTextVNode"])(Object(r["toDisplayString"])(Me.formatDate(e.row.created_at)),1)]),_:1}),Object(r["createVNode"])(at,{label:"操作"},{default:Object(r["withCtx"])(e=>[Object(r["createVNode"])(Le,{type:"primary",size:"small",onClick:Object(r["withModifiers"])(t=>Me.shareKnowledge(e.row),["stop"])},{default:Object(r["withCtx"])(()=>t[27]||(t[27]=[Object(r["createTextVNode"])(" 分享 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data","onRowClick"])),[[pt,Me.knowledgeLoading]])]),_:1},8,["modelValue"]),Object(r["createVNode"])(ot,{modelValue:Me.summaryDialogVisible,"onUpdate:modelValue":t[7]||(t[7]=e=>Me.summaryDialogVisible=e),title:"AI 聊天总结",width:"50%",onClose:Me.handleCloseSummaryDialog,top:"5vh"},{footer:Object(r["withCtx"])(()=>[Object(r["createElementVNode"])("span",Be,[Object(r["createVNode"])(Le,{onClick:Me.handleCloseSummaryDialog},{default:Object(r["withCtx"])(()=>t[29]||(t[29]=[Object(r["createTextVNode"])("关闭")])),_:1},8,["onClick"]),Object(r["createVNode"])(Le,{type:"primary",onClick:Me.handleSummarize,disabled:Me.summaryLoading},{default:Object(r["withCtx"])(()=>[Object(r["createTextVNode"])(Object(r["toDisplayString"])(Me.summaryLoading?"生成中...":"生成摘要"),1)]),_:1},8,["onClick","disabled"])])]),default:Object(r["withCtx"])(()=>[Object(r["withDirectives"])((Object(r["openBlock"])(),Object(r["createElementBlock"])("div",Ne,[Object(r["createVNode"])(st,{"label-position":"top",style:{"margin-bottom":"20px"}},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(lt,{label:"选择要总结的消息时间范围"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ct,{modelValue:Me.summaryDateRange,"onUpdate:modelValue":t[6]||(t[6]=e=>Me.summaryDateRange=e),type:"datetimerange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","picker-options":Me.pickerOptions,style:{width:"100%"}},null,8,["modelValue","picker-options"])]),_:1})]),_:1}),Me.summaryContent?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",Ee,[Object(r["createVNode"])($e,{title:"AI 总结要点",type:"info",closable:!1,"show-icon":"",class:"summary-title"}),Object(r["createElementVNode"])("div",De,[Object(r["createElementVNode"])("p",xe,Object(r["toDisplayString"])(Me.summaryContent),1)])])):Object(r["createCommentVNode"])("",!0),Me.summaryContent||Me.summaryLoading?Object(r["createCommentVNode"])("",!0):(Object(r["openBlock"])(),Object(r["createBlock"])(qe,{key:1,description:"暂无摘要，请选择时间范围后点击"}))])),[[pt,Me.summaryLoading]])]),_:1},8,["modelValue","onClose"]),Me.expandedImage?(Object(r["openBlock"])(),Object(r["createElementBlock"])("div",{key:0,class:"fullscreen-image-preview",onClick:t[8]||(t[8]=e=>Me.expandedImage=null)},[Object(r["createElementVNode"])("img",{src:Me.expandedImage,alt:"预览图片",class:"fullscreen-preview-image"},null,8,Se)])):Object(r["createCommentVNode"])("",!0),Object(r["withDirectives"])(Object(r["createElementVNode"])("div",{class:"chat-context-menu",style:Object(r["normalizeStyle"])(Me.contextMenuStyle)},[Object(r["createElementVNode"])("div",{class:"context-menu-item",onClick:t[9]||(t[9]=(...e)=>Me.addToCalendarFromMessage&&Me.addToCalendarFromMessage(...e))},[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(it)]),_:1}),t[30]||(t[30]=Object(r["createElementVNode"])("span",null,"添加到日程",-1))]),Object(r["createElementVNode"])("div",{class:"context-menu-item",onClick:t[10]||(t[10]=(...e)=>Me.copyMessageContent&&Me.copyMessageContent(...e))},[Object(r["createVNode"])(ze,null,{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(dt)]),_:1}),t[31]||(t[31]=Object(r["createElementVNode"])("span",null,"复制内容",-1))])],4),[[r["vShow"],Me.contextMenuVisible]]),Object(r["createVNode"])(ot,{modelValue:Me.calendarDialogVisible,"onUpdate:modelValue":t[19]||(t[19]=e=>Me.calendarDialogVisible=e),title:"添加日程",width:"500px"},{footer:Object(r["withCtx"])(()=>[Object(r["createElementVNode"])("div",Ie,[Object(r["createVNode"])(Le,{onClick:t[18]||(t[18]=e=>Me.calendarDialogVisible=!1)},{default:Object(r["withCtx"])(()=>t[32]||(t[32]=[Object(r["createTextVNode"])("取消")])),_:1}),Object(r["createVNode"])(Le,{type:"primary",onClick:Me.submitCalendarEvent,loading:Me.isSubmitting},{default:Object(r["withCtx"])(()=>t[33]||(t[33]=[Object(r["createTextVNode"])("确认添加")])),_:1},8,["onClick","loading"])])]),default:Object(r["withCtx"])(()=>[Object(r["withDirectives"])((Object(r["openBlock"])(),Object(r["createElementBlock"])("div",Ae,[Object(r["createVNode"])(st,{model:Me.calendarEvent,rules:Me.calendarRules,ref:"calendarFormRef","label-width":"80px"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(lt,{label:"标题",prop:"title"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Pe,{modelValue:Me.calendarEvent.title,"onUpdate:modelValue":t[11]||(t[11]=e=>Me.calendarEvent.title=e),placeholder:"请输入日程标题"},null,8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"开始时间",prop:"start"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ct,{modelValue:Me.calendarEvent.start,"onUpdate:modelValue":t[12]||(t[12]=e=>Me.calendarEvent.start=e),type:"datetime",placeholder:"选择开始时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"结束时间",prop:"end"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ct,{modelValue:Me.calendarEvent.end,"onUpdate:modelValue":t[13]||(t[13]=e=>Me.calendarEvent.end=e),type:"datetime",placeholder:"选择结束时间",format:"YYYY-MM-DD HH:mm","value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"地点",prop:"location"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Pe,{modelValue:Me.calendarEvent.location,"onUpdate:modelValue":t[14]||(t[14]=e=>Me.calendarEvent.location=e),placeholder:"请输入地点"},null,8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"类型",prop:"type"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(mt,{modelValue:Me.calendarEvent.type,"onUpdate:modelValue":t[15]||(t[15]=e=>Me.calendarEvent.type=e),placeholder:"请选择日程类型"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ut,{label:"会议",value:"blue"}),Object(r["createVNode"])(ut,{label:"出差",value:"orange"}),Object(r["createVNode"])(ut,{label:"假期",value:"green"}),Object(r["createVNode"])(ut,{label:"截止日期",value:"red"}),Object(r["createVNode"])(ut,{label:"其他",value:"purple"})]),_:1},8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"提醒",prop:"reminder"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(mt,{modelValue:Me.calendarEvent.reminder,"onUpdate:modelValue":t[16]||(t[16]=e=>Me.calendarEvent.reminder=e),placeholder:"请选择提醒时间"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(ut,{label:"不提醒",value:"none"}),Object(r["createVNode"])(ut,{label:"10分钟前",value:"10min"}),Object(r["createVNode"])(ut,{label:"30分钟前",value:"30min"}),Object(r["createVNode"])(ut,{label:"1小时前",value:"1hour"}),Object(r["createVNode"])(ut,{label:"1天前",value:"1day"})]),_:1},8,["modelValue"])]),_:1}),Object(r["createVNode"])(lt,{label:"描述",prop:"description"},{default:Object(r["withCtx"])(()=>[Object(r["createVNode"])(Pe,{modelValue:Me.calendarEvent.description,"onUpdate:modelValue":t[17]||(t[17]=e=>Me.calendarEvent.description=e),type:"textarea",rows:3,placeholder:"请输入描述信息"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])])),[[pt,Me.isAnalyzing]])]),_:1},8,["modelValue"])])}a("d9e2"),a("14d9"),a("e9f5"),a("910d"),a("f665"),a("7d54"),a("ab43"),a("a732"),a("88a7"),a("271a"),a("5494");var Te=a("5502"),Ue=a("6605"),$e=a("3ef4"),Pe=a("c9a1"),Fe=a("f6f2"),ze=a("d800"),Le=a("db6a"),Ye=(a("c466"),a("b775")),Re=a("48cf"),He={name:"Chat",components:{Calendar:Fe["Calendar"],DocumentCopy:Fe["DocumentCopy"]},setup(){const e=Object(Te["b"])(),t=Object(r["computed"])(()=>e.getters.user),a=Object(r["ref"])(null),n=Object(r["ref"])(""),o=Object(r["ref"])(0),c=Object(r["ref"])(null),l=Object(r["ref"])(""),s=Object(r["ref"])(null),i=Object(r["ref"])(null),d=Object(r["ref"])(null),u=Object(r["ref"])([]),m=Object(r["ref"])(!1),p=Object(r["ref"])(!1),b=Object(r["ref"])([]),g=Object(r["ref"])(null),O=Object(r["ref"])(!1),j=Object(r["ref"])(!1),v=Object(r["ref"])([]),f=Object(r["ref"])(null),h=Object(r["ref"])(["最近聊天","同事"]),y=Object(r["ref"])([]),w=Object(r["ref"])([]),V=Object(r["ref"])([]),_=Object(r["computed"])(()=>null===c.value?{}:y.value.find(e=>e.id===c.value)||{}),k=Object(r["computed"])(()=>{var e;return(null===(e=a.value)||void 0===e?void 0:e.id)||null}),C=Object(r["computed"])(()=>n.value?y.value.filter(e=>e.name.toLowerCase().includes(n.value.toLowerCase())):y.value),N=Object(r["computed"])(()=>0===o.value?C.value:1===o.value?C.value.filter(e=>!e.isGroup):C.value),E=Object(r["computed"])(()=>{const e=new Map;C.value.filter(e=>!e.isGroup).forEach(t=>{a.value&&t.userId===a.value.id||e.set(t.userId||t.id,t)}),w.value.forEach(t=>{if((!a.value||t.id!==a.value.id)&&!e.has(t.id)){const a={id:"user_"+t.id,userId:t.id,name:(t.name||t.username||"未命名联系人").trim(),initial:(t.name||t.username||"未命名联系人")[0],avatar:t.avatar||"",color:X(t.id),status:"online",lastMessage:"",lastTime:"",unread:0,isGroup:!1,department:t.department||"其它"};e.set(t.id,a)}});const t=new Map(V.value.map(e=>[e.id,e.name])),r={};return Array.from(e.values()).forEach(e=>{const a=t.get(e.department)||"其他";r[a]||(r[a]=[]),r[a].push(e)}),r}),D=Object(Ue["c"])();let x=null;Object(r["onBeforeUnmount"])(()=>{x&&clearInterval(x)}),Object(r["onMounted"])(async()=>{try{const e=await B();if(!e)return void $e["a"].error("无法加载用户信息，请刷新页面重试");if(console.log("组件挂载时获取的用户信息:",e),!a.value||!a.value.id)return console.error("用户数据未正确加载:",a.value),void $e["a"].error("用户数据加载异常，请刷新页面重试");console.log("当前用户数据已正确加载:",a.value),await ne(),await oe(),await S();const t=D.query.session||D.query.id;if(t){const e=y.value.find(e=>e.id===parseInt(t));e?(c.value=e.id,await A(t)):(console.log("通过ID直接加载聊天会话:",t),await A(t))}x=setInterval(async()=>{c.value&&await A(c.value,!0),await S(!0)},3e4),await Object(r["nextTick"])(),M()}catch(e){console.error("初始化聊天组件失败:",e),$e["a"].error("初始化聊天组件失败: "+e.message)}});const B=async()=>{try{console.log("开始获取当前用户信息...");const e=localStorage.getItem("token");if(!e)return console.warn("本地存储中没有找到认证token"),$e["a"].warning("未登录或登录已过期，请重新登录"),null;const t=await Object(Ye["a"])({url:"/api/auth/users/me/",method:"get"});console.log("获取用户信息响应:",t);let r=null;if(t.data&&t.data.id)r=t.data,console.log("从data字段获取用户数据:",r);else if(t.data&&t.data.data&&t.data.data.id)r=t.data.data,console.log("从嵌套data字段获取用户数据:",r);else{if(!t.id)throw console.error("获取用户信息响应格式异常:",t),new Error("用户信息格式异常");r=t,console.log("直接获取用户数据:",r)}if(!r||!r.id)throw console.error("获取的用户数据无效:",r),new Error("无效的用户数据");return a.value=r,localStorage.setItem("user",JSON.stringify(r)),console.log("用户数据已更新:",a.value),r}catch(e){return console.error("获取当前用户信息失败:",e),$e["a"].error("获取用户信息失败: "+(e.message||"未知错误")),null}},S=async(e=!1)=>{try{e||(m.value=!0),console.log("正在加载聊天会话列表...");const t=await Object(ze["h"])();if(console.log("获取聊天会话响应:",t),!t)return console.error("获取聊天会话返回空响应"),void(y.value=[]);let r;t.success&&t.data?(r=t.data,console.log("使用包装格式的聊天数据:",r)):(r=t,console.log("使用直接返回的聊天数据:",r)),b.value=r,r&&Array.isArray(r.results)?(console.log("处理分页数据结构, 共有会话数:",r.results.length),y.value=r.results.map(e=>{let t=null;if(e.participants&&Array.isArray(e.participants)&&(t=a.value&&a.value.id?e.participants.find(e=>e.user&&e.user.id!==a.value.id):e.participants[0]),e.is_group)return{id:e.id,name:e.title||"群聊",initial:(e.title||"群聊")[0],avatar:"",avatar_url:"",color:X(e.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:!0};if(t){const a=t.user;let r="";if(a.avatar){const e=a.avatar;r=e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("/")?`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${e}`:`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${e}`}return{id:e.id,userId:a.id,name:(a.name||((a.first_name||"")+" "+(a.last_name||"")).trim()||a.username||"未命名联系人").trim(),initial:(a.name||a.first_name||a.username||"未命名联系人")[0],avatar:a.avatar||"",avatar_url:r,color:X(a.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:!1,department:a.department||"其他"}}return{id:e.id,name:e.title||"聊天",initial:(e.title||"聊天")[0],avatar:"",avatar_url:"",color:X(e.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:e.is_group,department:"其他"}})):r&&Array.isArray(r)?(console.log("处理非分页数据结构, 共有会话数:",r.length),y.value=r.map(e=>{let t=null;if(e.participants&&Array.isArray(e.participants)&&(t=a.value&&a.value.id?e.participants.find(e=>e.user&&e.user.id!==a.value.id):e.participants[0]),e.is_group)return{id:e.id,name:e.title||"群聊",initial:(e.title||"群聊")[0],avatar:"",avatar_url:"",color:X(e.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:!0};if(t){const a=t.user;let r="";if(a.avatar){const e=a.avatar;r=e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("/")?`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${e}`:`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${e}`}return{id:e.id,name:(a.name||((a.first_name||"")+" "+(a.last_name||"")).trim()||a.username||"未命名联系人").trim(),initial:(a.name||a.first_name||a.username||"未命名联系人")[0],avatar:a.avatar||"",avatar_url:r,color:X(a.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:!1,department:a.department||"其他"}}return{id:e.id,name:e.title||"聊天",initial:(e.title||"聊天")[0],avatar:"",avatar_url:"",color:X(e.id),status:"online",lastMessage:e.last_message?e.last_message.content:"",lastTime:e.last_message?Z(e.last_message.created_at):Z(e.updated_at),unread:e.unread_count,isGroup:e.is_group,department:"其他"}})):(console.error("获取聊天会话格式异常或为空:",r),y.value=[]),console.log("处理后的联系人列表:",y.value),y.value.length>0&&y.value.sort((e,t)=>t.unread-e.unread)}catch(t){console.error("加载聊天会话失败:",t),$e["a"].error("加载聊天会话失败: "+(t.message||"未知错误")),y.value=[]}finally{e||(m.value=!1)}},A=async(e,t=!1)=>{if(e)try{t||(p.value=!0),console.log(`正在加载聊天会话 ${e} 的消息...`);const o=await Object(ze["g"])(e);if(console.log("聊天会话详情响应:",o),!o)return console.error("获取聊天会话详情返回空响应"),void(u.value=[]);let l=[],s=null;if(o.data&&o.data.messages)l=o.data.messages,s=o.data,console.log("标准格式消息数据，消息数量:",l.length);else if(o.data&&o.data.data&&o.data.data.messages)l=o.data.data.messages,s=o.data.data,console.log("包装格式消息数据，消息数量:",l.length);else if(o.messages)l=o.messages,s=o,console.log("直接返回格式消息数据，消息数量:",l.length);else{console.warn("无法识别的消息数据格式:",o),console.log("尝试检查是否有其他可能的消息字段...");const e=["message","chat_messages","chats","content"];for(const t of e){if(o[t]&&Array.isArray(o[t])){console.log(`找到可能的消息字段 ${t}，使用此字段数据`),l=o[t],s=o;break}if(o.data&&o.data[t]&&Array.isArray(o.data[t])){console.log(`在data字段中找到可能的消息字段 ${t}，使用此字段数据`),l=o.data[t],s=o.data;break}}0===l.length&&console.warn("未找到任何消息数据，使用空数组")}if(l.forEach(e=>{if(e.sender&&e.sender.avatar){const t=e.sender.avatar;t.startsWith("http://")||t.startsWith("https://")?e.sender.avatar_url=t:t.startsWith("/")?e.sender.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${t}`:e.sender.avatar_url=`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${t}`}}),console.log("处理后的会话数据:",s),console.log("处理后的消息数据:",l),s&&!y.value.some(t=>t.id===parseInt(e))){console.log("会话不在联系人列表中，添加它:",s);const t=s;let r=null;t.participants&&Array.isArray(t.participants)&&t.participants.length>0&&a.value&&(r=t.participants.find(e=>e.user&&e.user.id!==a.value.id));let n=null;if(t.is_group)n={id:parseInt(e),name:t.title||"群聊",initial:(t.title||"群聊")[0],avatar:"",avatar_url:"",color:X(parseInt(e)),status:"online",lastMessage:t.last_message?t.last_message.content:"",lastTime:Z(t.updated_at),unread:0,isGroup:!0};else if(r&&r.user){const a=r.user;let o="";if(a.avatar){const e=a.avatar;o=e.startsWith("http://")||e.startsWith("https://")?e:e.startsWith("/")?`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}${e}`:`${Object({NODE_ENV:"production",BASE_URL:"/"}).VUE_APP_BASE_API||"http://localhost:8000"}/${e}`}n={id:parseInt(e),name:(a.name||((a.first_name||"")+" "+(a.last_name||"")).trim()||a.username||"未命名联系人").trim(),initial:(a.name||a.first_name||a.username||"未命名联系人")[0],avatar:a.avatar||"",avatar_url:o,color:X(a.id),status:"online",lastMessage:t.last_message?t.last_message.content:"",lastTime:Z(t.updated_at),unread:0,isGroup:!1}}else n={id:parseInt(e),name:t.title||"聊天",initial:(t.title||"聊天")[0],avatar:"",avatar_url:"",color:X(parseInt(e)),status:"online",lastMessage:"",lastTime:Z(t.updated_at),unread:0,isGroup:t.is_group};n&&(y.value.unshift(n),console.log("添加临时联系人:",n))}u.value=l||[],g.value=parseInt(e),c.value=parseInt(e);try{const t=await Object(Ye["a"])({url:"/api/ai/documents/",method:"get",params:{chat:e}});t&&t.data&&Array.isArray(t.data.results)&&(ce.value=t.data.results.map(e=>e.id),console.log("当前会话文档ID:",ce.value))}catch(n){ce.value=[]}Object(r["nextTick"])(()=>{M()})}catch(o){console.error("加载会话详情失败:",o);let e="加载聊天消息失败";if(o.response){const t=o.response.status;404===t?e="聊天会话不存在或已被删除":403===t?e="无权访问此聊天会话":o.response.data&&o.response.data.message&&(e=o.response.data.message)}else o.message&&(e=o.message);$e["a"].error(e),u.value=[]}finally{t||(p.value=!1)}else console.error("无法加载消息: chatId为空")},I=async()=>{if(await ne(),await oe(),await S(),g.value){const e=y.value.find(e=>e.id===g.value);e&&(c.value=e.id)}},M=()=>{s.value&&(s.value.scrollTop=s.value.scrollHeight)},T=async e=>{if(!e.isGroup&&a.value&&e.userId===a.value.id)return void $e["a"].warning("不能与自己聊天");console.log("选择联系人:",e);let t=e.id;if("string"===typeof t&&t.startsWith("user_")){let a=e.userId||e.id.replace("user_","");console.log("尝试查找与用户的现有对话:",a);const r=y.value.find(e=>!e.isGroup&&(e.userId&&e.userId==a||e.user&&e.user.id==a));if(r)console.log("找到与用户的现有对话:",r),t=r.id;else{console.log("未找到与用户的现有对话，创建新对话");try{const r=await Object(Ye["a"])({url:"/api/chat/sessions/",method:"post",data:{participant_ids:[a],is_group:!1}});console.log("创建会话响应:",r);let n=null;if(r&&r.data?n=r.data:r&&r.id&&(n=r),!n||!n.id)throw new Error("创建会话返回无效数据");{const r={id:n.id,userId:a,name:e.name,initial:e.initial,avatar:e.avatar,avatar_url:e.avatar_url||"",color:e.color||X(a),status:"online",lastMessage:"",lastTime:Z(new Date),unread:0,isGroup:!1,department:e.department};y.value.unshift(r),t=n.id,$e["a"].success("已创建新的对话")}}catch(n){return console.error("创建新会话失败:",n),void $e["a"].error("无法创建新对话: "+(n.message||"未知错误"))}}}c.value=t,l.value="",u.value=[];try{await A(t),Object(r["nextTick"])(()=>{M()})}catch(n){console.error("加载聊天消息失败:",n),$e["a"].error("无法加载对话内容："+(n.message||"未知错误"))}};Object(r["watch"])(u,()=>{Object(r["nextTick"])(()=>{M()})});const U=async()=>{if(l.value.trim()&&g.value)try{if(console.log("发送消息时文档IDs:",ce.value),!a.value||!a.value.id){const e=await B();if(!e||!e.id)throw new Error("无法获取当前用户信息，请刷新页面重试")}const e={id:"temp-"+Date.now(),content:l.value.trim(),sender:{id:a.value.id,username:a.value.username||"用户",first_name:a.value.first_name||"",last_name:a.value.last_name||""},message_type:"text",created_at:(new Date).toISOString(),is_temp:!0};u.value.push(e);const t=l.value;let n,o;if(l.value="",await Object(r["nextTick"])(),M(),ce.value&&ce.value.length>0){n=await Object(Re["a"])({message:t,chat_id:g.value,document_ids:ce.value});let a="";if(n&&"string"===typeof n.data?a=n.data:n&&n.data&&n.data.message&&(a=n.data.message),a){o={id:"ai-"+Date.now(),content:a,sender:{id:0,username:"AI助手"},message_type:"text",created_at:(new Date).toISOString()};const t=u.value.findIndex(t=>t.id===e.id);-1!==t?u.value.splice(t,1,o):u.value.push(o)}}else{n=await Object(ze["l"])({chat:g.value,content:t});let r=null;n&&n.success&&n.data?r=n.data:n&&n.id?r=n:n&&n.chat&&(r={id:n.id||"msg-"+Date.now(),content:n.content,message_type:n.message_type,file:n.file,created_at:n.created_at||(new Date).toISOString(),sender:{id:a.value.id,username:a.value.username||"用户",first_name:a.value.first_name||"",last_name:a.value.last_name||""}});const o=u.value.findIndex(t=>t.id===e.id);-1!==o&&r?u.value.splice(o,1,r):r&&u.value.push(r)}await Object(r["nextTick"])(),M()}catch(e){console.error("发送消息失败:",e),u.value=u.value.filter(e=>!e.is_temp),l.value=e.savedMessage||l.value,$e["a"].error("发送消息失败，请重试")}},$=()=>{i.value.click()},P=()=>{d.value.click()},F=Object(r["ref"])(!1),z=Object(r["ref"])(!1),L=async e=>{const t=e.target.files[0];if(t&&g.value)try{F.value=!0,await Object(ze["i"])(g.value,"发送文件: "+t.name,t);const a=new FormData;a.append("file",t),a.append("chat",g.value),await Object(Ye["a"])({url:"/api/ai/documents/upload/",method:"post",data:a,headers:{"Content-Type":"multipart/form-data"}});const r=await Object(Ye["a"])({url:"/api/ai/documents/",method:"get",params:{chat:g.value}});r&&r.data&&Array.isArray(r.data.results)&&(ce.value=r.data.results.map(e=>e.id),console.log("上传后刷新文档IDs:",ce.value)),$e["a"].success("文件发送成功"),A(g.value,!0),e.target.value=""}catch(a){console.error("发送文件失败:",a),$e["a"].error("发送文件失败")}finally{F.value=!1}},Y=async e=>{const t=e.target.files[0];if(t&&g.value)try{if(!t.type.startsWith("image/"))return $e["a"].error("只能上传图片文件"),void(e.target.value="");const a=10485760;if(t.size>a)return $e["a"].error("图片大小不能超过10MB"),void(e.target.value="");z.value=!0,console.log("准备发送图片，聊天ID:",g.value,"文件:",t.name,"大小:",t.size),await Object(ze["j"])(g.value,"发送图片",t),A(g.value,!0),e.target.value=""}catch(a){console.error("发送图片失败:",a);let t="发送图片失败";a.response&&(console.error("错误状态码:",a.response.status),console.error("错误详情:",a.response.data),a.response.data&&a.response.data.error?t=a.response.data.error:a.response.data&&"string"===typeof a.response.data?t=a.response.data:413===a.response.status&&(t="图片太大，服务器拒绝接收")),$e["a"].error(t),e.target.value=""}finally{z.value=!1}},R=async()=>{O.value=!0,await H()},H=async()=>{try{j.value=!0;const{data:e}=await Object(Le["j"])();v.value=e}catch(e){console.error("加载知识库列表失败:",e),$e["a"].error("加载知识库列表失败")}finally{j.value=!1}},q=e=>{f.value=e},G=async e=>{if(g.value)try{await Object(ze["k"])(g.value,"分享知识库文件: "+e.title,e.id),O.value=!1,A(g.value,!0)}catch(t){console.error("分享知识库文件失败:",t),$e["a"].error("分享知识库文件失败")}},W=async e=>{try{const t=await Object(ze["d"])(e.id),a=window.URL.createObjectURL(new Blob([t.data])),r=document.createElement("a");r.href=a,r.setAttribute("download",e.file_name||"download"),document.body.appendChild(r),r.click(),document.body.removeChild(r)}catch(t){console.error("下载文件失败:",t),$e["a"].error("下载文件失败")}},K=e=>{e.knowledge_detail&&Pe["a"].alert(`标题: ${e.knowledge_detail.title}<br>描述: ${e.knowledge_detail.description||"无"}`,"知识库文件",{dangerouslyUseHTMLString:!0,confirmButtonText:"确定"})},J=e=>X(e.id),Q=e=>(e.first_name||e.username)[0],X=e=>{const t=["#007bff","#28a745","#dc3545","#fd7e14","#6f42c1","#20c997","#17a2b8","#6c757d"],a="number"===typeof e?e%t.length:0;return t[a]},Z=e=>{if(!e)return"";const t=new Date(e),a=new Date,r=a-t;if(r<864e5){const e=t.getHours().toString().padStart(2,"0"),a=t.getMinutes().toString().padStart(2,"0");return`${e}:${a}`}if(r<6048e5){const e=["周日","周一","周二","周三","周四","周五","周六"];return e[t.getDay()]}return`${t.getMonth()+1}月${t.getDate()}日`},ee=e=>{if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}-${t.getDate().toString().padStart(2,"0")}`},te=e=>e<1024?e+" KB":(e/1024).toFixed(2)+" MB",ae=e=>{const t={online:"在线",offline:"离线",busy:"忙碌",away:"离开"};return t[e]||e},re=async()=>{try{$e["a"].info("正在强制刷新数据...");const e=await B();if(!e)return void $e["a"].error("无法获取用户信息，请尝试重新登录");await S(),0===y.value.length?$e["a"].warning("未找到任何聊天会话，您可能还没有开始任何对话"):$e["a"].success("刷新成功！找到 "+y.value.length+" 个聊天会话")}catch(e){console.error("强制刷新失败:",e),$e["a"].error("刷新失败: "+(e.message||"未知错误"))}},ne=async()=>{try{if(console.log("正在加载所有用户列表..."),!a.value||!a.value.company){console.error("无法加载同事列表：缺少用户或公司信息。");const e=await B();if(!e||!e.company)return $e["a"].error("无法获取您的公司信息，无法加载同事列表。"),void(w.value=[])}const e=a.value.company;console.log("开始获取公司同事列表，公司ID:",e);const t=await Object(Ye["a"])({url:"/api/auth/contacts/",method:"get",params:{company:e}});console.log("公司同事列表API响应:",t);let r=[];t&&t.success&&Array.isArray(t.data)||t&&Array.isArray(t.data)?r=t.data:t&&Array.isArray(t)?r=t:console.warn("获取同事列表的响应格式未知或数据为空:",t),r.length>0?(console.log(`成功获取到 ${r.length} 个同事`),w.value=r.map(e=>({id:e.id,username:e.username,name:e.name,department:e.department,avatar:e.avatar_url||e.avatar}))):w.value=[]}catch(e){console.error("加载公司同事列表过程中出错:",e),$e["a"].error("加载同事列表失败，请稍后重试。"),w.value=[]}},oe=async()=>{try{console.log("正在加载部门列表...");const e=await Object(Ye["a"])({url:"/api/auth/departments/",method:"get"});console.log("获取部门响应:",e);let t=[];e&&e.results?t=e.results:Array.isArray(e)?t=e:e&&e.data&&(Array.isArray(e.data)?t=e.data:e.data.results&&(t=e.data.results)),t&&t.length>0&&(console.log(`成功获取到${t.length}个部门`),V.value=t)}catch(e){console.error("获取部门列表失败:",e)}},ce=Object(r["ref"])([]),le=Object(r["ref"])(!1),se=Object(r["ref"])([new Date((new Date).setDate((new Date).getDate()-7)),new Date]),ie=Object(r["ref"])(""),de=Object(r["ref"])(!1),ue=Object(r["ref"])({shortcuts:[{text:"最近一周",onClick(e){const t=new Date,a=new Date;a.setTime(a.getTime()-6048e5),e.$emit("pick",[a,t])}},{text:"最近一个月",onClick(e){const t=new Date,a=new Date;a.setTime(a.getTime()-2592e6),e.$emit("pick",[a,t])}},{text:"最近三个月",onClick(e){const t=new Date,a=new Date;a.setTime(a.getTime()-7776e6),e.$emit("pick",[a,t])}}]}),me=()=>{ie.value="",le.value=!0},pe=()=>{le.value=!1},be=async()=>{if(!c.value)return void $e["a"].warning("请先选择一个聊天");if(!se.value||2!==se.value.length)return void $e["a"].warning("请选择一个有效的时间范围");de.value=!0,ie.value="";const[e,t]=se.value;try{const a=await Object(ze["m"])(c.value,e.toISOString(),t.toISOString()),r=a.data.summary;ie.value=r||"在选定时间范围内没有可总结的消息，或AI未能生成摘要。"}catch(a){console.error("Summarization error:",a),ie.value="生成摘要时遇到错误，请检查后台日志或稍后再试。",$e["a"].error("生成摘要失败，请稍后再试")}finally{de.value=!1}},ge=Object(r["ref"])(null),Oe=e=>{ge.value=e},je=e=>{if(!e)return"";const t=e.lastIndexOf(".");return-1===t||0===t?e:e.substring(0,t)},ve=e=>{if(!e)return"";const t=e.lastIndexOf(".");return-1===t||0===t||t>=e.length-1?"":e.substring(t)},fe=Object(r["ref"])(!1),he=Object(r["ref"])({top:"0px",left:"0px"}),ye=Object(r["ref"])(null),we=(e,t)=>{e.preventDefault(),he.value={top:e.clientY+"px",left:e.clientX+"px"},ye.value=t,fe.value=!0,document.addEventListener("click",Ve,{once:!0})},Ve=()=>{fe.value=!1},_e=()=>{if(!ye.value)return;const e=ye.value.content||"";navigator.clipboard.writeText(e).then(()=>{$e["a"].success("内容已复制到剪贴板"),Ve()}).catch(e=>{$e["a"].error("复制失败: "+e)})},ke=Object(r["ref"])(!1),Ce=Object(r["ref"])(!1),Ne=Object(r["ref"])(!1),Ee=Object(r["ref"])(null),De=Object(r["reactive"])({title:"",start:"",end:"",location:"",type:"blue",reminder:"30min",description:""}),xe=Object(r["reactive"])({title:[{required:!0,message:"请输入日程标题",trigger:"blur"}],start:[{required:!0,message:"请选择开始时间",trigger:"change"}],end:[{required:!0,message:"请选择结束时间",trigger:"change"}],location:[{required:!0,message:"请输入地点",trigger:"blur"}],type:[{required:!0,message:"请选择日程类型",trigger:"change"}],reminder:[{required:!0,message:"请选择提醒时间",trigger:"change"}],description:[{required:!0,message:"请输入描述信息",trigger:"blur"}]}),Be=(e,t,a)=>{if(t)if(De.start){const e=new Date(De.start),r=new Date(t);r<=e?a(new Error("结束时间必须晚于开始时间")):e.toDateString()!==r.toDateString()?a(new Error("开始和结束时间必须是同一天")):a()}else a();else a()};Object(r["watch"])(()=>De.start,e=>{e&&Ee.value&&Ee.value.validateField("end")}),xe.end=[{required:!0,message:"请选择结束时间",trigger:"change"},{validator:Be,trigger:"change"}];const Se=async()=>{if(ye.value){Ce.value=!0,ke.value=!0;try{var e;const t=ye.value.content,a=await Object(ze["a"])(t);console.log("AI日程分析响应:",a);const r=(null===a||void 0===a||null===(e=a.data)||void 0===e?void 0:e.data)||(null===a||void 0===a?void 0:a.data);r&&"object"===typeof r?(console.log("AI成功识别日程数据:",r),De.title=r.title||"",De.start=r.start||ee(new Date,"YYYY-MM-DD HH:mm:ss"),De.end=r.end||ee(new Date(Date.now()+36e5),"YYYY-MM-DD HH:mm:ss"),De.location=r.location||"",De.type=r.type||"blue",De.reminder=r.reminder||"30min",De.description=r.description||t||"",De.is_all_day=r.is_all_day||!1,r.participants&&Array.isArray(r.participants)?De.participants=r.participants:De.participants=k.value?[k.value]:[]):(console.error("AI分析未能返回有效的日程数据。",a),$e["a"].warning("AI未能自动识别日程，请手动填写。"),De.title="",De.start=ee(new Date,"YYYY-MM-DD HH:mm:ss"),De.end=ee(new Date(Date.now()+36e5),"YYYY-MM-DD HH:mm:ss"),De.location="",De.type="blue",De.reminder="30min",De.description=t||"",De.is_all_day=!1)}catch(a){var t;console.error("获取日程信息失败:",a),$e["a"].error("AI分析失败，请手动填写日程。"),De.title="",De.start=ee(new Date,"YYYY-MM-DD HH:mm:ss"),De.end=ee(new Date(Date.now()+36e5),"YYYY-MM-DD HH:mm:ss"),De.location="",De.type="blue",De.reminder="30min",De.description=(null===(t=ye.value)||void 0===t?void 0:t.content)||"",De.is_all_day=!1}finally{Ce.value=!1,Ve()}}else $e["a"].warning("无法识别消息")},Ae=async()=>{Ee.value&&await Ee.value.validate(async e=>{if(!e)return $e["a"].error("请填写所有必填项"),!1;Ne.value=!0;try{const e={...De};e.participants||(e.participants=[]),k.value&&!e.participants.includes(k.value)&&e.participants.push(k.value),await Object(ze["b"])(e),$e["a"].success("日程添加成功"),ke.value=!1}catch(r){var t,a;$e["a"].error("添加日程失败: "+((null===(t=r.response)||void 0===t||null===(a=t.data)||void 0===a?void 0:a.error)||r.message))}finally{Ne.value=!1}})};return Object(r["onMounted"])(()=>{document.addEventListener("click",e=>{if(fe.value){const t=document.querySelector(".chat-context-menu");t&&!t.contains(e.target)&&(fe.value=!1)}})}),{searchQuery:n,activeTab:o,selectedContact:c,tabs:h,contacts:y,currentContact:_,filteredContacts:C,messages:u,messageInput:l,messageContainer:s,fileInput:i,imageInput:d,currentUser:t,userInfo:a,userId:k,knowledgeDialogVisible:O,knowledgeLoading:j,knowledgeList:v,sessionsLoading:m,messagesLoading:p,Search:Fe["Search"],Document:Fe["Document"],PictureFilled:Fe["PictureFilled"],FolderOpened:Fe["FolderOpened"],Microphone:Fe["Microphone"],Position:Fe["Position"],ChatDotSquare:Fe["ChatDotSquare"],Reading:Fe["Reading"],UserFilled:Fe["UserFilled"],ChatLineSquare:Fe["ChatLineSquare"],Refresh:Fe["Refresh"],sendMessage:U,getStatusText:ae,selectContact:T,openFileUpload:$,openImageUpload:P,handleFileUpload:L,handleImageUpload:Y,openKnowledgeDialog:R,selectKnowledge:q,shareKnowledge:G,downloadFile:W,viewKnowledge:K,getSenderColor:J,getSenderInitial:Q,formatMessageTime:Z,formatDate:ee,formatFileSize:te,refreshChatSessions:I,forceRefresh:re,groupedUsersByDepartment:E,getActiveContacts:N,loadAllUsers:ne,loadDepartments:oe,selectedDocumentIds:ce,fileUploading:F,imageUploading:z,summaryDialogVisible:le,summaryDateRange:se,summaryContent:ie,summaryLoading:de,pickerOptions:ue,openSummaryDialog:me,handleCloseSummaryDialog:pe,handleSummarize:be,expandedImage:ge,toggleImageExpand:Oe,getFileName:je,getFileExtension:ve,contextMenuVisible:fe,contextMenuStyle:he,openContextMenu:we,copyMessageContent:_e,addToCalendarFromMessage:Se,calendarDialogVisible:ke,calendarEvent:De,isAnalyzing:Ce,isSubmitting:Ne,submitCalendarEvent:Ae,calendarFormRef:Ee,calendarRules:xe}}},qe=(a("2056"),a("6b0d")),Ge=a.n(qe);const We=Ge()(He,[["render",Me],["__scopeId","data-v-67a25b4b"]]);t["default"]=We},2056:function(e,t,a){"use strict";a("7ce3")},"271a":function(e,t,a){"use strict";var r=a("cb2d"),n=a("e330"),o=a("577e"),c=a("d6d6"),l=URLSearchParams,s=l.prototype,i=n(s.getAll),d=n(s.has),u=new l("a=1");!u.has("a",2)&&u.has("a",void 0)||r(s,"has",(function(e){var t=arguments.length,a=t<2?void 0:arguments[1];if(t&&void 0===a)return d(this,e);var r=i(this,e);c(t,1);var n=o(a),l=0;while(l<r.length)if(r[l++]===n)return!0;return!1}),{enumerable:!0,unsafe:!0})},"48cf":function(e,t,a){"use strict";a.d(t,"f",(function(){return n})),a.d(t,"g",(function(){return o})),a.d(t,"a",(function(){return c})),a.d(t,"b",(function(){return l})),a.d(t,"e",(function(){return s})),a.d(t,"d",(function(){return i})),a.d(t,"c",(function(){return d}));a("d9e2");var r=a("b775");function n(){return Object(r["a"])({url:"/api/ai/schedule-reminder/",method:"get"})}function o(e){return Object(r["a"])({url:`/api/ai/recommendations/${e}/mark_as_read/`,method:"post"})}function c(e){return Object(r["a"])({url:"/api/ai/chat-with-documents/",method:"post",data:e,responseType:"text"})}function l(e,t,a,r){const n=new AbortController,o=n.signal,c=localStorage.getItem("token"),l={"Content-Type":"application/json"};return c&&(l["Authorization"]="Bearer "+c),fetch("http://localhost:8000/api/ai/chat-with-documents/",{method:"POST",headers:l,body:JSON.stringify(e),signal:o}).then(async e=>{if(!e.ok){const t=await e.json().catch(()=>({message:"服务返回了错误状态，且响应体不是有效的JSON。"}));throw new Error(t.message||"HTTP error! Status: "+e.status)}const n=e.body.getReader(),o=new TextDecoder("utf-8");let c="",l=null;const s=async()=>{while(1){const{done:s,value:i}=await n.read();if(s){c&&console.error("Stream finished but buffer is not empty:",c),a&&a(l);break}c+=o.decode(i,{stream:!0});const d=c.split("\n");c=d.pop();for(const n of d)if(n.startsWith("data:")){const o=n.substring(5).trim();if("[DONE]"===o)return void(a&&a(l));try{const e=JSON.parse(o);t&&t(e,e.chat_id),("session_id"===e.type||e.chat_id)&&(l=e.chat_id)}catch(e){console.error("无法解析JSON流: ",o,e),r&&r(new Error("无法解析服务器发送的数据"))}}}};s().catch(e=>{console.error("An error occurred while processing the stream:",e),r&&r(e)})}).catch(e=>{"AbortError"!==e.name&&(console.error("Fetch request failed:",e),r&&r(e))}),n}function s(){return Object(r["a"])({url:"/api/ai/chats/",method:"get"})}function i(e){return Object(r["a"])({url:`/api/ai/chats/${e}/`,method:"get"})}function d(e){return Object(r["a"])({url:`/api/ai/chats/${e}/`,method:"delete"})}},5494:function(e,t,a){"use strict";var r=a("83ab"),n=a("e330"),o=a("edd0"),c=URLSearchParams.prototype,l=n(c.forEach);r&&!("size"in c)&&o(c,"size",{get:function(){var e=0;return l(this,(function(){e++})),e},configurable:!0,enumerable:!0})},"7ce3":function(e,t,a){},"88a7":function(e,t,a){"use strict";var r=a("cb2d"),n=a("e330"),o=a("577e"),c=a("d6d6"),l=URLSearchParams,s=l.prototype,i=n(s.append),d=n(s["delete"]),u=n(s.forEach),m=n([].push),p=new l("a=1&a=2&b=3");p["delete"]("a",1),p["delete"]("b",void 0),p+""!=="a=2"&&r(s,"delete",(function(e){var t=arguments.length,a=t<2?void 0:arguments[1];if(t&&void 0===a)return d(this,e);var r=[];u(this,(function(e,t){m(r,{key:t,value:e})})),c(t,1);var n,l=o(e),s=o(a),p=0,b=0,g=!1,O=r.length;while(p<O)n=r[p++],g||n.key===l?(g=!0,d(this,n.key)):b++;while(b<O)n=r[b++],n.key===l&&n.value===s||i(this,n.key,n.value)}),{enumerable:!0,unsafe:!0})},"910d":function(e,t,a){"use strict";var r=a("23e7"),n=a("c65b"),o=a("59ed"),c=a("825a"),l=a("46c4"),s=a("c5cc"),i=a("9bdd"),d=a("c430"),u=a("2a62"),m=a("f99f"),p=!d&&m("filter",TypeError),b=s((function(){var e,t,a,r=this.iterator,o=this.predicate,l=this.next;while(1){if(e=c(n(l,r)),t=this.done=!!e.done,t)return;if(a=e.value,i(r,o,[a,this.counter++],!0))return a}}));r({target:"Iterator",proto:!0,real:!0,forced:d||p},{filter:function(e){c(this);try{o(e)}catch(t){u(this,"throw",t)}return p?n(p,this,e):new b(l(this),{predicate:e})}})},c466:function(e,t,a){"use strict";function r(e){if(!e)return"";if(!(e instanceof Date)&&(e=new Date(e),isNaN(e.getTime())))return"无效日期";const t=new Date,a=t.getTime()-e.getTime(),r=Math.floor(a/1e3),n=Math.floor(r/60),o=Math.floor(n/60),c=Math.floor(o/24),l=Math.floor(c/30),s=Math.floor(l/12);return r<60?"刚刚":n<60?n+"分钟前":o<24?o+"小时前":c<30?c+"天前":l<12?l+"个月前":s+"年前"}a.d(t,"a",(function(){return r}))},d6d6:function(e,t,a){"use strict";var r=TypeError;e.exports=function(e,t){if(e<t)throw new r("Not enough arguments");return e}},d800:function(e,t,a){"use strict";a.d(t,"h",(function(){return n})),a.d(t,"g",(function(){return o})),a.d(t,"c",(function(){return c})),a.d(t,"l",(function(){return l})),a.d(t,"i",(function(){return s})),a.d(t,"j",(function(){return i})),a.d(t,"k",(function(){return d})),a.d(t,"d",(function(){return u})),a.d(t,"e",(function(){return m})),a.d(t,"f",(function(){return p})),a.d(t,"m",(function(){return b})),a.d(t,"a",(function(){return g})),a.d(t,"b",(function(){return O}));a("d9e2");var r=a("b775");function n(){return Object(r["a"])({url:"/api/chat/sessions/",method:"get"})}function o(e){return Object(r["a"])({url:`/api/chat/sessions/${e}/`,method:"get"})}function c(e){return Object(r["a"])({url:"/api/chat/sessions/",method:"post",data:e})}function l(e){return Object(r["a"])({url:"/api/chat/messages/",method:"post",data:{...e,message_type:"text"}})}function s(e,t,a){const n=new FormData;return n.append("chat",e),n.append("message_type","file"),n.append("content",t),n.append("file",a),Object(r["a"])({url:"/api/chat/messages/",method:"post",data:n})}function i(e,t,a){const n=new FormData;return n.append("chat",e),n.append("message_type","image"),n.append("content",t),n.append("file",a),Object(r["a"])({url:"/api/chat/messages/",method:"post",data:n})}function d(e){return Object(r["a"])({url:"/api/chat/messages/",method:"post",data:{...e,message_type:"knowledge",content:"分享了一个知识库文件"}})}function u(e){return Object(r["a"])({url:`/api/chat/messages/${e}/download/`,method:"get",responseType:"blob"})}function m(e){return Object(r["a"])({url:"/api/chat/find-or-create/",method:"post",data:{user_id:e}})}async function p(e){if(!e||0===e.length)throw new Error("No user IDs provided");return 1===e.length?m(e[0]):c({participants:e})}function b(e,t,a){return Object(r["a"])({url:`/api/chat/sessions/${e}/summarize/`,method:"post",data:{start_date:t,end_date:a}})}function g(e){return Object(r["a"])({url:"/api/chat/analyze-for-calendar/",method:"post",data:{content:e}})}function O(e){return Object(r["a"])({url:"/api/calendar/events/",method:"post",data:e})}},db6a:function(e,t,a){"use strict";a.d(t,"f",(function(){return o})),a.d(t,"a",(function(){return c})),a.d(t,"k",(function(){return l})),a.d(t,"c",(function(){return s})),a.d(t,"h",(function(){return i})),a.d(t,"m",(function(){return d})),a.d(t,"l",(function(){return u})),a.d(t,"d",(function(){return m})),a.d(t,"e",(function(){return p})),a.d(t,"g",(function(){return b})),a.d(t,"b",(function(){return g})),a.d(t,"i",(function(){return O})),a.d(t,"j",(function(){return j}));a("d9e2");var r=a("b775");const n="/api/knowledge";function o(){return console.log("调用getCategories API函数"),Object(r["a"])({url:n+"/categories/",method:"get"}).then(e=>{if(console.log("getCategories API响应成功:",e),!e)return console.warn("getCategories响应为空，返回空数组"),[];if(Array.isArray(e))return e;if(e.results&&Array.isArray(e.results))return e.results;if(e.data&&Array.isArray(e.data))return e.data;if("object"===typeof e)for(const t of["items","categories","list"])if(e[t]&&Array.isArray(e[t]))return e[t];return console.warn("无法从响应中提取分类数据，返回空数组:",e),[]}).catch(e=>(console.error("getCategories API请求失败:",e),e.response&&(console.error("错误状态码:",e.response.status),console.error("错误数据:",e.response.data)),[]))}function c(e){return Object(r["a"])({url:n+"/categories/",method:"post",data:e})}function l(e,t){return Object(r["a"])({url:`${n}/categories/${e}/`,method:"put",data:t})}function s(e){return Object(r["a"])({url:`${n}/categories/${e}/`,method:"delete"})}function i(e){return console.log("调用getDocuments API:",n+"/documents/","参数:",e),Object(r["a"])({url:n+"/documents/",method:"get",params:e}).then(e=>(console.log("getDocuments API响应成功:",e),e)).catch(e=>{throw console.error("getDocuments API请求失败:",e),e.response&&(console.error("错误状态码:",e.response.status),console.error("错误数据:",e.response.data)),e})}function d(e){if(console.log("开始上传文件...",e),e instanceof FormData){const t=e.get("file");if(!t)return console.warn("FormData中未找到文件!"),Promise.reject(new Error("未找到有效文件"));if(console.log("FormData中的文件信息:",{name:t.name,size:t.size,type:t.type,lastModified:t.lastModified}),!t.size||0===t.size)return Promise.reject(new Error("文件大小为0，无法上传"))}return Object(r["a"])({url:n+"/documents/",method:"post",data:e,timeout:12e4,headers:{"Content-Type":"multipart/form-data"},onUploadProgress:e=>{const t=Math.round(100*e.loaded/e.total);console.log(`上传进度: ${t}%`)}}).then(e=>(console.log("文件上传成功响应:",e),e)).catch(e=>{throw console.error("文件上传失败:",e),e.response?(console.error("上传错误状态码:",e.response.status),console.error("上传错误数据:",e.response.data),413===e.response.status?e.message="文件太大，超出服务器允许的上传限制":400===e.response.status?e.message="上传参数错误: "+JSON.stringify(e.response.data):401===e.response.status?e.message="未授权，请重新登录后再尝试上传":500===e.response.status&&(e.message="服务器处理上传时发生错误")):e.request&&(console.error("没有收到上传响应:",e.request),"ECONNABORTED"===e.code?e.message="上传超时，请检查网络或尝试上传较小的文件":e.message="网络错误，未收到服务器响应"),e})}function u(e,t){return Object(r["a"])({url:`${n}/documents/${e}/`,method:"put",data:t})}function m(e){console.log(">>> deleteDocument function entered for ID:",e);const t={url:`${n}/documents/${e}/`,method:"delete"};return console.log(">>> deleteDocument - Request config prepared:",t),Object(r["a"])(t).then(e=>(console.log("deleteDocument API响应成功:",e),e)).catch(e=>{throw console.error("deleteDocument API请求失败:",e),e.response&&(console.error("错误状态码:",e.response.status),console.error("错误数据:",e.response.data)),e})}function p(e){return Object(r["a"])({url:`${n}/documents/${e}/`,method:"get",responseType:"blob"})}function b(e){return Object(r["a"])({url:`${n}/documents/${e}/chunks/`,method:"get"})}function g(){return console.log("调用buildKnowledgeBase API"),Object(r["a"])({url:n+"/build/",method:"post"}).then(e=>(console.log("buildKnowledgeBase API响应成功:",e),e)).catch(e=>{throw console.error("buildKnowledgeBase API请求失败:",e),e.response&&(console.error("错误状态码:",e.response.status),console.error("错误数据:",e.response.data)),e})}function O(){return Object(r["a"])({url:n+"/build/status/",method:"get"})}function j(){return Object(r["a"])({url:n+"/list/",method:"get"})}},f665:function(e,t,a){"use strict";var r=a("23e7"),n=a("c65b"),o=a("2266"),c=a("59ed"),l=a("825a"),s=a("46c4"),i=a("2a62"),d=a("f99f"),u=d("find",TypeError);r({target:"Iterator",proto:!0,real:!0,forced:u},{find:function(e){l(this);try{c(e)}catch(r){i(this,"throw",r)}if(u)return n(u,this,e);var t=s(this),a=0;return o(t,(function(t,r){if(e(t,a++))return r(t)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})}}]);
//# sourceMappingURL=chunk-02aa04cc.6075db03.js.map