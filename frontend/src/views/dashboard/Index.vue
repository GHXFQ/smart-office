<template>
  <div class="openwebui-chat-root">
    <div class="openwebui-chat-window">
      <div class="openwebui-chat-header">
        <span class="openwebui-title">Êô∫ÊÖßAIÂäûÂÖ¨Âä©Êâã</span>
        <el-button type="link" size="small" @click="clearChat" class="clear-chat-btn">
          <el-icon><Delete /></el-icon> Êñ∞ÂØπËØù
        </el-button>
      </div>
      
      <div class="openwebui-chat-container">
        <div class="openwebui-chat-body" ref="chatBody">
          <div v-for="(msg, idx) in messages" :key="idx" :class="['openwebui-msg', msg.role]">
            <template v-if="msg.role==='assistant'">
              <div class="openwebui-avatar ai-avatar left-avatar">
                <svg viewBox="0 0 40 40" width="36" height="36"><circle cx="20" cy="20" r="20" fill="#2f54eb"/><text x="50%" y="55%" text-anchor="middle" fill="#fff" font-size="20" font-family="Arial" dy=".3em">ü§ñ</text></svg>
              </div>
            </template>
            <template v-if="msg.role==='user'">
              <div class="openwebui-avatar user-avatar right-avatar">
                <img v-if="userAvatarUrl" :src="userAvatarUrl" class="user-avatar-img" alt="Áî®Êà∑Â§¥ÂÉè" @error="handleAvatarError" />
                <svg v-else viewBox="0 0 40 40" width="36" height="36"><circle cx="20" cy="20" r="20" fill="#bbb"/><text x="50%" y="55%" text-anchor="middle" fill="#fff" font-size="20" font-family="Arial" dy=".3em">üßë</text></svg>
              </div>
            </template>
            <div class="openwebui-msg-bubble">
              <template v-if="msg.type === 'text'">
                <span v-if="msg.role==='user'">{{ msg.content }}</span>
                <span v-else v-html="msg.content"></span>
                <span v-if="msg.streaming" class="openwebui-cursor"></span>
                <div v-if="msg.source === 'knowledge_base' && msg.role === 'assistant'" class="source-tag knowledge-base-tag">
                  <el-icon><DataAnalysis /></el-icon> Áü•ËØÜÂ∫ì
                </div>
                <div v-if="msg.source === 'general_ai' && msg.role === 'assistant'" class="source-tag general-ai-tag">
                  <el-icon><Cpu /></el-icon> AIÂ§ßÊ®°Âûã
                </div>
              </template>
              <!-- Âç°ÁâáÁ±ªÂûãÊ∂àÊÅØÊ∏≤ÊüìÔºàÂ∑≤‰øÆÊîπÔºâ -->
              <template v-else-if="msg.type === 'card'">
                <div class="openwebui-card-message" :class="getCardClass(msg.status)" :data-event-id="msg.event_id">
                  <div class="card-icon-wrapper">
                    <el-icon><component :is="getCardIcon(msg.status)" /></el-icon>
                  </div>
                  <div class="card-content-wrapper">
                    <div class="card-title">{{ getCardTitle(msg.status) }}</div>
                    <div class="card-body" v-html="msg.content"></div>
                    <!-- Êñ∞Â¢ûÔºöÂç°ÁâáÊìç‰ΩúÊåâÈíÆ -->
                    <div v-if="msg.status === 'success' && msg.event_id" class="card-actions">
                        <el-button size="small" @click="editEvent(msg)" round>
                          <el-icon><EditPen /></el-icon> ÁºñËæë
                        </el-button>
                        <el-button type="danger" size="small" @click="deleteEventFromCard(msg.event_id)" round>
                          <el-icon><Delete /></el-icon> Âà†Èô§
                        </el-button>
                    </div>
                  </div>
                </div>
              </template>
              <template v-else-if="msg.type === 'file'">
                <div class="file-bubble-nest file-bubble-vertical">
                  <div v-for="file in msg.files" :key="file.name + file.size" class="file-message-card">
                    <div class="file-icon-area">
                      <img v-if="file.ext==='csv'" src="https://cdn.jsdelivr.net/gh/file-icons/icons/svg/csv.svg" class="file-icon-img" />
                      <el-icon v-else><Document /></el-icon>
                    </div>
                    <div class="file-info-area">
                      <div class="file-name">{{ file.name }}</div>
                      <div class="file-meta">{{ file.ext.toUpperCase() }} ¬∑ {{ file.size }}</div>
                    </div>
                  </div>
                  <div class="file-desc-text" v-if="msg.content">{{ msg.content }}</div>
                </div>
              </template>
            </div>
          </div>
        </div>
        
        <!-- Âè≥‰æßÈù¢Êùø - ÂåÖÂê´Ê®°ÂºèÂàáÊç¢ÂíåÂéÜÂè≤ËÆ∞ÂΩï -->
        <div class="openwebui-right-panel" :class="{'collapsed': rightPanelCollapsed}">
          <div class="right-panel-header">
            <!-- Ê®°ÂºèÂàáÊç¢ÊåâÈíÆ -->
            <div class="right-panel-mode-controls">
              <el-radio-group v-model="chatMode" size="default">
                <el-radio-button label="agent">
                  <el-icon><MagicStick /></el-icon> AIÂä©Êâã
                </el-radio-button>
                <el-radio-button label="knowledge_base">
                  <el-icon><DataAnalysis /></el-icon> Áü•ËØÜÂ∫ì
                </el-radio-button>
              </el-radio-group>
            </div>
            
            <!-- Â±ïÂºÄ/Êî∂Ëµ∑ÊåâÈíÆ -->
            <el-button 
              circle
              @click="rightPanelCollapsed = !rightPanelCollapsed"
              :title="rightPanelCollapsed ? 'Â±ïÂºÄ' : 'Êî∂Ëµ∑'"
              class="collapse-button"
            >
              <el-icon :size="16">
                <Expand v-if="!rightPanelCollapsed" />
                <Fold v-else />
              </el-icon>
            </el-button>
          </div>
          
          <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂÜÖÂÆπ -->
          <div class="history-container">
            <div class="history-header">
              <h3 class="history-title">ÂéÜÂè≤ËÆ∞ÂΩï</h3>
              <el-button 
                v-if="chatSessions.length > 0"
                text
                size="small" 
                class="clear-all-btn"
                @click="confirmClearAllHistory"
              >
                Ê∏ÖÁ©∫
              </el-button>
            </div>
            
            <div class="history-list">
              <div 
                v-for="(session, index) in chatSessions" 
                :key="session.id"
                class="history-item"
                :class="{'active': session.id === chatId}"
              >
                <div class="history-item-content" @click="switchChatSession(session.id)">
                  <div class="history-item-icon">
                    <el-icon><ChatLineSquare /></el-icon>
                  </div>
                  <div class="history-item-info">
                    <div class="history-item-title">{{ session.title || `ÂØπËØù ${index + 1}` }}</div>
                    <div class="history-item-time">{{ formatTime(session.created_at) }}</div>
                  </div>
                </div>
                <div class="history-item-actions">
                  <div class="delete-btn-wrapper" @click.stop="deleteSession(session.id)">
                    <el-icon class="delete-icon"><Delete /></el-icon>
                  </div>
                </div>
              </div>
              <div v-if="chatSessions.length === 0" class="history-empty">
                ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="openwebui-chat-footer">
        <!-- È¢ÑËßàÂå∫ÊîæÂú®footerÈ°∂ÈÉ® -->
        <div v-if="selectedFiles.length" class="openwebui-file-preview-bar">
          <div v-for="(file, idx) in selectedFiles" :key="file.id" class="openwebui-file-card">
            <div class="openwebui-file-thumb">
              <img v-if="file.type.startsWith('image/')" :src="file.url" class="openwebui-file-img" />
              <div v-else class="openwebui-file-icon" :style="{background: file.bg}">
                <el-icon v-if="file.ext==='pdf'"><Document /></el-icon>
                <el-icon v-else-if="file.ext==='csv' || file.ext==='xls' || file.ext==='xlsx'"><Document /></el-icon>
                <el-icon v-else><Document /></el-icon>
              </div>
            </div>
            <div class="openwebui-file-info">
              <div class="openwebui-file-name" :title="file.name">{{ file.name }}</div>
              <div class="openwebui-file-meta">{{ file.label }} ¬∑ {{ file.size }}</div>
              <!-- Ê∑ªÂä†ËøõÂ∫¶Êù°ÊòæÁ§∫ -->
              <el-progress 
                v-if="file.status !== 'completed'" 
                :percentage="file.progress" 
                :status="file.status === 'failed' ? 'exception' : ''" 
                :stroke-width="4"
                class="openwebui-file-progress" />
              <div v-else class="openwebui-file-status completed">
                <el-icon><Check /></el-icon> Â§ÑÁêÜÂÆåÊàê
              </div>
            </div>
            <el-icon class="openwebui-file-remove" @click="removeFile(idx)"><Close /></el-icon>
          </div>
        </div>
        <!-- ËæìÂÖ•Âå∫ -->
        <div class="openwebui-input-area">
          <input type="file" ref="fileInput" style="display:none" @change="handleFileUpload" multiple 
               accept=".txt,.pdf,.doc,.docx,.md,.xls,.xlsx,.csv,.jpg,.jpeg,.png,.gif,.bmp,.webp,.svg,.tiff" />
          <el-tooltip
            content="ÊñáÊ°£: txt, pdf, doc, docx, md&#10;Ë°®Ê†º: xls, xlsx, csv&#10;ÂõæÁâá: jpg, jpeg, png, gif, bmp, webp, svg, tiff"
            placement="top"
            popper-class="openwebui-upload-tooltip"
            :open-delay="200"
            v-if="chatMode === 'agent'"
          >
            <el-button class="openwebui-upload-btn" @click="triggerFileInput" title="‰∏ä‰º†Êñá‰ª∂/ÂõæÁâá" :disabled="loading">
              <el-icon><UploadFilled /></el-icon>
            </el-button>
          </el-tooltip>
          <el-input
            v-model="input"
            placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..."
            @keyup.enter="sendMsg"
            class="openwebui-input"
            :disabled="loading || processingFiles"
          />
          <el-button type="primary" @click="sendMsg" class="openwebui-send-btn" :loading="loading" :disabled="processingFiles">
            {{ loading ? 'ÁîüÊàê‰∏≠' : (processingFiles ? 'Â§ÑÁêÜ‰∏≠' : 'ÂèëÈÄÅ') }}
          </el-button>
        </div>
        <div class="openwebui-options-area" v-if="chatMode === 'knowledge_base'">
            <el-radio-group v-model="searchMethod" size="small">
              <el-radio-button label="basic">Âü∫Á°ÄÊ£ÄÁ¥¢</el-radio-button>
              <el-radio-button label="local">Â§çÊùÇÊ£ÄÁ¥¢</el-radio-button>
            </el-radio-group>
        </div>
        <div class="openwebui-footer-hint" v-if="chatMode === 'agent'">
          ÊîØÊåÅÊñáÊ°£„ÄÅË°®Ê†º„ÄÅÂõæÁâáÁ≠âÂ§öÁßçÊ†ºÂºèÊñá‰ª∂
        </div>
      </div>
    </div>

    <!-- Êñ∞Â¢ûÔºöÁºñËæëÊó•Á®ãÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="editEventDialogVisible"
      title="ÁºñËæëÊó•Á®ã"
      width="500px"
      class="calendar-dialog"
      :append-to-body="true"
      :destroy-on-close="true"
      :close-on-click-modal="false"
    >
      <el-form :model="editingEvent" label-width="80px" v-if="editingEvent">
        <el-form-item label="Ê†áÈ¢ò">
          <el-input v-model="editingEvent.title" placeholder="ËØ∑ËæìÂÖ•Êó•Á®ãÊ†áÈ¢ò"></el-input>
        </el-form-item>
        <el-form-item label="ÂºÄÂßãÊó∂Èó¥">
          <el-date-picker
            v-model="editingEvent.start"
            type="datetime"
            placeholder="ÈÄâÊã©ÂºÄÂßãÊó∂Èó¥"
            format="YYYY-MM-DD HH:mm"
            value-format="YYYY-MM-DD HH:mm"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="ÁªìÊùüÊó∂Èó¥">
          <el-date-picker
            v-model="editingEvent.end"
            type="datetime"
            placeholder="ÈÄâÊã©ÁªìÊùüÊó∂Èó¥"
            format="YYYY-MM-DD HH:mm"
            value-format="YYYY-MM-DD HH:mm"
          ></el-date-picker>
        </el-form-item>
        <el-form-item label="Âú∞ÁÇπ">
          <el-input v-model="editingEvent.location" placeholder="ËØ∑ËæìÂÖ•Âú∞ÁÇπ"></el-input>
        </el-form-item>
        <el-form-item label="Á±ªÂûã">
          <el-select v-model="editingEvent.type" placeholder="ËØ∑ÈÄâÊã©Êó•Á®ãÁ±ªÂûã">
            <el-option label="‰ºöËÆÆ" value="blue"></el-option>
            <el-option label="Âá∫Â∑Æ" value="orange"></el-option>
            <el-option label="ÂÅáÊúü" value="green"></el-option>
            <el-option label="Êà™Ê≠¢Êó•Êúü" value="red"></el-option>
            <el-option label="ÂÖ∂‰ªñ" value="purple"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="ÊèêÈÜí">
          <el-select v-model="editingEvent.reminder" placeholder="ËØ∑ÈÄâÊã©ÊèêÈÜíÊó∂Èó¥">
            <el-option label="‰∏çÊèêÈÜí" value="none"></el-option>
            <el-option label="10ÂàÜÈíüÂâç" value="10min"></el-option>
            <el-option label="30ÂàÜÈíüÂâç" value="30min"></el-option>
            <el-option label="1Â∞èÊó∂Ââç" value="1hour"></el-option>
            <el-option label="1Â§©Ââç" value="1day"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="Â§áÊ≥®">
          <el-input 
            v-model="editingEvent.description" 
            type="textarea" 
            :rows="3"
            placeholder="ËØ∑ËæìÂÖ•Â§áÊ≥®‰ø°ÊÅØ"
          ></el-input>
        </el-form-item>
      </el-form>
      <template #footer>
        <div class="dialog-footer">
          <el-button @click="editEventDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveEditEvent">Á°ÆÂÆö</el-button>
        </div>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { ref, nextTick, computed, onMounted, watch } from 'vue'
import { UploadFilled, Document, Close, Check, Delete, DataAnalysis, Cpu, MagicStick, ChatLineSquare, Fold, Expand, 
  Calendar, ChatDotRound, Collection, DocumentCopy, Grid, Connection, CircleCheckFilled, InfoFilled, CircleCloseFilled, WarningFilled, EditPen } from '@element-plus/icons-vue'
import request from '@/utils/request'
import { marked } from 'marked'
import { ElMessage, ElMessageBox } from 'element-plus'
import { aiChatWithDocumentsStream, getAIChatSessions, getAIChatSession, deleteAIChatSession } from '@/api/ai'
import { deleteCalendarEvent } from '@/api/calendar' // Êñ∞Â¢ûÂØºÂÖ•
import { getCurrentInstance } from 'vue';
import { getCalendarEvent, updateEvent } from '@/api/calendar' // Êñ∞Â¢ûÂØºÂÖ•

function formatSize(size) {
  if (size < 1024) return size + 'B';
  if (size < 1024*1024) return (size/1024).toFixed(1) + 'KB';
  return (size/1024/1024).toFixed(1) + 'MB';
}
function getExt(name) {
  const arr = name.split('.');
  return arr.length > 1 ? arr[arr.length-1].toLowerCase() : '';
}
function getFileLabel(type, ext) {
  const ext_lower = ext.toLowerCase();
  if (type.startsWith('image/')) return 'ÂõæÁâá';
  if (ext_lower === 'pdf') return 'PDF';
  if (['csv','xls','xlsx'].includes(ext_lower)) return 'Ë°®Ê†º';
  if (['doc','docx'].includes(ext_lower)) return 'ÊñáÊ°£';
  if (ext_lower === 'md') return 'Markdown';
  if (ext_lower === 'txt') return 'ÊñáÊú¨';
  return ext_lower.toUpperCase();
}
function getFileBg(ext) {
  const ext_lower = ext.toLowerCase();
  if (ext_lower === 'pdf') return '#f87171'; // Á∫¢Ëâ≤
  if (['csv','xls','xlsx'].includes(ext_lower)) return '#34d399'; // ÁªøËâ≤
  if (['doc','docx'].includes(ext_lower)) return '#60a5fa'; // ËìùËâ≤
  if (ext_lower === 'md') return '#a78bfa'; // Á¥´Ëâ≤
  if (ext_lower === 'txt') return '#fbbf24'; // ÈªÑËâ≤
  return '#a5b4fc'; // ÈªòËÆ§Ê∑°Á¥´Ëâ≤
}
function escapeHtml(html) {
  return html.replace(/[&<>"']/g, function(m) {
    return ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[m];
  });
}

// Ê†ºÂºèÂåñÊó•ÊúüÊó∂Èó¥
function formatTime(dateTimeStr) {
  if (!dateTimeStr) return '';
  const date = new Date(dateTimeStr);
  return `${date.getMonth() + 1}Êúà${date.getDate()}Êó• ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
}

// ISOÊó•ÊúüÊ†ºÂºèÂåñ‰∏∫ÂèØËØªÊ†ºÂºè
function formatISODate(isoDateStr) {
  if (!isoDateStr) return '';
  try {
    const date = new Date(isoDateStr);
    return date.toLocaleString('zh-CN', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit'
    });
  } catch (error) {
    console.error('Êó•ÊúüÊ†ºÂºèÂåñÈîôËØØ:', error);
    return isoDateStr; // ËøîÂõûÂéüÂßãÂÄº
  }
}

export default {
  name: 'Dashboard',
  components: {
    UploadFilled, Document, Close, Check, Delete, DataAnalysis, Cpu, MagicStick, ChatLineSquare, Fold, Expand,
    Calendar, ChatDotRound, Collection, DocumentCopy, Grid, Connection, CircleCheckFilled, InfoFilled, CircleCloseFilled, WarningFilled, EditPen
  },
  setup() {
    const { proxy } = getCurrentInstance();
    const userAvatarUrl = ref(proxy.$store.state.user.avatar)
    const handleAvatarError = () => {
      userAvatarUrl.value = ''; // Âä†ËΩΩÂ§±Ë¥•Êó∂Ê∏ÖÁ©∫Ôºå‰ºöÊòæÁ§∫ÈªòËÆ§SVG
    };
    
    const input = ref('')
    const messages = ref([
      { 
        role: 'assistant', 
        content: `<div class="welcome-message">
          <h3>Ê¨¢ËøéÊù•Âà∞Êô∫Ë°åËàüÂπ≥Âè∞</h3>
          <div class="platform-intro">
            <p>Êô∫Ë°åËàüÂπ≥Âè∞ÊòØÊÇ®ÁöÑÊô∫ËÉΩÂçè‰Ωú‰∏≠ÂøÉÔºåËûçÂêà‰∫ÜÈ°πÁõÆÁÆ°ÁêÜ„ÄÅÂç≥Êó∂ÈÄöËÆØ„ÄÅÊô∫ËÉΩÊñáÊ°£ÂíåAIÂä©ÊâãÁ≠â„ÄÇÊàë‰ª¨Ëá¥Âäõ‰∫éÈÄöËøáÂâçÊ≤øAIÊäÄÊúØËµãËÉΩÊÇ®ÁöÑÂõ¢ÈòüÔºå‰ºòÂåñ‰∏öÂä°ÊµÅÁ®ãÔºå‰∏∫ÊÇ®ÊâìÈÄ†Êó†ÁºùËøûÊé•ÁöÑÊú™Êù•ÂäûÂÖ¨Êñ∞ËåÉÂºèÔºåÊ†∏ÂøÉ‰ºòÂäøÂ¶Ç‰∏ãÔºö</p>
            
            <ul class="platform-features">
              <li><span class="feature-highlight">AIÊô∫ËÉΩÂºïÊìé</span> - Êàë‰ª¨ÁöÑAIÂä©ÊâãËÉΩÂ§üÁêÜËß£Ëá™ÁÑ∂ËØ≠Ë®ÄÔºåÂ§ÑÁêÜÂ§çÊùÇÊñáÊ°£ÔºåÂàõÂª∫Êó•Á®ãÔºåÊàê‰∏∫ÊÇ®24Â∞èÊó∂ÁöÑÊô∫ËÉΩÂ∑•‰Ωú‰ºô‰º¥„ÄÇ</li>
              <li><span class="feature-highlight">‰∏Ä‰ΩìÂåñÂçè‰Ωú</span> - Êó†ÁºùÊï¥ÂêàÈ°πÁõÆ„ÄÅÊó•Á®ã‰∏éÊ≤üÈÄöÂ∑•ÂÖ∑ÔºåÊâìÁ†¥‰ø°ÊÅØÂ≠§Â≤õÔºåËÆ©Âõ¢ÈòüÂçè‰ΩúÂ¶ÇË°å‰∫ëÊµÅÊ∞¥Ëà¨È°∫ÁïÖÔºåÊòæËëóÊèêÂçáÊïàÁéá„ÄÇ</li>
              <li><span class="feature-highlight">Êô∫ÊÖßÊñáÊ°£Â§ÑÁêÜ</span> - ‰ªéÊô∫ËÉΩÂêàÂêåÁîüÊàêÂà∞Áü•ËØÜÂ∫ìÁÆ°ÁêÜÔºåËá™Âä®ÂåñÂ§ÑÁêÜÁπÅÊùÇÁöÑÊñáÊ°£Â∑•‰ΩúÊµÅÔºåËÆ©ÊÇ®ÁöÑÂõ¢ÈòüËÅöÁÑ¶‰∫éÊ†∏ÂøÉÂàõÊñ∞„ÄÇ</li>
              <li><span class="feature-highlight">ÂÆâÂÖ®ÂèØÈù†‰øùÈöú</span> - ÈááÁî®‰ºÅ‰∏öÁ∫ßÊï∞ÊçÆÂä†ÂØÜ‰∏éÁ≤æÁªÜÂåñÊùÉÈôêÁÆ°ÁêÜÔºåÂÖ®Êñπ‰ΩçÂÆàÊä§ÊÇ®ÁöÑÊ†∏ÂøÉÊï∞ÊçÆËµÑ‰∫ßÂÆâÂÖ®„ÄÇ</li>
            </ul>
            
            <p>ÂÄüÂä©Êô∫Ë°åËàüÂπ≥Âè∞ÔºåÊÇ®ÁöÑ‰ºÅ‰∏öÂ∞ÜËøàÂÖ•Êõ¥ÊïèÊç∑„ÄÅÈ´òÊïà„ÄÅÊô∫ËÉΩÁöÑÂçè‰ΩúÊñ∞Á∫™ÂÖÉÔºåÊøÄÂèëÂõ¢ÈòüÊΩúÂäõÔºåÊèêÂçáÊï¥‰ΩìÁ´û‰∫âÂäõ„ÄÇ</p>
          </div>
          <p>ÈÄâÊã©‰ª•‰∏ãÂäüËÉΩÊ®°ÂùóÔºåÊàñÁõ¥Êé•ÂêëÊàëÊèêÈóÆÔºåÊàëÂ∞Ü‰∏∫ÊÇ®Êèê‰æõÊô∫ËÉΩÂä©ÊâãÊúçÂä°„ÄÇ</p>
          <div class="quick-nav-cards">
            <div class="nav-card" onclick="window.location.href='/project'">
              <div class="nav-card-icon">
                <i class="bi bi-kanban"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">È°πÁõÆÂçè‰Ωú</div>
                <div class="nav-card-desc">‰ªªÂä°ÂàÜÈÖç„ÄÅËøõÂ∫¶Ë∑üË∏™„ÄÅÂõ¢ÈòüÂçè‰Ωú</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
            <div class="nav-card" onclick="window.location.href='/calendar'">
              <div class="nav-card-icon">
                <i class="bi bi-calendar-week"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">Êó•Á®ãÂÆâÊéí</div>
                <div class="nav-card-desc">‰ºöËÆÆÈ¢ÑÁ∫¶„ÄÅÊó•Á®ãÊèêÈÜí„ÄÅÊó∂Èó¥ÁÆ°ÁêÜ</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
            <div class="nav-card" onclick="window.location.href='/chat'">
              <div class="nav-card-icon">
                <i class="bi bi-chat-dots"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">Âç≥Êó∂Ê≤üÈÄö</div>
                <div class="nav-card-desc">Âõ¢ÈòüËÅäÂ§©„ÄÅÊñá‰ª∂ÂÖ±‰∫´„ÄÅÊ∂àÊÅØÈÄöÁü•</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
            <div class="nav-card" onclick="window.location.href='/smartdoc'">
              <div class="nav-card-icon">
                <i class="bi bi-file-earmark-text"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">Êô∫ËÉΩÊñáÊ°£</div>
                <div class="nav-card-desc">ÂÜÖÂÆπÂàõ‰Ωú„ÄÅÊô∫ËÉΩÈóÆÁ≠î„ÄÅÊñáÊ°£ÂÖ±‰∫´</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
            <div class="nav-card" onclick="window.location.href='/knowledge'">
              <div class="nav-card-icon">
                <i class="bi bi-book"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">Áü•ËØÜÂ∫ì</div>
                <div class="nav-card-desc">Âõ¢ÈòüÁü•ËØÜÂÖ±‰∫´„ÄÅÊ£ÄÁ¥¢„ÄÅÂ≠òÂÇ®Âπ≥Âè∞</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
            <div class="nav-card" onclick="window.location.href='/contract'">
              <div class="nav-card-icon">
                <i class="bi bi-file-earmark-ruled"></i>
              </div>
              <div class="nav-card-content">
                <div class="nav-card-title">Êô∫ËÉΩÂêàÂêå</div>
                <div class="nav-card-desc">ÂêàÂêåÊ®°Êùø„ÄÅAIÂÆ°Êü•„ÄÅÊô∫ËÉΩÁîüÊàê</div>
              </div>
              <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
            </div>
          </div>
        </div>`, 
        rawContent: 'ÊÇ®Â•ΩÔºåÊàëÊòØÊÇ®ÁöÑAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®Ôºü',
        type: 'text' 
      }
    ])
    const chatBody = ref(null)
    const fileInput = ref(null)
    const selectedFiles = ref([])
    const loading = ref(false)
    const processingFiles = computed(() => {
      return selectedFiles.value.some(file => file.status !== 'completed' && file.status !== 'failed');
    })
    const chatId = ref(null) // Â≠òÂÇ®ÂΩìÂâçËÅäÂ§©IDÔºåÁî®‰∫éÁª¥ÊåÅÂØπËØù‰∏ä‰∏ãÊñá
    const showContextBar = computed(() => chatId.value !== null)
    const searchMethod = ref('basic') // Êñ∞Â¢ûÔºöÊêúÁ¥¢ÊñπÊ≥ï, ÈªòËÆ§‰∏∫basic
    const chatMode = ref('agent') // agent Êàñ knowledge_base
    const retrievalScope = ref('local') // 'local' Êàñ 'basic'
    
    // Ê∑ªÂä†ÂèòÈáèÊù•Â≠òÂÇ®ÂΩìÂâçËØ∑Ê±ÇÁöÑÊéßÂà∂Âô®
    const currentRequestController = ref(null);
    
    // Âè≥‰æßÈù¢ÊùøÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const rightPanelCollapsed = ref(false);
    const chatSessions = ref([]);
    
    // ÁºñËæëÂØπËØùÊ°ÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
    const editEventDialogVisible = ref(false);
    const editingEvent = ref(null);
    const currentEditingMessage = ref(null);
    
    // Ëé∑Âèñ emitter ÂÆû‰æã
    const emitter = proxy.emitter;
    
    // Ëé∑ÂèñËÅäÂ§©‰ºöËØùÂàóË°®
    const fetchChatSessions = async () => {
      try {
        const res = await getAIChatSessions();
        if (res.data && Array.isArray(res.data)) {
          chatSessions.value = res.data;
        } else if (res.data && res.data.results && Array.isArray(res.data.results)) {
          chatSessions.value = res.data.results;
        }
        return chatSessions.value;
      } catch (error) {
        console.error('Ëé∑ÂèñËÅäÂ§©‰ºöËØùÂàóË°®Â§±Ë¥•:', error);
        chatSessions.value = [];
        return [];
      }
    };
    
    // ÂàáÊç¢ËÅäÂ§©‰ºöËØù
    const switchChatSession = async (sessionId) => {
      if (sessionId === chatId.value) return;
      
      try {
        loading.value = true;
        const res = await getAIChatSession(sessionId);
        if (res.data) {
          chatId.value = sessionId;
          // Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤
          if (res.data.messages && Array.isArray(res.data.messages)) {
            messages.value = res.data.messages.map(msg => {
              return {
                role: msg.role,
                content: msg.content,
                rawContent: msg.content,
                type: msg.type || 'text',
                source: msg.role === 'user' ? '' : (msg.source || (msg.role === 'assistant' ? 'general_ai' : '')) // Á°Æ‰øùÁî®Êà∑Ê∂àÊÅØÊ≤°ÊúâsourceÂ±ûÊÄß
              }
            });
          }
        }
      } catch (error) {
        console.error('Ëé∑ÂèñËÅäÂ§©‰ºöËØùËØ¶ÊÉÖÂ§±Ë¥•:', error);
        ElMessage.error('ÂàáÊç¢ËÅäÂ§©‰ºöËØùÂ§±Ë¥•');
        
        // Â¶ÇÊûúÂàáÊç¢Â§±Ë¥•ÔºåÊ£ÄÊü•ÂΩìÂâç‰ºöËØùÂàóË°®‰∏≠ÊòØÂê¶ËøòÊúâËøô‰∏™‰ºöËØù
        const sessionExists = chatSessions.value.some(session => session.id === sessionId);
        if (!sessionExists) {
          // Â¶ÇÊûú‰ºöËØùÂ∑≤‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂàáÊç¢Âà∞Á¨¨‰∏Ä‰∏™ÂèØÁî®‰ºöËØùÊàñÂàõÂª∫Êñ∞‰ºöËØù
          if (chatSessions.value.length > 0) {
            await switchChatSession(chatSessions.value[0].id);
          } else {
            clearChat();
          }
        }
      } finally {
        loading.value = false;
      }
    };

    // ÁõëÂê¨ËÅäÂ§©IDÂèòÂåñÔºåÊõ¥Êñ∞‰ºöËØùÂàóË°®
    watch(chatId, (newChatId) => {
      if (newChatId) {
        fetchChatSessions();
      }
    });

    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    const getUserInfo = async () => {
      try {
        const res = await request({
          url: '/api/auth/users/me/',
          method: 'get'
        })
        console.log('Áî®Êà∑‰ø°ÊÅØÂÆåÊï¥ÂìçÂ∫î:', res)

        // Â∞ùËØï‰ªéÂìçÂ∫îÁöÑ‰∏çÂêå‰ΩçÁΩÆËé∑ÂèñÂ§¥ÂÉèURL
        let avatarUrl = null
        if (res.data && res.data.data && res.data.data.avatar) {
          avatarUrl = res.data.data.avatar
        } else if (res.data && res.data.avatar) {
          avatarUrl = res.data.avatar
        } else if (res.data) {
          // ÈÅçÂéÜres.dataÊü•ÊâæavatarÂ≠óÊÆµ
          const findAvatar = (obj) => {
            if (!obj || typeof obj !== 'object') return null
            
            if ('avatar' in obj) return obj.avatar
            
            // ÈÄíÂΩíÊêúÁ¥¢ÊâÄÊúâÂ≠êÂØπË±°
            for (const key in obj) {
              if (typeof obj[key] === 'object') {
                const result = findAvatar(obj[key])
                if (result) return result
              }
            }
            return null
          }
          
          avatarUrl = findAvatar(res.data)
        }

        console.log('ÊâæÂà∞ÁöÑÂ§¥ÂÉèURL:', avatarUrl)
        
        if (avatarUrl) {
          // Â¶ÇÊûúÊòØÁõ∏ÂØπË∑ØÂæÑÔºåÊ∑ªÂä†Âü∫Á°ÄURL
          if (!avatarUrl.startsWith('http') && !avatarUrl.startsWith('data:')) {
            // Á°Æ‰øùÂ™í‰ΩìURLÊ≠£Á°ÆÊãºÊé•
            const baseUrl = window.location.origin
            if (avatarUrl.startsWith('/')) {
              userAvatarUrl.value = `${baseUrl}${avatarUrl}`
            } else {
              userAvatarUrl.value = `${baseUrl}/${avatarUrl}`
            }
          } else {
            userAvatarUrl.value = avatarUrl
          }
          console.log('Â§ÑÁêÜÂêéÁöÑÁî®Êà∑Â§¥ÂÉèURL:', userAvatarUrl.value)
        } else {
          console.log('Áî®Êà∑‰ø°ÊÅØ‰∏≠Ê≤°ÊúâÊâæÂà∞Â§¥ÂÉè:', res.data)
        }
      } catch (error) {
        console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error)
      }
    }
    
    const scrollToBottom = () => {
      nextTick(() => {
        if (chatBody.value) chatBody.value.scrollTop = chatBody.value.scrollHeight
      })
    }
    
    const uploadFileAndGetId = async (file) => {
      const formData = new FormData()
      formData.append('file', file.rawFile)
      try {
        // Ê†áËÆ∞Êñá‰ª∂‰∏∫‰∏ä‰º†‰∏≠
        file.progress = 0;
        file.status = 'pending';
        let smoothTimer = null;
        let lastProgress = 0;
        let uploadFinished = false;
        const res = await request({
          url: '/api/ai/documents/upload/',
          method: 'post',
          data: formData,
          onUploadProgress: (progressEvent) => {
            const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
            if (percentCompleted < 100) {
              file.progress = percentCompleted;
              lastProgress = percentCompleted;
            } else {
              // ‰∏ä‰º†Áû¨Èó¥ÂÆåÊàêÔºåÂπ≥ÊªëÈÄíÂ¢ûÂà∞95%
              if (!uploadFinished) {
                uploadFinished = true;
                let fakeProgress = lastProgress;
                smoothTimer = setInterval(() => {
                  fakeProgress += 3;
                  if (fakeProgress >= 95) {
                    fakeProgress = 95;
                    clearInterval(smoothTimer);
                  }
                  file.progress = fakeProgress;
                }, 20);
              }
            }
          }
        })
        // ‰∏ä‰º†ÂÆåÊàêÂêéÔºåÁä∂ÊÄÅÊîπ‰∏∫Â§ÑÁêÜ‰∏≠Ôºå‰∏çÈáçÁΩÆËøõÂ∫¶Êù°
        if (smoothTimer) clearInterval(smoothTimer);
        if (file.progress < 95) file.progress = 95;
        file.status = 'processing';
        file.documentId = res.data.id;
        pollDocumentStatus(file);
        return res.data.id;
      } catch (error) {
        file.status = 'failed';
        console.error('Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•:', error);
        throw new Error(`‰∏ä‰º†Êñá‰ª∂ ${file.name} Â§±Ë¥•: ${error.message || 'ÊúçÂä°Âô®ÈîôËØØ'}`);
      }
    }
    
    // ËΩÆËØ¢ÊñáÊ°£Â§ÑÁêÜÁä∂ÊÄÅ
    const pollDocumentStatus = async (file, interval = 1000) => {
      if (!file.documentId) return;
      
      try {
        const res = await request({
          url: `/api/ai/documents/${file.documentId}/`,
          method: 'get'
        });
        
        if (res.data.status === 'completed') {
          file.progress = 100;
          file.status = 'completed';
          return;
        } else if (res.data.status === 'failed') {
          file.status = 'failed';
          file.progress = 0;
          return;
        } else if (res.data.status === 'processing') {
          // Â§ÑÁêÜ‰∏≠ÔºåÂ¢ûÂä†ËøõÂ∫¶Ôºà‰ªÖÂú®Â∞è‰∫é95Êó∂ÈÄíÂ¢ûÔºâ
          if (file.progress < 95) {
            file.progress = Math.min(file.progress + 5, 95);
          }
        }
        
        // ÁªßÁª≠ËΩÆËØ¢
        setTimeout(() => pollDocumentStatus(file, interval), interval);
      } catch (e) {
        // Âá∫ÈîôÊó∂ÔºåÁªßÁª≠ËΩÆËØ¢Ôºå‰ΩÜ‰∏çÊõ¥Êñ∞ËøõÂ∫¶
        setTimeout(() => pollDocumentStatus(file, interval), interval);
      }
    }
    
    const clearChat = () => {
      // Ê∏ÖÁ©∫ÂØπËØùÂéÜÂè≤ÔºåÂºÄÂßãÊñ∞ÁöÑÂØπËØù
      chatId.value = null;
      
      // ÈáçÁΩÆÊ∂àÊÅØÂàóË°®ÔºåÂè™‰øùÁïôÊ¨¢ËøéÊ∂àÊÅØ
      messages.value = [
        { 
          role: 'assistant', 
          content: `<div class="welcome-message">
            <h3>Ê¨¢ËøéÊù•Âà∞Êô∫Ë°åËàüÂπ≥Âè∞</h3>
            <div class="platform-intro">
              <p>Êô∫Ë°åËàüÂπ≥Âè∞ÊòØÊÇ®ÁöÑÊô∫ËÉΩÂçè‰Ωú‰∏≠ÂøÉÔºåËûçÂêà‰∫ÜÈ°πÁõÆÁÆ°ÁêÜ„ÄÅÂç≥Êó∂ÈÄöËÆØ„ÄÅÊô∫ËÉΩÊñáÊ°£ÂíåAIÂä©Êâã„ÄÇÊàë‰ª¨Ëá¥Âäõ‰∫éÈÄöËøáÂâçÊ≤øAIÊäÄÊúØËµãËÉΩÊÇ®ÁöÑÂõ¢ÈòüÔºå‰ºòÂåñ‰∏öÂä°ÊµÅÁ®ãÔºå‰∏∫ÊÇ®ÊâìÈÄ†Êó†ÁºùËøûÊé•ÁöÑÊú™Êù•ÂäûÂÖ¨Êñ∞ËåÉÂºèÔºåÊ†∏ÂøÉ‰ºòÂäøÂ¶Ç‰∏ãÔºö</p>
              
              <ul class="platform-features">
                <li><span class="feature-highlight">AIÊô∫ËÉΩÂºïÊìé</span> - Êàë‰ª¨ÁöÑAIÂä©ÊâãËÉΩÂ§üÁêÜËß£Ëá™ÁÑ∂ËØ≠Ë®ÄÔºåÂ§ÑÁêÜÂ§çÊùÇÊñáÊ°£ÔºåËá™Âä®ÂàõÂª∫Êó•Á®ãÔºåÊàê‰∏∫ÊÇ®24Â∞èÊó∂ÁöÑÊô∫ËÉΩÂ∑•‰Ωú‰ºô‰º¥„ÄÇ</li>
                <li><span class="feature-highlight">‰∏Ä‰ΩìÂåñÂçè‰Ωú</span> - Êó†ÁºùÊï¥ÂêàÈ°πÁõÆ„ÄÅÊó•Á®ã‰∏éÊ≤üÈÄöÂ∑•ÂÖ∑ÔºåÊâìÁ†¥‰ø°ÊÅØÂ≠§Â≤õÔºåËÆ©Âõ¢ÈòüÂçè‰ΩúÂ¶ÇË°å‰∫ëÊµÅÊ∞¥Ëà¨È°∫ÁïÖÔºåÊòæËëóÊèêÂçáÊïàÁéá„ÄÇ</li>
                <li><span class="feature-highlight">Êô∫ÊÖßÊñáÊ°£Â§ÑÁêÜ</span> - ‰ªéÊô∫ËÉΩÂêàÂêåÁîüÊàêÂà∞Áü•ËØÜÂ∫ìÁÆ°ÁêÜÔºåËá™Âä®ÂåñÂ§ÑÁêÜÁπÅÊùÇÁöÑÊñáÊ°£Â∑•‰ΩúÊµÅÔºåËÆ©ÊÇ®ÁöÑÂõ¢ÈòüËÅöÁÑ¶‰∫éÊ†∏ÂøÉÂàõÊñ∞„ÄÇ</li>
                <li><span class="feature-highlight">ÂÆâÂÖ®ÂèØÈù†‰øùÈöú</span> - ÈááÁî®‰ºÅ‰∏öÁ∫ßÊï∞ÊçÆÂä†ÂØÜ‰∏éÁ≤æÁªÜÂåñÊùÉÈôêÁÆ°ÁêÜÔºåÂÖ®Êñπ‰ΩçÂÆàÊä§ÊÇ®ÁöÑÊ†∏ÂøÉÊï∞ÊçÆËµÑ‰∫ßÂÆâÂÖ®„ÄÇ</li>
              </ul>
              
              <p>ÂÄüÂä©Êô∫Ë°åËàüÂπ≥Âè∞ÔºåÊÇ®ÁöÑ‰ºÅ‰∏öÂ∞ÜËøàÂÖ•Êõ¥ÊïèÊç∑„ÄÅÈ´òÊïà„ÄÅÊô∫ËÉΩÁöÑÂçè‰ΩúÊñ∞Á∫™ÂÖÉÔºåÊøÄÂèëÂõ¢ÈòüÊΩúÂäõÔºåÊèêÂçáÊï¥‰ΩìÁ´û‰∫âÂäõ„ÄÇ</p>
            </div>
            <p>ÈÄâÊã©‰ª•‰∏ãÂäüËÉΩÊ®°ÂùóÔºåÊàñÁõ¥Êé•ÂêëÊàëÊèêÈóÆÔºåÊàëÂ∞Ü‰∏∫ÊÇ®Êèê‰æõÊô∫ËÉΩÂä©ÊâãÊúçÂä°„ÄÇ</p>
            <div class="quick-nav-cards">
              <div class="nav-card" onclick="window.location.href='/project'">
                <div class="nav-card-icon">
                  <i class="bi bi-kanban"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">È°πÁõÆÂçè‰Ωú</div>
                  <div class="nav-card-desc">‰ªªÂä°ÂàÜÈÖç„ÄÅËøõÂ∫¶Ë∑üË∏™„ÄÅÂõ¢ÈòüÂçè‰Ωú</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
              <div class="nav-card" onclick="window.location.href='/calendar'">
                <div class="nav-card-icon">
                  <i class="bi bi-calendar-week"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">Êó•Á®ãÂÆâÊéí</div>
                  <div class="nav-card-desc">‰ºöËÆÆÈ¢ÑÁ∫¶„ÄÅÊó•Á®ãÊèêÈÜí„ÄÅÊó∂Èó¥ÁÆ°ÁêÜ</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
              <div class="nav-card" onclick="window.location.href='/chat'">
                <div class="nav-card-icon">
                  <i class="bi bi-chat-dots"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">Âç≥Êó∂Ê≤üÈÄö</div>
                  <div class="nav-card-desc">Âõ¢ÈòüËÅäÂ§©„ÄÅÊñá‰ª∂ÂÖ±‰∫´„ÄÅÊ∂àÊÅØÈÄöÁü•</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
              <div class="nav-card" onclick="window.location.href='/smartdoc'">
                <div class="nav-card-icon">
                  <i class="bi bi-file-earmark-text"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">AIÊñáÊ°£</div>
                  <div class="nav-card-desc">ÊñáÊ°£ÊëòË¶Å„ÄÅÊô∫ËÉΩÈóÆÁ≠î„ÄÅÂÜÖÂÆπÂàõ‰Ωú</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
              <div class="nav-card" onclick="window.location.href='/knowledge'">
                <div class="nav-card-icon">
                  <i class="bi bi-book"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">Áü•ËØÜÂ∫ì</div>
                  <div class="nav-card-desc">Âõ¢ÈòüÁü•ËØÜÂÖ±‰∫´„ÄÅÊ£ÄÁ¥¢„ÄÅÂ≠òÂÇ®Âπ≥Âè∞</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
              <div class="nav-card" onclick="window.location.href='/contract'">
                <div class="nav-card-icon">
                  <i class="bi bi-file-earmark-ruled"></i>
                </div>
                <div class="nav-card-content">
                  <div class="nav-card-title">Êô∫ËÉΩÂêàÂêå</div>
                  <div class="nav-card-desc">ÂêàÂêåÊ®°Êùø„ÄÅAIÂÆ°Êü•„ÄÅÊô∫ËÉΩÁîüÊàê</div>
                </div>
                <div class="nav-card-arrow"><i class="nav-arrow-icon">‚Üí</i></div>
              </div>
            </div>
          </div>`, 
          rawContent: 'ÊÇ®Â•ΩÔºåÊàëÊòØÊÇ®ÁöÑAIÂä©ÊâãÔºåÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®Ôºü',
          type: 'text' 
        }
      ];
      
      // Ê∏ÖÁ©∫ÈÄâÊã©ÁöÑÊñá‰ª∂
      selectedFiles.value = [];
      
      // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
      input.value = '';
      
      // Â¶ÇÊûúÊúâÊ≠£Âú®ËøõË°åÁöÑËØ∑Ê±ÇÔºåÂèñÊ∂àÂÆÉ
      if (currentRequestController.value) {
        currentRequestController.value.abort();
        currentRequestController.value = null;
      }
      
      // ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
      loading.value = false;
      
      // ÊªöÂä®Âà∞È°∂ÈÉ®
      nextTick(() => {
        if (chatBody.value) {
          chatBody.value.scrollTop = 0;
        }
      });
      
      // Âà∑Êñ∞ÂéÜÂè≤ËÆ∞ÂΩïÂàóË°®
      fetchChatSessions();
    }
    
    const processBuffer = (data) => {
        let lastMessage = messages.value[messages.value.length - 1];
        if (!lastMessage || lastMessage.role !== 'assistant') {
            lastMessage = { 
                role: 'assistant', 
                content: '', 
                rawContent: '', 
                type: 'text', 
                streaming: true,
                source: chatMode.value === 'knowledge_base' ? 'knowledge_base' : 'general_ai' // Ê†πÊçÆÂΩìÂâçÊ®°ÂºèËÆæÁΩÆÈªòËÆ§source
            };
            messages.value.push(lastMessage);
        }

        if (data.type === 'processing_start') {
            lastMessage.type = 'text';
            lastMessage.content = data.content;
            lastMessage.rawContent = data.content;
            lastMessage.streaming = true;
        } else if (data.type === 'text_chunk') {
            lastMessage.type = 'text';
            lastMessage.streaming = true;
            if (!lastMessage.rawContent || lastMessage.rawContent === "Ê≠£Âú®‰∏∫ÊÇ®Â§ÑÁêÜÊó•Á®ã...") {
              lastMessage.rawContent = '';
            }
            // Âú®Â∞ÜÂÜÖÂÆπÊ∑ªÂä†Âà∞rawContent‰πãÂâçËøõË°åËøáÊª§
            const filteredContent = data.content.replace(/\[Data: Sources \(\d+\)\]\.?/g, '');
            lastMessage.rawContent += filteredContent;
            // ÊµÅÂºè‰º†ËæìÊó∂ÔºåÂÆûÊó∂ËøõË°åmarkdownËΩ¨Êç¢
            lastMessage.content = marked.parse(lastMessage.rawContent);
        } else if (data.type === 'final_card') {
            // ‰ªÖÂΩìÊòØÊó•Á®ãÁõ∏ÂÖ≥‰∏îÊúâevent_idÊó∂ÊâçÊòæÁ§∫‰∏∫Âç°Áâá
            if (data.event_id && data.is_schedule === true) {
                lastMessage.type = 'card';
                lastMessage.streaming = false;
                lastMessage.content = marked.parse(data.content || '');
                lastMessage.status = data.status || 'clarification';
                lastMessage.event_id = data.event_id || null;
                
                // Â¶ÇÊûúÊòØÊàêÂäüÂàõÂª∫Êó•Á®ãÔºåËß¶ÂèëÊó•ÂéÜÂà∑Êñ∞
                if (data.status === 'success') {
                    emitter.emit('refreshCalendar');
                }
            } else {
                // ÈùûÊó•Á®ãÁõ∏ÂÖ≥ÊàñÊó†event_idÊó∂‰ª•ÊñáÊú¨ÂΩ¢ÂºèÂ±ïÁ§∫
                lastMessage.type = 'text';
                lastMessage.streaming = false;
                lastMessage.rawContent = data.content || '';
                lastMessage.content = marked.parse(lastMessage.rawContent);
            }
        } else if (data.type === 'error') {
            // Â¶ÇÊûúÊòØÊó•Á®ãÁõ∏ÂÖ≥ÈîôËØØ‰∏îÊòéÁ°ÆÊåáÂÆö‰∫Üis_scheduleÔºåÊâçÊòæÁ§∫‰∏∫Âç°Áâá
            if (data.is_schedule === true) {
                lastMessage.type = 'card';
                lastMessage.streaming = false;
                lastMessage.content = data.content || 'ÂèëÁîüÊú™Áü•ÈîôËØØ„ÄÇ';
                lastMessage.status = 'error';
            } else {
                // ÈùûÊó•Á®ãÈîôËØØ‰ª•ÊñáÊú¨ÂΩ¢ÂºèÂ±ïÁ§∫
                lastMessage.type = 'text';
                lastMessage.streaming = false;
                lastMessage.rawContent = data.content || 'ÂèëÁîüÊú™Áü•ÈîôËØØ„ÄÇ';
                lastMessage.content = marked.parse(lastMessage.rawContent);
            }
        } else if (data.type === 'update_card') {
            // ‰ªÖÊõ¥Êñ∞Êó•Á®ãÂç°Áâá
            if (data.is_schedule === true && data.event_id) {
                // Â§ÑÁêÜÂç°ÁâáÊõ¥Êñ∞
                const targetCard = messages.value.find(msg => 
                    msg.type === 'card' && msg.event_id === data.event_id
                );
                
                if (targetCard) {
                    targetCard.content = marked.parse(data.content || '');
                    targetCard.status = data.status || targetCard.status;
                }
            }
        } else if (data.type === 'session_id') {
            // Â§ÑÁêÜ‰ºöËØùIDÊ∂àÊÅØÔºåÊõ¥Êñ∞ÂΩìÂâçËÅäÂ§©ID
            if (data.chat_id && !chatId.value) {
                chatId.value = data.chat_id;
                fetchChatSessions(); // ÂàõÂª∫Êñ∞‰ºöËØùÂêéÂà∑Êñ∞ÂàóË°®
            }
        }
        scrollToBottom();
    };

    const sendMsg = async () => {
      if (!input.value.trim() && selectedFiles.value.length === 0) {
        ElMessage.warning('ËØ∑ËæìÂÖ•ÂÜÖÂÆπÊàñ‰∏ä‰º†Êñá‰ª∂');
        return;
      }
      
      if (processingFiles.value) {
        ElMessage.warning('Êñá‰ª∂Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÂÄôÂÜçËØï');
        return;
      }
      
      if (currentRequestController.value) {
        currentRequestController.value.abort();
      }
      
      const userMsg = { role: 'user', content: input.value, type: 'text' };
      messages.value.push(userMsg);
      
      if (selectedFiles.value.length > 0) {
        messages.value.push({
          role: 'user',
          content: `‰∏ä‰º†‰∫Ü${selectedFiles.value.length}‰∏™Êñá‰ª∂`,
          type: 'file',
          files: selectedFiles.value.map(f => ({ name: f.name, size: f.size, ext: f.ext }))
        });
      }
      
      const assistantMsg = { role: 'assistant', content: '', type: 'text', streaming: true, source: chatMode.value === 'knowledge_base' ? 'knowledge_base' : 'general_ai' };
      messages.value.push(assistantMsg);
      
      const currentInput = input.value;
      input.value = '';
      
      const currentDocumentIds = selectedFiles.value.map(f => f.documentId).filter(Boolean);
      selectedFiles.value = [];
      
      scrollToBottom();
      loading.value = true;
      
      // Ëé∑ÂèñÁî®Êà∑ÁöÑAI‰∏™ÊÄßÂåñËÆæÁΩÆ
      let aiSettings = null;
      try {
        const aiSettingsResponse = await request({
          url: '/api/settings/ai-settings',
          method: 'get'
        });
        
        if (aiSettingsResponse && aiSettingsResponse.success) {
          aiSettings = aiSettingsResponse.data;
        }
      } catch (error) {
        console.error('Ëé∑ÂèñAI‰∏™ÊÄßÂåñËÆæÁΩÆÂ§±Ë¥•:', error);
        // Âç≥‰ΩøËé∑ÂèñÂ§±Ë¥•‰πüÁªßÁª≠ËÅäÂ§©
      }
      
      const requestData = {
        message: currentInput,
        chat_id: chatId.value,
        document_ids: currentDocumentIds,
        chatMode: chatMode.value,
        method: searchMethod.value // For knowledge base
      };

      // Ê∑ªÂä†AI‰∏™ÊÄßÂåñËÆæÁΩÆ
      if (aiSettings) {
        requestData.ai_settings = aiSettings;
      }

      // Áªü‰∏Ä‰ΩøÁî®ÊµÅÂºèËØ∑Ê±ÇÂ§ÑÁêÜÊâÄÊúâÊ®°Âºè
      currentRequestController.value = aiChatWithDocumentsStream(
        requestData,
        // onChunk callback
        (payload, newChatId) => {
          if (newChatId && !chatId.value) {
            chatId.value = newChatId;
          }
          processBuffer(payload);
        },
        // onComplete callback
        (newChatId) => {
          const lastMsg = messages.value[messages.value.length - 1];
          if (lastMsg && lastMsg.role === 'assistant') {
            lastMsg.streaming = false;
          }
          if (newChatId && !chatId.value) {
            chatId.value = newChatId;
            fetchChatSessions(); // ÂàõÂª∫Êñ∞‰ºöËØùÂêéÂà∑Êñ∞ÂàóË°®
          }
          loading.value = false;
          currentRequestController.value = null;
        },
        // onError callback
        (error) => {
          console.error('ÊµÅÂºèËØ∑Ê±ÇÂá∫Èîô:', error);
          const lastMsg = messages.value[messages.value.length - 1];
          if (lastMsg && lastMsg.role === 'assistant') {
            lastMsg.content = 'Êä±Ê≠âÔºåÂìçÂ∫îÁîüÊàêËøáÁ®ã‰∏≠Âá∫Áé∞ÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ';
            lastMsg.streaming = false;
          }
          loading.value = false;
          currentRequestController.value = null;
          ElMessage.error('ËØ∑Ê±ÇÂá∫Èîô: ' + (error.message || 'Êú™Áü•ÈîôËØØ'));
        }
      );
    }
    
    const triggerFileInput = () => {
      if (fileInput.value) fileInput.value.value = '';
      fileInput.value && fileInput.value.click()
    }
    
    const handleFileUpload = (e) => {
      const files = e.target.files
      if (!files || !files.length) return
      
      // ÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûãÈÖçÁΩÆ
      const allowedTypes = {
        // ÊñáÊ°£Á±ªÂûã
        'text/plain': 'txt',                          // txtÊñá‰ª∂
        'application/pdf': 'pdf',                     // pdfÊñá‰ª∂
        'application/msword': 'doc',                  // docÊñá‰ª∂
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx', // docxÊñá‰ª∂
        'text/markdown': 'md',                        // markdownÊñá‰ª∂
        'text/x-markdown': 'md',                      // markdownÊñá‰ª∂Âèò‰Ωì
        
        // Ë°®Ê†ºÁ±ªÂûã
        'text/csv': 'csv',                            // csvÊñá‰ª∂
        'application/csv': 'csv',                     // csvÊñá‰ª∂Âè¶‰∏ÄÁßçMIME
        'application/vnd.ms-excel': 'xls',            // xlsÊñá‰ª∂
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx', // xlsxÊñá‰ª∂
        
        // ÂõæÁâáÁ±ªÂûã
        'image/jpeg': 'jpg',                          // jpg/jpegÂõæÁâá
        'image/png': 'png',                           // pngÂõæÁâá
        'image/gif': 'gif',                           // gifÂõæÁâá
        'image/bmp': 'bmp',                           // bmpÂõæÁâá
        'image/webp': 'webp',                         // webpÂõæÁâá
        'image/svg+xml': 'svg',                       // svgÁü¢ÈáèÂõæ
        'image/tiff': 'tiff'                          // tiffÂõæÁâá
      };
      
      // ÊòæÁ§∫ÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºèÊèêÁ§∫
      const supportedFormats = 'ÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè: txt, pdf, doc, docx, md, xls, xlsx, csv ÂíåÂ∏∏ËßÅÂõæÁâáÊ†ºÂºè';
      
      // Ê£ÄÊü•ÊØè‰∏™Êñá‰ª∂
      const validFiles = [];
      let hasInvalidFile = false;
      
      // ÊúâÊïàÁöÑÊñá‰ª∂Êâ©Â±ïÂêçÂàóË°®Ôºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâ
      const validExtensions = ['txt', 'pdf', 'doc', 'docx', 'md', 'xls', 'xlsx', 'csv', 
                              'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg', 'tiff'];
      
      Array.from(files).forEach(file => {
        const ext = getExt(file.name).toLowerCase();
        const isValidExtension = validExtensions.includes(ext);
        
        // Ê£ÄÊü•MIMEÁ±ªÂûãÊàñÊâ©Â±ïÂêçÊòØÂê¶ÊúâÊïà
        if (allowedTypes[file.type] || isValidExtension) {
          const id = file.name + '_' + file.size + '_' + Date.now() + Math.random()
          if (file.type.startsWith('image/')) {
            const reader = new FileReader()
            reader.onload = (ev) => {
              selectedFiles.value.push({
                id,
                name: file.name,
                type: file.type,
                url: ev.target.result,
                size: formatSize(file.size),
                ext,
                label: getFileLabel(file.type, ext),
                bg: getFileBg(ext),
                rawFile: file,
                progress: 0,
                status: 'ready'
              })
              // Ëá™Âä®‰∏ä‰º†
              uploadFileAndGetId(selectedFiles.value[selectedFiles.value.length - 1])
            }
            reader.readAsDataURL(file)
          } else {
            selectedFiles.value.push({
              id,
              name: file.name,
              type: file.type,
              url: URL.createObjectURL(file),
              size: formatSize(file.size),
              ext,
              label: getFileLabel(file.type, ext),
              bg: getFileBg(ext),
              rawFile: file, // Áõ¥Êé•‰ΩøÁî®ÂéüÂßãfileÂØπË±°
              progress: 0,
              status: 'ready'
            })
            // Ëá™Âä®‰∏ä‰º†
            uploadFileAndGetId(selectedFiles.value[selectedFiles.value.length - 1])
          }
          validFiles.push(selectedFiles.value[selectedFiles.value.length - 1])
        } else {
          hasInvalidFile = true;
          ElMessage.error(`‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Á±ªÂûã: ${file.name}`);
          console.warn(`Êñá‰ª∂Á±ªÂûãÊãíÁªù: ${file.name}, MIME: ${file.type}, Êâ©Â±ïÂêç: ${ext}`);
        }
      })
      
      // Âú®Êúâ‰∏çÊîØÊåÅÊñá‰ª∂Á±ªÂûãÊó∂ÊòæÁ§∫ÊîØÊåÅÁöÑÊ†ºÂºè‰ø°ÊÅØ
      if (hasInvalidFile) {
        ElMessage.info(supportedFormats);
      }
      
      // Â¶ÇÊûúÂÖ®ÈÉ®Êñá‰ª∂ÈÉΩÊòØÊúâÊïàÁöÑÔºåÊòæÁ§∫ÊàêÂäü‰∏ä‰º†ÊèêÁ§∫
      if (validFiles.length > 0 && validFiles.length === files.length) {
        ElMessage.success(`Â∑≤Ê∑ªÂä†${validFiles.length}‰∏™Êñá‰ª∂`);
      }
    }
    
    const removeFile = (idx) => {
      selectedFiles.value.splice(idx, 1)
    }

    // markedÈÖçÁΩÆÔºöË°®Ê†ºÂ∏¶ËæπÊ°Ü+‰ª£Á†ÅÂùóÁæéÂåñ+Â§çÂà∂ÊåâÈíÆ
    const renderer = new marked.Renderer();
    renderer.table = function(header, body) {
      return `<table class="openwebui-md-table"><thead>${header}</thead><tbody>${body}</tbody></table>`;
    };
    renderer.code = function(code, infostring, escaped) {
      const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
      let lang = (infostring || '').split(/\s+/)[0];
      let langLabel = lang ? lang : 'code';
      let langClass = lang ? `language-${lang}` : '';
      return `
        <div class="openwebui-md-code-block-beauty">
          <div class="openwebui-md-code-toolbar">
            <span class="openwebui-md-code-lang">${langLabel}</span>
            <button class="openwebui-copy-btn" data-clipboard-target="#${codeId}" title="Â§çÂà∂‰ª£Á†Å">Â§çÂà∂</button>
          </div>
          <pre class="openwebui-md-pre"><code id="${codeId}" class="${langClass}">${escaped ? code : escapeHtml(code)}</code></pre>
        </div>
      `;
    };
    
    // Êñ∞Â¢ûÔºöËá™ÂÆö‰πâÊâ©Â±ïÔºåÁ¶ÅÁî®Âà†Èô§Á∫øÂäüËÉΩ
    const disableStrikethrough = {
      walkTokens(token) {
        if (token.type === 'del') {
          // Â∞ÜÂà†Èô§Á∫øÔºàdelÔºâÁ±ªÂûãÁöÑtokenÊîπÂÜô‰∏∫ÊôÆÈÄöÊñáÊú¨ÔºàtextÔºâÁ±ªÂûã
          token.type = 'text';
          token.text = token.raw; // ‰ΩøÁî®ÂéüÂßãÊñáÊú¨Ôºå‰øùÁïô'~~'
          delete token.tokens;
        }
      },
    };

    marked.use(disableStrikethrough);
    
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      mangle: false,
      renderer
    })

    // --- Âç°ÁâáÊ†∑ÂºèËæÖÂä©ÂáΩÊï∞ (Êñ∞Â¢û) ---
    const getCardClass = (status) => {
      switch (status) {
        case 'success':
          return 'success-card';
        case 'error':
          return 'error-card';
        case 'clarification':
          return 'clarification-card';
        case 'deleted':
          return 'deleted-card';
        default:
          return '';
      }
    };
    const getCardIcon = (status) => {
      switch (status) {
        case 'success':
          return 'CircleCheckFilled';
        case 'error':
          return 'CircleCloseFilled';
        case 'clarification':
          return 'InfoFilled';
        case 'deleted':
          return 'WarningFilled';
        default:
          return 'InfoFilled';
      }
    };
    const getCardTitle = (status) => {
      switch (status) {
        case 'success':
          return 'Êó•Á®ãÊìç‰ΩúÊàêÂäü';
        case 'error':
          return 'Êìç‰ΩúÂ§±Ë¥•';
        case 'clarification':
          return 'ÈúÄË¶ÅÁ°ÆËÆ§';
        case 'deleted':
          return 'Êó•Á®ãÂ∑≤Âà†Èô§';
        default:
          return 'ÊèêÁ§∫‰ø°ÊÅØ';
      }
    };
    // ------------------------------------
    
    // ÂØºËà™Âà∞ÂÖ∂‰ªñÊ®°Âùó
    const navigateTo = (path) => {
      // Ëé∑ÂèñÂΩìÂâçË∑ØÁî±Ë∑ØÂæÑ
      const currentPath = window.location.pathname;
      // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÊåáÂÆöË∑ØÂæÑÔºå‰∏çËøõË°åË∑≥ËΩ¨
      if (currentPath.includes(path)) return;
      
      // Âú®Âêå‰∏Ätab‰∏≠ÂØºËà™
      window.location.href = `/${path}`;
    }

    // Ëøô‰∏™ÊñπÊ≥ïÂú®welcome-message‰∏≠‰ΩøÁî®
    const navigateToModule = (path) => {
      navigateTo(path);
    }

    // Âà†Èô§Âçï‰∏™ËÅäÂ§©‰ºöËØù
    const deleteSession = async (sessionId) => {
      try {
        await ElMessageBox.confirm(
          'Á°ÆËÆ§Ë¶ÅÂà†Èô§ËøôÊù°ÂØπËØùËÆ∞ÂΩïÂêóÔºü',
          'ÊèêÁ§∫',
          {
            confirmButtonText: 'Á°ÆËÆ§',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'info',
          }
        );
        
        await deleteAIChatSession(sessionId);
        
        // Âà∑Êñ∞‰ºöËØùÂàóË°®
        await fetchChatSessions();
        
        // Êó†ËÆ∫Âà†Èô§ÁöÑÊòØ‰∏çÊòØÂΩìÂâç‰ºöËØùÔºåÈÉΩÁõ¥Êé•ÂàõÂª∫Êñ∞‰ºöËØù
        clearChat(); // Ê∏ÖÁ©∫ÂΩìÂâç‰ºöËØùÔºåÂàõÂª∫Êñ∞ÂØπËØù
        ElMessage.success('ÂØπËØùÂ∑≤Âà†Èô§ÔºåÂ∑≤ÂàõÂª∫Êñ∞ÂØπËØù');
      } catch (error) {
        if (error !== 'cancel' && error !== 'close') {
          console.error('Âà†Èô§ËÅäÂ§©‰ºöËØùÂ§±Ë¥•:', error);
          ElMessage.error('Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
        }
      }
    }

    // Á°ÆËÆ§Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï
    const confirmClearAllHistory = () => {
      ElMessageBox.confirm(
        'Á°ÆËÆ§Ë¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',
        'Ë≠¶Âëä',
        {
          confirmButtonText: 'Á°ÆËÆ§',
          cancelButtonText: 'ÂèñÊ∂à',
          type: 'warning',
        }
      )
        .then(() => {
          clearAllHistory();
        })
        .catch(() => {
          // Áî®Êà∑ÂèñÊ∂àÔºå‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
        });
    }

    // Ê∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩï
    const clearAllHistory = async () => {
      try {
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        loading.value = true;
        
        for (const session of chatSessions.value) {
          await deleteAIChatSession(session.id);
        }
        
        // Ê∏ÖÁ©∫‰ºöËØùÂàóË°®
        chatSessions.value = [];
        
        // Ê∏ÖÁ©∫ÂΩìÂâç‰ºöËØùÔºåÂàõÂª∫Êñ∞ÂØπËØù
        clearChat();
        
        ElMessage.success('ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫ÔºåÂ∑≤ÂàõÂª∫Êñ∞ÂØπËØù');
      } catch (error) {
        console.error('Ê∏ÖÁ©∫ÂéÜÂè≤ËÆ∞ÂΩïÂ§±Ë¥•:', error);
        ElMessage.error('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï');
      } finally {
        // ÂÖ≥Èó≠Âä†ËΩΩÁä∂ÊÄÅ
        loading.value = false;
      }
    }

    onMounted(() => {
      document.body.addEventListener('click', function(e) {
        if (e.target.classList && e.target.classList.contains('openwebui-copy-btn')) {
          const codeId = e.target.getAttribute('data-clipboard-target').replace('#', '');
          const codeElem = document.getElementById(codeId);
          if (codeElem) {
            navigator.clipboard.writeText(codeElem.innerText).then(() => {
              e.target.innerText = 'Â∑≤Â§çÂà∂';
              setTimeout(() => { e.target.innerText = 'Â§çÂà∂'; }, 1200);
            });
          }
        }
      });
      
      // Ëé∑ÂèñÁî®Êà∑Â§¥ÂÉè
      getUserInfo();
      
      // Ëé∑ÂèñËÅäÂ§©‰ºöËØùÂàóË°®Âπ∂ÂàùÂßãÂåñÁïåÈù¢
      fetchChatSessions().then(() => {
        // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤‰ºöËØùÔºåÁ°Æ‰øùÊòæÁ§∫Êñ∞ÂØπËØùÁïåÈù¢
        if (chatSessions.value.length === 0) {
          clearChat();
        }
      });
      
      // Ê∑ªÂä†È°µÈù¢Âç∏ËΩΩÊó∂ÁöÑÊ∏ÖÁêÜ
      window.addEventListener('beforeunload', () => {
        if (currentRequestController.value) {
          currentRequestController.value.abort();
        }
      });
    });

    // ÁõëÊéßÊó•ÂéÜÂà∑Êñ∞‰∫ã‰ª∂
    emitter.on('refreshCalendar', () => {
      // ÂÅáËÆæÊó•ÂéÜÊúâËá™Â∑±ÁöÑÂà∑Êñ∞ÊñπÊ≥ïÔºåËøôÈáåÊàë‰ª¨Ë∞ÉÁî®ÂÆÉ
      // Â¶ÇÊûúÊó•ÂéÜÁªÑ‰ª∂Êúâref, ÂèØ‰ª•ÊòØ this.$refs.calendar.fetchEvents();
      // ÊàñËÄÖÂ¶ÇÊûúÂà∑Êñ∞ÈÄªËæëÂú®ÂΩìÂâçÁªÑ‰ª∂ÂÜÖÔºåÁõ¥Êé•Ë∞ÉÁî®
      console.log('Êî∂Âà∞Êó•ÂéÜÂà∑Êñ∞‰∫ã‰ª∂ÔºåÊ≠£Âú®ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ...');
      // Á§∫‰æã: findCalendarComponentAndRefresh();
    });

    // --- Êñ∞Â¢ûÔºöÂç°ÁâáÊìç‰ΩúÂáΩÊï∞ ---
    const editEvent = async (msg) => {
      if (!msg || !msg.event_id || msg.is_schedule !== true) {
        ElMessage.error('Êó†ÊïàÁöÑÊó•Á®ã‰ø°ÊÅØÔºåÊó†Ê≥ïÁºñËæë');
        return;
      }
      
      try {
        // Ëé∑Âèñ‰∫ã‰ª∂ËØ¶ÊÉÖ
        const response = await getCalendarEvent(msg.event_id);
        
        if (!response || !response.data) {
          ElMessage.error('Êó†Ê≥ïËé∑ÂèñÊó•Á®ãËØ¶ÊÉÖÔºåËØ∑Á®çÂêéÈáçËØï');
          return;
        }
        
        // ËÆæÁΩÆÁºñËæë‰∫ã‰ª∂Êï∞ÊçÆ
        editingEvent.value = {...response.data};
        currentEditingMessage.value = msg;
        
        // ÊòæÁ§∫ÁºñËæëÂØπËØùÊ°Ü
        editEventDialogVisible.value = true;
      } catch (error) {
        console.error('Ëé∑ÂèñÊó•Á®ãËØ¶ÊÉÖÂá∫Èîô:', error);
        ElMessage.error('Ëé∑ÂèñÊó•Á®ã‰ø°ÊÅØÂ§±Ë¥•: ' + (error.response?.data?.message || error.message || 'Êú™Áü•ÈîôËØØ'));
      }
    };

    // ‰øùÂ≠òÁºñËæëÂêéÁöÑ‰∫ã‰ª∂
    const saveEditEvent = async () => {
      if (!editingEvent.value || !currentEditingMessage.value) {
        ElMessage.error('ÁºñËæëÊï∞ÊçÆÊó†Êïà');
        return;
      }
      
      // ÁÆÄÂçïÈ™åËØÅ
      if (!editingEvent.value.title) {
        ElMessage.warning('ËØ∑ËæìÂÖ•Êó•Á®ãÊ†áÈ¢ò');
        return;
      }
      
      // ÁªÑË£ÖÊõ¥Êñ∞Êï∞ÊçÆ
      const updateData = {
        title: editingEvent.value.title,
        start: editingEvent.value.start,
        end: editingEvent.value.end,
        location: editingEvent.value.location || '',
        description: editingEvent.value.description || '',
        type: editingEvent.value.type,
        reminder: editingEvent.value.reminder || 'none'
      };
      
      try {
        // Ë∞ÉÁî®Êõ¥Êñ∞API
        await updateEvent(editingEvent.value.id, updateData);
        
        // Êõ¥Êñ∞Ê∂àÊÅØÂç°ÁâáÂÜÖÂÆπ
        if (currentEditingMessage.value) {
          const title = editingEvent.value.title;
          const start = formatISODate(editingEvent.value.start);
          const end = formatISODate(editingEvent.value.end);
          const location = editingEvent.value.location;
          
          let content = `Â∑≤ÊàêÂäüÊõ¥Êñ∞Êó•Á®ãÔºö**${title}**\n\n`;
          content += `- **Êó∂Èó¥**: ${start} - ${end}\n`;
          if (location) content += `- **Âú∞ÁÇπ**: ${location}\n`;
          
          currentEditingMessage.value.content = marked.parse(content);
          currentEditingMessage.value.status = 'success';
        }
        
        // Ëß¶ÂèëÊó•ÂéÜÂà∑Êñ∞‰∫ã‰ª∂
        emitter.emit('refreshCalendar');
        
        ElMessage.success('Êó•Á®ãÂ∑≤ÊàêÂäüÊõ¥Êñ∞ÔºÅ');
        
        // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
        editEventDialogVisible.value = false;
      } catch (error) {
        console.error('Êõ¥Êñ∞Êó•Á®ãÂ§±Ë¥•:', error);
        ElMessage.error('Êõ¥Êñ∞Â§±Ë¥•: ' + (error.response?.data?.message || error.message || 'Êú™Áü•ÈîôËØØ'));
      }
    };

    // ‰ªéÂç°Áâá‰∏≠Âà†Èô§Êó•Á®ã
    const deleteEventFromCard = async (eventId) => {
      if (!eventId) {
        ElMessage.error('Êó†Ê≥ïÂà†Èô§ÔºöÁº∫Â∞ë‰∫ã‰ª∂ID');
        return;
      }
      
      try {
        await ElMessageBox.confirm(
          'ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êó•Á®ãÂêóÔºü',
          'ÊèêÁ§∫',
          {
            confirmButtonText: 'Á°ÆËÆ§Âà†Èô§',
            cancelButtonText: 'ÂèñÊ∂à',
            type: 'warning'
          }
        );
        
        // Ë∞ÉÁî®Âà†Èô§API
        await deleteCalendarEvent(eventId);
        
        // ÊâæÂà∞ÂåÖÂê´Ëøô‰∏™‰∫ã‰ª∂IDÁöÑÂç°ÁâáÊ∂àÊÅØ
        const eventMsg = messages.value.find(msg => 
          msg.type === 'card' && msg.event_id === eventId && msg.is_schedule === true
        );
        
        if (eventMsg) {
          // Ëé∑Âèñ‰∫ã‰ª∂Ê†áÈ¢ò
          const titleMatch = eventMsg.content.match(/\*\*([^*]+)\*\*/);
          const eventTitle = titleMatch ? titleMatch[1] : 'ÂºÄ‰ºö';
          
          // Êõ¥Êñ∞Âç°ÁâáÊòæÁ§∫‰∏∫Â∑≤Âà†Èô§Ôºå‰ΩÜ‰ΩøÁî®ÁÆÄÊ¥ÅÁöÑÁ°ÆËÆ§Ê∂àÊÅØ
          eventMsg.status = 'deleted';
          eventMsg.content = `Â•ΩÁöÑÔºåÂêç‰∏∫"${eventTitle}"ÁöÑ‰∫ã‰ª∂Â∑≤ÊàêÂäüÂà†Èô§„ÄÇ`;
        }
        
        // Ëß¶ÂèëÊó•ÂéÜÂà∑Êñ∞‰∫ã‰ª∂
        emitter.emit('refreshCalendar');
        
        ElMessage.success('Êó•Á®ãÂ∑≤Âà†Èô§');
      } catch (error) {
        if (error === 'cancel') return;
        
        if (error.response?.status === 404) {
          ElMessage.error('Êìç‰ΩúÂ§±Ë¥•ÔºöËØ•Êó•Á®ãÂ∑≤Ë¢´Âà†Èô§Êàñ‰∏çÂ≠òÂú®„ÄÇ');
        } else {
          console.error("‰ªéÂç°ÁâáÂà†Èô§Êó•Á®ãÊó∂Âá∫Èîô:", error);
          ElMessage.error('Âà†Èô§Â§±Ë¥•Ôºö' + (error.response?.data?.message || error.message || 'Êú™Áü•ÈîôËØØ'));
        }
      }
    };
    
    // Êõ¥Êñ∞Âç°ÁâáÊòæÁ§∫
    const updateCardDisplay = (msg, title, description) => {
      // ÊûÑÂª∫Êñ∞ÁöÑÂç°ÁâáÂÜÖÂÆπ
      const eventDate = new Date();
      const dateStr = `${eventDate.getFullYear()}Âπ¥${eventDate.getMonth() + 1}Êúà${eventDate.getDate()}Êó•`;
      let content = `Â∑≤ÊàêÂäüÊõ¥Êñ∞Êó•Á®ãÔºö**${title}**\n\n`;
      content += `Êó•ÊúüÔºö${dateStr}\n\n`;
      if (description) {
        content += `ÊèèËø∞Ôºö${description}\n\n`;
      }
      content += `ÊÇ®ÂèØ‰ª•Âú®Êó•ÂéÜ‰∏≠Êü•ÁúãÂÆåÊï¥ËØ¶ÊÉÖ„ÄÇ`;
      
      // Êõ¥Êñ∞Âç°ÁâáÂÜÖÂÆπ
      msg.content = marked.parse(content);
      
      // Á°Æ‰øùÂç°ÁâáÁä∂ÊÄÅ‰∏∫ÊàêÂäü
      msg.status = 'success';
      
      // Âº∫Âà∂ÈáçÊñ∞Ê∏≤ÊüìÂç°Áâá
      nextTick(() => {
        const cardElement = document.querySelector(`.openwebui-card-message[data-event-id="${msg.event_id}"]`);
        if (cardElement) {
          cardElement.classList.remove('clarification-card', 'error-card', 'deleted-card');
          cardElement.classList.add('success-card');
        }
      });
    };
    
    // ‰∏∫Êó•ÊúüÈÄâÊã©Âô®Ê†ºÂºèÂåñÊó•Êúü (‰øùÁïôÊ≠§ÂáΩÊï∞‰ª•ÂÖºÂÆπÂÖ∂‰ªñÂú∞ÊñπÁöÑË∞ÉÁî®)
    const formatDateForPicker = (date) => {
      if (!date) return '';
      
      try {
        // Á°Æ‰øù‰ΩøÁî®ÊúâÊïàÁöÑDateÂØπË±°
        let dateObj;
        if (date instanceof Date) {
          if (isNaN(date.getTime())) {
            console.error('Êó†ÊïàÊó•ÊúüÂØπË±°', date);
            dateObj = new Date(); // ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥‰Ωú‰∏∫ÂõûÈÄÄ
          } else {
            dateObj = date;
          }
        } else {
          // Â∞ùËØïËß£ÊûêÂ≠óÁ¨¶‰∏≤Êó•Êúü
          dateObj = new Date(date);
          if (isNaN(dateObj.getTime())) {
            console.error('Êó†ÊïàÊó•ÊúüÂ≠óÁ¨¶‰∏≤', date);
            dateObj = new Date(); // ‰ΩøÁî®ÂΩìÂâçÊó∂Èó¥‰Ωú‰∏∫ÂõûÈÄÄ
          }
        }
      
        // ‰ΩøÁî®Áõ¥Êé•Ëé∑ÂèñÂπ¥ÊúàÊó•Êó∂ÂàÜÁöÑÊñπÂºèÔºå‰∏çÊ∂âÂèäÊó∂Âå∫ËΩ¨Êç¢
        const year = dateObj.getFullYear();
        const month = (dateObj.getMonth() + 1).toString().padStart(2, '0');
        const day = dateObj.getDate().toString().padStart(2, '0');
        const hours = dateObj.getHours().toString().padStart(2, '0');
        const minutes = dateObj.getMinutes().toString().padStart(2, '0');
        
        const formatted = `${year}-${month}-${day} ${hours}:${minutes}`;
        return formatted;
      } catch (error) {
        console.error('Êó•ÊúüÊ†ºÂºèÂåñÈîôËØØ:', error);
        // ËøîÂõûÂΩìÂâçÊó∂Èó¥‰Ωú‰∏∫ÂõûÈÄÄÈÄâÈ°π
        const now = new Date();
        return `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
      }
    };

    return {
      input, 
      messages, 
      sendMsg, 
      chatBody, 
      fileInput,
      triggerFileInput, 
      handleFileUpload, 
      selectedFiles, 
      removeFile, 
      UploadFilled, 
      Document, 
      Close, 
      Check,
      loading, 
      processingFiles,
      clearChat,
      showContextBar,
      chatId,
      userAvatarUrl,
      handleAvatarError,
      searchMethod,
      chatMode,
      retrievalScope,
      // Âè≥‰æßÈù¢ÊùøÁõ∏ÂÖ≥
      rightPanelCollapsed,
      chatSessions,
      switchChatSession,
      formatTime,
      navigateTo,
      navigateToModule,
      // ÂõæÊ†áÁªÑ‰ª∂
      Calendar, 
      ChatDotRound, 
      Collection, 
      DocumentCopy,
      Grid,
      Connection,
      deleteSession,
      confirmClearAllHistory,
      clearAllHistory,
      getCardClass,
      getCardIcon,
      getCardTitle,
      editEvent,
      deleteEventFromCard,
      editEventDialogVisible,
      editingEvent,
      saveEditEvent,
      // Ê∑ªÂä†Ëøô‰∏§‰∏™ÂáΩÊï∞‰ª•Ëß£ÂÜ≥ESLintË≠¶Âëä
      updateCardDisplay,
      formatDateForPicker,
    }
  }
}
</script>

<style scoped lang="scss">
.dashboard-container {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.openwebui-chat-root {
  width: 100%;
  height: 100%;
  min-height: 0;
  min-width: 0;
  background: var(--bg-color);
  display: flex;
  align-items: stretch;
  justify-content: stretch;
  margin: 0;
  padding: 0;
  overflow: hidden;
}

.openwebui-chat-window {
  width: 100%;
  height: 100%;
  min-height: 0;
  background: var(--bg-color);
  border-radius: 0;
  box-shadow: none;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  margin: 0;
}

.openwebui-chat-header {
  height: 56px;
  background: var(--bg-color-secondary);
  display: flex;
  align-items: center;
  padding: 0 24px;
  font-size: 18px;
  font-weight: 600;
  border-bottom: 1px solid var(--border-color);
  flex-shrink: 0;
  justify-content: space-between;
  color: var(--text-color);
}

.header-center-controls {
  display: flex;
  gap: 16px;
  align-items: center;
}

.openwebui-title {
  color: var(--primary-color);
}

.clear-chat-btn {
  color: var(--text-color-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 14px;
  font-weight: normal;
}

.clear-chat-btn:hover {
  color: var(--primary-color);
}

.openwebui-file-preview-bar {
  width: 100%;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 0 8px 0;
  background: transparent;
  border-bottom: none;
  overflow-x: auto;
  min-height: 64px;
  z-index: 3;
}

.openwebui-file-card {
  display: flex;
  flex-direction: row;
  align-items: center;
  background: var(--bg-color-secondary);
  border-radius: 14px;
  box-shadow: 0 2px 8px rgba(var(--primary-color-rgb),0.04);
  padding: 8px 16px 8px 8px;
  min-width: 160px;
  max-width: 240px;
  position: relative;
  color: var(--text-color);
}

.openwebui-file-thumb {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: var(--bg-color-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  margin-right: 10px;
}

.openwebui-file-img {
  width: 40px;
  height: 40px;
  object-fit: cover;
  border-radius: 8px;
}

.openwebui-file-icon {
  width: 32px;
  height: 32px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 22px;
}

.openwebui-file-info {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.openwebui-file-name {
  font-size: 14px;
  color: var(--text-color);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 120px;
}

.openwebui-file-meta {
  font-size: 12px;
  color: var(--text-color-secondary);
  margin-top: 2px;
}

.openwebui-file-progress {
  margin-top: 4px;
  width: 100%;
}

.openwebui-file-status.completed {
  color: var(--success-color);
}

.openwebui-file-remove {
  position: absolute;
  top: 4px;
  right: 4px;
  color: var(--text-color-tertiary);
  font-size: 16px;
  cursor: pointer;
  transition: color 0.2s;
}

.openwebui-file-remove:hover {
  color: var(--error-color);
}

.openwebui-chat-container {
  display: flex;
  flex: 1;
  overflow: hidden;
  position: relative;
}

.openwebui-chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 0 16px 12px 16px;
  background: var(--bg-color);
  display: flex;
  flex-direction: column;
  min-height: 0;
  max-height: calc(100vh - 200px);
  height: calc(100vh - 200px);
  flex-shrink: 1;
  scrollbar-width: thin;
  width: auto;
  transition: all 0.3s ease;
}

.openwebui-msg {
  display: flex;
  align-items: flex-end;
  margin-bottom: 16px;
  flex-direction: row;
  justify-content: flex-start;
}

.openwebui-msg.user {
  flex-direction: row-reverse;
  justify-content: flex-end;
  align-items: flex-end;
  margin-left: auto;
  margin-right: 0;
}

.openwebui-msg.assistant {
  flex-direction: row;
  justify-content: flex-start;
  align-items: flex-end;
  margin-right: auto;
  margin-left: 0;
}

.openwebui-msg-bubble {
  position: relative;
  max-width: 90%;
  padding: 12px 18px;
  border-radius: 20px;
  word-wrap: break-word;
  overflow-wrap: break-word;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  line-height: 1.6;
}

.openwebui-msg.user .openwebui-msg-bubble {
  background: var(--primary-color);
  color: #fff;
  border-bottom-right-radius: 4px;
  margin-right: 8px;
  margin-left: auto;
}

.openwebui-msg.assistant .openwebui-msg-bubble {
  background: var(--bg-color-secondary);
  color: var(--text-color);
  border-bottom-left-radius: 4px;
  margin-left: 8px;
  margin-right: auto;
}

.openwebui-avatar {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  margin-bottom: auto;
}

.left-avatar {
  margin-right: 8px;
}

.right-avatar {
  margin-left: 8px;
}

.user-avatar-img {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  overflow: hidden;
  display: block;
  background-color: #f0f2f5;
}

.openwebui-user-label {
  font-weight: bold;
  margin-right: 4px;
}

.openwebui-ai-label {
  font-weight: bold;
  color: #2f54eb;
  margin-right: 4px;
}

.openwebui-chat-footer {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  padding: 0 16px 12px 16px;
  background: var(--bg-color);
  border-top: 1px solid var(--border-color);
  margin: 0;
  flex-shrink: 0;
  box-shadow: 0 -2px 16px 0 rgba(var(--primary-color-rgb),0.03);
  z-index: 2;
}

.openwebui-input-area {
  display: flex;
  align-items: center;
  width: 100%;
}

.openwebui-input {
  flex: 1;
  margin-right: 12px;
  height: 40px;
  display: flex;
  align-items: center;
}

.openwebui-send-btn {
  min-width: 72px;
  height: 40px;
  font-size: 16px;
  font-weight: 500;
  border-radius: 8px;
}

.openwebui-upload-btn {
  margin-right: 8px;
  font-size: 20px;
  background: var(--bg-color-tertiary);
  border: 1px solid var(--border-color);
  color: var(--primary-color);
  cursor: pointer;
  border-radius: 8px;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: border 0.2s, box-shadow 0.2s;
}

.openwebui-upload-btn:hover {
  border: 1.5px solid var(--primary-color);
  box-shadow: 0 2px 8px rgba(var(--primary-color-rgb),0.08);
}

.openwebui-img-preview {
  max-width: 180px;
  max-height: 120px;
  border-radius: 8px;
  display: block;
  margin: 4px 0;
  box-shadow: 0 2px 8px rgba(47,84,235,0.08);
}

.openwebui-file-link {
  color: var(--primary-color);
  text-decoration: underline;
  word-break: break-all;
}

.openwebui-cursor {
  display: inline-block;
  width: 8px;
  height: 16px;
  background: var(--primary-color);
  margin-left: 2px;
  vertical-align: middle;
  animation: blink 0.8s infinite;
}

@keyframes blink {
  0% { opacity: 1; }
  50% { opacity: 0; }
  100% { opacity: 1; }
}

.file-bubble-nest {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
}

.file-bubble-vertical {
  justify-content: flex-start;
  align-items: flex-start;
}

.file-message-card {
  display: flex;
  align-items: center;
  background: var(--bg-color-secondary);
  border-radius: 12px;
  padding: 8px 16px;
  margin-bottom: 0;
  min-width: 180px;
  max-width: 320px;
  box-shadow: 0 2px 8px rgba(var(--primary-color-rgb),0.04);
  color: var(--text-color);
}

.file-icon-area {
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
}

.file-icon-img {
  width: 32px;
  height: 32px;
}

.file-info-area {
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.file-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-color);
  margin-bottom: 2px;
  word-break: break-all;
}

.file-meta {
  font-size: 12px;
  color: var(--text-color-secondary);
}

.file-desc-text {
  margin-top: 8px;
  font-size: 15px;
  color: var(--text-color);
  background: transparent;
  border-radius: 8px;
  padding: 0 2px;
  display: inline-block;
  word-break: break-all;
}

.openwebui-context-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 24px;
  background-color: var(--bg-color-tertiary);
  border-bottom: 1px solid var(--border-color);
  font-size: 14px;
  color: var(--text-color-secondary);
}

.context-info {
  display: flex;
  align-items: center;
  gap: 6px;
}

.context-icon {
  color: var(--primary-color);
  font-size: 16px;
}

.source-tag {
  font-size: 10px;
  color: #888;
  margin-top: 8px;
  display: inline-flex;
  align-items: center;
  padding: 2px 6px;
  border-radius: 4px;
  .el-icon {
    margin-right: 4px;
  }
}

.knowledge-base-tag {
  background-color: #e8f5e9; /* Light green */
  color: #2e7d32;
}

.general-ai-tag {
  background-color: #e3f2fd; /* Light blue */
  color: #1565c0;
}

/* Âè≥‰æßÈù¢ÊùøÊ†∑Âºè */
.openwebui-right-panel {
  width: 320px;
  height: 100%;
  background: var(--el-bg-color-page);
  border-left: 1px solid var(--el-border-color);
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
  overflow: hidden;
}

.openwebui-right-panel.collapsed {
  width: 50px;
}

.right-panel-header {
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid var(--el-border-color);
  background-color: var(--el-bg-color);
}

.right-panel-mode-controls {
  flex: 1;
  display: flex;
  justify-content: center;
  overflow: hidden;
  transition: opacity 0.3s;
}

.collapsed .right-panel-mode-controls {
  opacity: 0;
  width: 0;
  pointer-events: none;
}

.collapse-button {
  margin-left: 8px;
  background-color: var(--bg-color);
  border: 1px solid var(--border-color);
  color: var(--text-color);
  transition: all 0.2s ease;
}

.collapse-button:hover {
  border-color: var(--primary-color);
  color: var(--primary-color);
  transform: scale(1.1);
  box-shadow: 0 0 8px rgba(var(--primary-color-rgb), 0.2);
}

.collapsed .collapse-button {
  margin-left: 0;
}

.history-container {
  flex: 1;
  overflow-y: auto;
  padding: 0 16px 16px;
  display: flex;
  flex-direction: column;
  min-height: 0;
  background-color: var(--el-bg-color-page);
}

.history-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding: 16px 0 8px;
  border-bottom: none;
}

.history-title {
  font-size: 15px;
  margin: 0;
  color: var(--el-text-color-regular);
  transition: opacity 0.2s;
  line-height: 1.2;
  font-weight: 500;
}

.clear-all-btn {
  padding: 4px 12px;
  font-size: 12px;
  color: var(--el-text-color-secondary);
  display: flex;
  align-items: center;
  gap: 4px;
  border-radius: 4px;
}

.clear-all-btn:hover {
  background-color: var(--el-color-danger-light-9);
  color: var(--el-color-danger);
}

.history-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 0 4px;
}

.history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  border-radius: 18px;
  background: var(--el-bg-color);
  cursor: pointer;
  transition: all 0.2s ease;
  overflow: hidden;
  margin-bottom: 8px;
  border: 1px solid var(--el-border-color-lighter);
  box-shadow: none;
}

.history-item:hover {
  background: var(--el-bg-color-page);
  border-color: var(--el-border-color);
  box-shadow: var(--el-box-shadow-light);
}

.history-item.active {
  background: var(--el-color-primary);
  color: white;
  border-color: var(--el-color-primary);
}

.history-item-content {
  display: flex;
  align-items: center;
  flex: 1;
  overflow: hidden;
  min-width: 0;
}

.history-item-icon {
  min-width: 28px;
  height: 28px;
  border-radius: 50%;
  background-color: var(--el-color-primary-light-9);
  margin-right: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--el-color-primary);
  font-size: 14px;
}

.history-item.active .history-item-icon {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.history-item-info {
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

.history-item-title {
  font-size: 14.5px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
  color: var(--el-text-color-primary);
}

.history-item-time {
  font-size: 12px;
  color: var(--el-text-color-secondary);
}

.history-item.active .history-item-time {
  color: rgba(255, 255, 255, 0.8);
}

.history-item-actions {
  opacity: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
}

.delete-btn-wrapper {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background-color: rgba(245, 108, 108, 0.08);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  cursor: pointer;
  border: none;
}

.delete-btn-wrapper:hover {
  background-color: rgba(245, 108, 108, 0.15);
}

.delete-icon {
  font-size: 17px;
  color: var(--el-color-danger);
  transition: all 0.2s ease;
}

.history-empty {
  text-align: center;
  padding: 30px 0;
  color: var(--el-text-color-secondary);
  font-size: 14px;
  font-style: normal;
}

.collapsed .history-item {
  justify-content: center;
  padding: 10px 0;
}

.collapsed .history-item-icon {
  margin-right: 0;
}

.collapsed .history-item-info,
.collapsed .history-item-actions {
  display: none;
}

.collapsed .history-title {
  opacity: 0;
  height: 0;
  margin: 0;
  padding: 0;
}

.collapsed .history-container {
  display: none;
}

.collapsed .right-panel-header {
  justify-content: center;
  padding-left: 0;
  padding-right: 0;
  border-bottom-color: transparent;
}

/* Êñ∞Â¢ûÂç°ÁâáÊ∂àÊÅØÊ†∑Âºè */
.openwebui-card-message {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 8px; /* ÂáèÂ∞èÂÜÖËæπË∑ùÔºåËÆ©Âç°ÁâáÊõ¥Á¥ßÂáë */
  width: 100%; /* Á°Æ‰øùÂç°ÁâáÂ°´Êª°Ê∞îÊ≥° */
}

.card-icon-wrapper {
  font-size: 24px;
  margin-top: 2px;
}

.card-content-wrapper {
  flex: 1;
  text-align: left;
}

.card-title {
  font-weight: bold;
  font-size: 16px;
  margin-bottom: 4px;
}

.card-body {
  font-size: 14px;
  line-height: 1.5;
  // Á°Æ‰øùÊç¢Ë°åÁ¨¶ÁîüÊïà
  white-space: pre-wrap;
  :deep(p) {
    margin: 0;
  }
}

/* Êñ∞Â¢ûÔºöÂç°ÁâáÊìç‰ΩúÂå∫ÂüüÊ†∑Âºè */
.card-actions {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px solid var(--border-color);
  display: flex;
  justify-content: flex-end;
  gap: 8px;
}

/* Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆ‰∏çÂêåÈ¢úËâ≤ */
.success-card .card-icon-wrapper {
  color: #67c23a; /* Element Plus ÊàêÂäüËâ≤ */
}
.success-card .card-title {
  color: #67c23a;
}
.openwebui-msg.assistant .openwebui-msg-bubble .success-card {
  border-left: 4px solid #67c23a;
}

.clarification-card .card-icon-wrapper {
  color: #e6a23c; /* Element Plus Ë≠¶ÂëäËâ≤ */
}
.clarification-card .card-title {
  color: #e6a23c;
}
.openwebui-msg.assistant .openwebui-msg-bubble .clarification-card {
  border-left: 4px solid #e6a23c;
}

.error-card .card-icon-wrapper {
  color: #f56c6c; /* Element Plus Âç±Èô©Ëâ≤ */
}
.error-card .card-title {
  color: #f56c6c;
}
.openwebui-msg.assistant .openwebui-msg-bubble .error-card {
  border-left: 4px solid #f56c6c;
}

.deleted-card .card-icon-wrapper {
  color: #909399; /* Element Plus ÁÅ∞Ëâ≤ */
}
.deleted-card .card-title {
  color: #909399;
}
.openwebui-msg.assistant .openwebui-msg-bubble .deleted-card {
  border-left: 4px solid #909399;
}
</style>

<style>
.openwebui-md-table {
  width: 100%;
  border-collapse: collapse;
  margin: 8px 0;
  background: var(--bg-color-secondary);
  font-size: 15px;
}
.openwebui-md-table th, .openwebui-md-table td {
  border: 1px solid var(--border-color);
  padding: 6px 12px;
  text-align: left;
  color: var(--text-color);
  background: var(--bg-color-secondary);
}
.openwebui-md-table th {
  background: var(--bg-color-tertiary);
  font-weight: 600;
  color: var(--text-color-secondary);
}
/* ‰ª£Á†ÅÂùóÁæéÂåñÂíåÂ§çÂà∂ÊåâÈíÆ */
.openwebui-md-code-block-beauty {
  position: relative;
  background: var(--bg-color-tertiary);
  border-radius: 12px;
  margin: 18px 0;
  box-shadow: 0 4px 16px var(--shadow-color);
  overflow: hidden;
  border: 1px solid var(--border-color);
}
.openwebui-md-code-toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: var(--bg-color-secondary);
  border-bottom: 1px solid var(--border-color);
  height: 36px;
  padding: 0 14px;
}
.openwebui-md-code-lang {
  font-size: 13px;
  color: var(--text-color-tertiary);
  font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
  user-select: none;
}
.openwebui-copy-btn {
  background: var(--bg-color-tertiary);
  border: 1px solid var(--border-color);
  color: var(--primary-color);
  border-radius: 6px;
  font-size: 13px;
  padding: 2px 12px;
  cursor: pointer;
  z-index: 2;
  transition: background 0.2s, border 0.2s, color 0.2s;
  outline: none;
  margin-left: 8px;
}
.openwebui-copy-btn:hover {
  background: var(--primary-color);
  color: #fff;
  border: 1px solid var(--primary-color);
}
.openwebui-md-pre {
  margin: 0;
  padding: 16px 18px;
  background: var(--bg-color-tertiary);
  border-radius: 0 0 12px 12px;
  overflow-x: auto;
  font-family: 'JetBrains Mono', 'Fira Mono', 'Consolas', monospace;
  font-size: 15px;
  line-height: 1.7;
  color: var(--text-color);
  min-height: 40px;
}
@media (max-width: 600px) {
  .openwebui-md-pre {
    font-size: 13px;
    padding: 12px 6px;
  }
  .openwebui-md-code-block-beauty {
    margin: 12px 0;
  }
}
</style>

<style>
.openwebui-footer-hint {
  font-size: 12px;
  color: var(--text-color-secondary);
  text-align: center;
  padding-top: 8px;
  user-select: none;
  width: 100%;
}
</style>

<style>
.openwebui-upload-tooltip {
  max-width: 300px !important;
  background: var(--bg-color-secondary) !important;
  color: var(--text-color) !important;
  border: 1px solid var(--primary-color) !important;
  border-radius: 8px !important;
  box-shadow: 0 4px 12px rgba(var(--primary-color-rgb), 0.2) !important;
  padding: 10px 14px !important;
  font-size: 13px !important;
  line-height: 1.6 !important;
  white-space: pre-wrap; /* For newline in content */
}

.openwebui-upload-tooltip .el-popper__arrow::before {
  border-color: var(--primary-color) !important;
  background: var(--bg-color-secondary) !important;
}
</style>

<style lang="scss" scoped>
.openwebui-options-area {
  display: flex;
  justify-content: center;
  padding-top: 8px;
}
</style>

<style>
/* ÂØºËà™Âç°ÁâáÊ†∑Âºè */
.welcome-message {
  margin-bottom: 24px;
  padding: 8px;
  border-radius: 12px;
  background-color: var(--el-bg-color);
}

.welcome-message h3 {
  margin-bottom: 12px;
  font-size: 22px;
  font-weight: 600;
  color: var(--el-text-color-primary);
  text-align: center;
}

.platform-intro {
  background-color: var(--el-bg-color-page);
  border-radius: 8px;
  padding: 12px 16px;
  margin-bottom: 18px;
  border-left: 4px solid var(--el-color-primary);
}

.platform-intro p {
  margin: 0;
  color: var(--el-text-color-regular);
  font-size: 14.5px;
  line-height: 1.6;
  text-align: left;
}

.welcome-message p {
  margin-bottom: 22px;
  color: var(--el-text-color-regular);
  font-size: 15px;
  text-align: center;
}

.quick-nav-cards {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-top: 15px;
}

.nav-card {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 16px;
  background-color: var(--el-bg-color-overlay);
  border-radius: 12px;
  border: 1px solid var(--el-border-color-lighter);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  box-shadow: var(--el-box-shadow-lighter);
  position: relative;
  overflow: hidden;
}

.nav-card:hover {
  background-color: var(--el-color-primary-light-9);
  border-color: var(--el-color-primary-light-5);
  transform: translateY(-3px);
  box-shadow: var(--el-box-shadow-light);
}

body[data-theme="dark"] .nav-card:hover {
  background-color: var(--el-color-primary-dark-2);
}

.nav-card:hover .nav-card-arrow {
  opacity: 1;
  transform: translateX(0);
}

.nav-card-icon {
  display: flex;
  justify-content: center;
  align-items: center;
  min-width: 46px;
  height: 46px;
  font-size: 22px;
  margin-right: 12px;
  color: #ffffff;
  background-color: var(--el-color-primary);
  border-radius: 10px;
  box-shadow: 0 2px 6px rgba(64, 158, 255, 0.25);
  transition: all 0.3s ease;
}

.nav-card:hover .nav-card-icon {
  transform: scale(1.1);
}

.nav-card-icon .el-icon,
.nav-card-icon .bi {
  font-size: 22px;
}

.nav-card:nth-child(2) .nav-card-icon {
  background-color: #67C23A;
  box-shadow: 0 2px 6px rgba(103, 194, 58, 0.25);
}

.nav-card:nth-child(3) .nav-card-icon {
  background-color: #E6A23C;
  box-shadow: 0 2px 6px rgba(230, 162, 60, 0.25);
}

.nav-card:nth-child(4) .nav-card-icon {
  background-color: #F56C6C;
  box-shadow: 0 2px 6px rgba(245, 108, 108, 0.25);
}

.nav-card:nth-child(5) .nav-card-icon {
  background-color: #909399;
  box-shadow: 0 2px 6px rgba(144, 147, 153, 0.25);
}

.nav-card:nth-child(6) .nav-card-icon {
  background-color: #9c27b0;
  box-shadow: 0 2px 6px rgba(156, 39, 176, 0.25);
}

.nav-card-content {
  flex: 1;
}

.nav-card-title {
  font-weight: 600;
  font-size: 15px;
  margin-bottom: 4px;
  color: var(--el-text-color-primary);
}

.nav-card-desc {
  font-size: 12px;
  color: var(--el-text-color-secondary);
  line-height: 1.4;
}

.nav-card-arrow {
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transform: translateX(10px);
  transition: all 0.3s ease;
  color: var(--el-color-primary);
  font-weight: bold;
  font-size: 18px;
  margin-left: 5px;
}

.nav-arrow-icon {
  font-style: normal;
}

/* ÂìçÂ∫îÂºèÂ∏ÉÂ±Ä */
@media (max-width: 768px) {
  .quick-nav-cards {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  
  .nav-card {
    padding: 12px;
    flex-direction: column;
    text-align: center;
  }
  
  .nav-card-icon {
    margin-right: 0;
    margin-bottom: 10px;
    width: 42px;
    height: 42px;
  }
  
  .nav-card-title {
    margin-bottom: 4px;
  }
  
  .nav-card-arrow {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  .welcome-message h3 {
    font-size: 18px;
  }
  
  .welcome-message p {
    font-size: 14px;
    margin-bottom: 16px;
  }
  
  .quick-nav-cards {
    grid-template-columns: 1fr;
    gap: 10px;
  }
  
  .nav-card {
    flex-direction: row;
    text-align: left;
    padding: 12px;
  }
  
  .nav-card-icon {
    margin-right: 12px;
    margin-bottom: 0;
  }
}

/* Êõ¥Êñ∞Âπ≥Âè∞‰ªãÁªçÊ†∑Âºè */
.platform-intro {
  background-color: var(--el-bg-color-page);
  border-radius: 12px;
  padding: 16px 20px;
  margin-bottom: 22px;
  border-left: 4px solid var(--el-color-primary);
  box-shadow: var(--el-box-shadow-lighter);
}

.platform-intro p {
  margin: 0 0 12px;
  color: var(--el-text-color-regular);
  font-size: 14.5px;
  line-height: 1.6;
}

.platform-intro p:last-child {
  margin-bottom: 0;
  font-style: italic;
  color: #606266;
}

.platform-features {
  padding-left: 18px;
  margin: 12px 0 14px;
  list-style-type: none;
}

.platform-features li {
  position: relative;
  padding-left: 8px;
  margin-bottom: 10px;
  font-size: 14px;
  color: #454b54;
  line-height: 1.5;
}

.platform-features li::before {
  content: "‚Ä¢";
  position: absolute;
  left: -12px;
  color: #409EFF;
  font-weight: bold;
}

.feature-highlight {
  font-weight: 600;
  color: #303133;
}

/* ‰øÆÊîπ‰∏Ä‰∏ãwelcome-messageÊ†∑Âºè */
.welcome-message h3 {
  margin-bottom: 16px;
  font-size: 22px;
  font-weight: 600;
  color: #303133;
  text-align: center;
}

.welcome-message > p {
  margin-bottom: 22px;
  color: #606266;
  font-size: 15px;
  text-align: center;
}
</style> 

<!-- Ê∑ªÂä†‰∫ã‰ª∂ÁºñËæëË°®ÂçïÊ†∑Âºè -->
<style>
.event-edit-dialog .el-message-box__input {
  padding: 0;
}

.event-edit-dialog .el-message-box__input input {
  display: none;
}

.event-edit-form {
  padding: 10px 0;
}

.event-edit-form .form-group {
  margin-bottom: 15px;
}

.event-edit-form label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: var(--text-color);
}

.event-edit-form .form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background-color: var(--bg-color);
  color: var(--text-color);
  font-size: 14px;
  transition: border-color 0.2s;
}

.event-edit-form .form-control:focus {
  border-color: var(--primary-color);
  outline: none;
}

.event-edit-form textarea.form-control {
  min-height: 80px;
  resize: vertical;
}

.event-edit-form select.form-control {
  appearance: auto;
  height: 38px;
  background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
  background-position: right 0.5rem center;
  background-repeat: no-repeat;
  background-size: 1.5em 1.5em;
  padding-right: 2.5rem;
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}

/* Â¢ûÂä†ÂØπËØùÊ°ÜÂÆΩÂ∫¶ */
.event-edit-dialog .el-message-box {
  width: 400px;
  max-width: 95vw;
}

/* ÊöóËâ≤‰∏ªÈ¢òÈÄÇÈÖç */
body[data-theme="dark"] .event-edit-form .form-control {
  background-color: var(--bg-color-secondary);
  border-color: var(--border-color);
  color: var(--text-color);
}

body[data-theme="dark"] .event-edit-form label {
  color: var(--text-color-secondary);
}

/* ‰øÆÂ§çdatetime-localËæìÂÖ•Ê°ÜÊ†∑Âºè */
.event-edit-form input[type="datetime-local"] {
  padding-right: 0.75rem;
}

/* Á°Æ‰øùË°®ÂçïÂú®‰∏çÂêåÊµèËßàÂô®‰∏≠Ê≠£Â∏∏ÊòæÁ§∫ */
@supports (-moz-appearance: none) {
  .event-edit-form select.form-control {
    padding-right: 2rem;
    background-image: none;
  }
}
</style>

<style lang="scss" scoped>
// ... existing code ...

/* Âç°ÁâáÊ∂àÊÅØÊ†∑Âºè */
.openwebui-card-message {
  padding: 12px;
  border-radius: 8px;
  background-color: var(--bg-color-secondary);
  display: flex;
  align-items: flex-start;
  margin-bottom: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.openwebui-card-message:hover {
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.card-icon-wrapper {
  margin-right: 12px;
  font-size: 20px;
  padding-top: 2px;
}

.card-content-wrapper {
  flex: 1;
}

.card-title {
  font-size: 16px;
  font-weight: 500;
  margin-bottom: 8px;
}

.card-body {
  font-size: 14px;
  color: var(--text-color);
  line-height: 1.5;
}

.card-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
}

/* Ê†πÊçÆÁä∂ÊÄÅËÆæÁΩÆ‰∏çÂêåÈ¢úËâ≤ */
.success-card .card-icon-wrapper {
  color: #67c23a; /* Element Plus ÊàêÂäüËâ≤ */
}
.success-card .card-title {
  color: #67c23a;
}
.openwebui-msg.assistant .openwebui-msg-bubble .success-card {
  border-left: 4px solid #67c23a;
}

.clarification-card .card-icon-wrapper {
  color: #e6a23c; /* Element Plus Ë≠¶ÂëäËâ≤ */
}
.clarification-card .card-title {
  color: #e6a23c;
}
.openwebui-msg.assistant .openwebui-msg-bubble .clarification-card {
  border-left: 4px solid #e6a23c;
}

.error-card .card-icon-wrapper {
  color: #f56c6c; /* Element Plus Âç±Èô©Ëâ≤ */
}
.error-card .card-title {
  color: #f56c6c;
}
.openwebui-msg.assistant .openwebui-msg-bubble .error-card {
  border-left: 4px solid #f56c6c;
}

.deleted-card .card-icon-wrapper {
  color: #909399; /* Element Plus ÁÅ∞Ëâ≤ */
}
.deleted-card .card-title {
  color: #909399;
}
.openwebui-msg.assistant .openwebui-msg-bubble .deleted-card {
  border-left: 4px solid #909399;
}
</style>

<!-- Ê∑ªÂä†‰∫ã‰ª∂ÁºñËæëË°®ÂçïÊ†∑Âºè -->
<style>
.event-edit-dialog .el-message-box__input {
  padding: 0;
}

.event-edit-dialog .el-message-box__input input {
  display: none;
}

.event-edit-form {
  padding: 10px 0;
}

.event-edit-form .form-group {
  margin-bottom: 15px;
}

.event-edit-form label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: var(--text-color);
}

.event-edit-form .form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  background-color: var(--bg-color);
  color: var(--text-color);
  font-size: 14px;
  transition: border-color 0.2s;
}

.event-edit-form .form-control:focus {
  border-color: var(--primary-color);
  outline: none;
}

.event-edit-form textarea.form-control {
  min-height: 80px;
  resize: vertical;
}

.event-edit-form select.form-control {
  appearance: auto;
}
</style>

<style>
/* Á°Æ‰øù el-dialog Âú®ÊöóÈªëÊ®°Âºè‰∏ãÊ†∑ÂºèÊ≠£Á°Æ */
.calendar-dialog .el-dialog {
  background-color: var(--bg-color);
}
.calendar-dialog .el-dialog__title {
  color: var(--text-color);
}
.calendar-dialog .el-dialog__header {
  border-bottom: 1px solid var(--border-color);
}
.calendar-dialog .el-dialog__body {
  background-color: var(--bg-color);
  color: var(--text-color);
}
.calendar-dialog .el-dialog__footer {
  border-top: 1px solid var(--border-color);
}
.calendar-dialog .el-form-item__label {
  color: var(--text-color);
}
.calendar-dialog .el-input__wrapper,
.calendar-dialog .el-textarea__inner {
  background-color: var(--bg-color-secondary) !important;
  box-shadow: none !important;
  border: 1px solid var(--border-color);
  color: var(--text-color);
}
.calendar-dialog .el-input__inner {
  color: var(--text-color) !important;
}

/* ÁßªÈô§ÊóßÁöÑ„ÄÅ‰∏çÂÜçÈúÄË¶ÅÁöÑCSS */
.event-edit-dialog .el-message-box__input {
  display: none;
}
.event-edit-form {
  display: none;
}
</style>